flectra.define('website_slides_survey.upload_modal',function(require){
"usestrict";

varcore=require('web.core');
var_t=core._t;
varsessionStorage=window.sessionStorage;
varSlidesUpload=require('website_slides.upload_modal');

/**
 *Managementofthenew'certification'slide_type
 */
SlidesUpload.SlideUploadDialog.include({
    events:_.extend({},SlidesUpload.SlideUploadDialog.prototype.events||{},{
        'changeinput#certification_id':'_onChangeCertification'
    }),

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

   /**
    *Willautomaticallysetthetitleoftheslidetothetitleofthechosencertification
    */
    _onChangeCertification:function(ev){
        if(ev.added&&ev.added.text){
            this.$("input#name").val(ev.added.text);
        }
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *Overriddentoaddthe"certification"slidetype
     *
     *@override
     *@private
     */
    _setup:function(){
        this._super.apply(this,arguments);
        this.slide_type_data['certification']={
            icon:'fa-trophy',
            label:_t('Certification'),
            template:'website.slide.upload.modal.certification',
        };
    },
    /**
     *Overriddentoaddcertificationsmanagementinselect2
     *
     *@override
     *@private
     */
    _bindSelect2Dropdown:function(){
        this._super.apply(this,arguments);

        varself=this;
        this.$('#certification_id').select2(this._select2Wrapper(_t('Certification'),false,
            function(){
                returnself._rpc({
                    route:'/slides_survey/certification/search_read',
                    params:{
                        fields:['title'],
                    }
                });
            },'title')
        );
    },
    /**
     *Theselect2fieldmakesthe"required"inputhiddenontheinterface.
     *Weneedtomakethe"certification"fieldrequiredsoweoverridethismethod
     *tohandlevalidationinafullycustomway.
     *
     *@override
     *@private
     */
    _formValidate:function(){
        varresult=this._super.apply(this,arguments);

        var$certificationInput=this.$('#certification_id');
        if($certificationInput.length!==0){
            var$select2Container=$certificationInput
                .closest('.form-group')
                .find('.select2-container');
            $select2Container.removeClass('is-invalidis-valid');
            if($certificationInput.is(':invalid')){
                $select2Container.addClass('is-invalid');
            }elseif($certificationInput.is(':valid')){
                $select2Container.addClass('is-valid');
            }
        }

        returnresult;
    },
    /**
     *Overriddentoaddthe'certification'fieldintothesubmittedvalues
     *
     *@override
     *@private
     */
    _getSelect2DropdownValues:function(){
        varresult=this._super.apply(this,arguments);

        varcertificateValue=this.$('#certification_id').select2('data');
        varsurvey={};
        if(certificateValue){
            if(certificateValue.create){
                survey.id=false;
                survey.title=certificateValue.text;
            }else{
                survey.id=certificateValue.id;
            }
        }
        result['survey']=survey;
        returnresult;
    },

    /**
     *Overriddetohandlecertificationcreatedon-the-fly:toasterwillhold
     *surveyediturl,needtoputitinsessiontouseitinCertificationUploadToast
     *
     *@override
     *@private
     */
    _onFormSubmitDone:function(data){
        if(!data.error&&data.redirect_to_certification){
            sessionStorage.setItem("survey_certification_url",data.redirect_url);
            window.location.reload();
        }else{
            this._super.apply(this,arguments);
        }
    },
});

SlidesUpload.websiteSlidesUpload.include({
    xmlDependencies:(SlidesUpload.websiteSlidesUpload.prototype.xmlDependencies||[]).concat(
        ["/website_slides_survey/static/src/xml/website_slide_upload.xml"]
    ),
});

});
