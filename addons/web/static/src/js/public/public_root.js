flectra.define('web.public.root',function(require){
'usestrict';

varajax=require('web.ajax');
vardom=require('web.dom');
constenv=require('web.public_env');
varsession=require('web.session');
varutils=require('web.utils');
varpublicWidget=require('web.public.widget');

varpublicRootRegistry=newpublicWidget.RootWidgetRegistry();

//LoadlocalizationsoutsidethePublicRoottonotwaitforDOMready(but
//waitfortheminPublicRoot)
functiongetLang(){
    varhtml=document.documentElement;
    return(html.getAttribute('lang')||'en_US').replace('-','_');
}
varlang=utils.get_cookie('frontend_lang')||getLang();//FIXMEthecookievalueshouldmaybebeinthectx?
varlocaleDef=ajax.loadJS('/web/webclient/locale/'+lang.replace('-','_'));

/**
 *Elementwhichisdesignedtobeuniqueandthatwillbethetop-mostelement
 *inthewidgethierarchy.So,allotherwidgetswillbeindirectlylinkedto
 *thisClassinstance.ItsmainrolewillbetoretrieveRPCdemandsfromits
 *childrenandhandlethem.
 */
varPublicRoot=publicWidget.RootWidget.extend({
    events:_.extend({},publicWidget.RootWidget.prototype.events||{},{
        'submit.js_website_submit_form':'_onWebsiteFormSubmit',
        'click.js_disable_on_click':'_onDisableOnClick',
    }),
    custom_events:_.extend({},publicWidget.RootWidget.prototype.custom_events||{},{
        call_service:'_onCallService',
        context_get:'_onContextGet',
        main_object_request:'_onMainObjectRequest',
        widgets_start_request:'_onWidgetsStartRequest',
        widgets_stop_request:'_onWidgetsStopRequest',
    }),

    /**
     *@constructor
     */
    init:function(){
        this._super.apply(this,arguments);
        this.env=env;
        this.publicWidgets=[];
    },
    /**
     *@override
     */
    willStart:function(){
        //TODOwouldbeevengreatertowaitforlocaleDefonlywhennecessary
        returnPromise.all([
            this._super.apply(this,arguments),
            session.is_bound,
            localeDef
        ]);
    },
    /**
     *@override
     */
    start:function(){
        vardefs=[
            this._super.apply(this,arguments),
            this._startWidgets()
        ];

        //Displayimagethumbnail
        this.$(".o_image[data-mimetype^='image']").each(function(){
            var$img=$(this);
            if(/gif|jpe|jpg|png/.test($img.data('mimetype'))&&$img.data('src')){
                $img.css('background-image',"url('"+$img.data('src')+"')");
            }
        });

        //Autoscroll
        if(window.location.hash.indexOf("scrollTop=")>-1){
            this.el.scrollTop=+window.location.hash.match(/scrollTop=([0-9]+)/)[1];
        }

        //FixforIE:
        if($.fn.placeholder){
            $('input,textarea').placeholder();
        }

        this.$el.children().on('error.datetimepicker',this._onDateTimePickerError.bind(this));

        returnPromise.all(defs);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *Retrievestheglobalcontextofthepublicenvironment.Thisisthe
     *contextwhichisautomaticallyaddedtoeachRPC.
     *
     *@private
     *@param{Object}[context]
     *@returns{Object}
     */
    _getContext:function(context){
        return_.extend({
            'lang':getLang(),
        },context||{});
    },
    /**
     *Retrievestheglobalcontextofthepublicenvironment(as
     *@see_getContext)butwithextrainformationsthatwouldbeuselessto
     *sendwitheachRPC.
     *
     *@private
     *@param{Object}[context]
     *@returns{Object}
     */
    _getExtraContext:function(context){
        returnthis._getContext(context);
    },
    /**
     *@private
     *@param{Object}[options]
     *@returns{Object}
     */
    _getPublicWidgetsRegistry:function(options){
        returnpublicWidget.registry;
    },
    /**
     *Astherootinstanceisdesignedtobeunique,theassociated
     *registryhasbeeninstantiatedoutsideoftheclassandissimply
     *returnedhere.
     *
     *@private
     *@override
     */
    _getRegistry:function(){
        returnpublicRootRegistry;
    },
    /**
     *CreatesanPublicWidgetinstanceforeachDOMelementwhichmatchesthe
     *`selector`keyofoneoftheregisteredwidgets
     *(@seePublicWidget.selector).
     *
     *@private
     *@param{jQuery}[$from]
     *       onlyinitializethepublicwidgetswhose`selector`matchesthe
     *       elementoroneofitsdescendant(defaulttothewrapwrapelement)
     *@param{Object}[options]
     *@returns{Deferred}
     */
    _startWidgets:function($from,options){
        varself=this;

        if($from===undefined){
            $from=this.$('#wrapwrap');
            if(!$from.length){
                //TODORemovethisonceallfrontendlayoutspossessa
                //#wrapwrapelement(whichisnecessaryforthosepagestobe
                //adaptedcorrectlyiftheuserinstallswebsite).
                $from=this.$el;
            }
        }
        if(options===undefined){
            options={};
        }

        this._stopWidgets($from);

        vardefs=_.map(this._getPublicWidgetsRegistry(options),function(PublicWidget){
            varselector=PublicWidget.prototype.selector||'';
            var$target=dom.cssFind($from,selector,true);

            vardefs=_.map($target,function(el){
                varwidget=newPublicWidget(self,options);
                self.publicWidgets.push(widget);
                returnwidget.attachTo($(el));
            });
            returnPromise.all(defs);
        });
        returnPromise.all(defs);
    },
    /**
     *Destroysallregisteredwidgetinstances.Websitewouldneedthisbefore
     *savingwhileineditionmodeforexample.
     *
     *@private
     *@param{jQuery}[$from]
     *       onlystopthepublicwidgetslinkedtothegivenelement(s)orone
     *       ofitsdescendants
     */
    _stopWidgets:function($from){
        varremovedWidgets=_.map(this.publicWidgets,function(widget){
            if(!$from
                ||$from.filter(widget.el).length
                ||$from.find(widget.el).length){
                widget.destroy();
                returnwidget;
            }
            returnnull;
        });
        this.publicWidgets=_.difference(this.publicWidgets,removedWidgets);
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Callstherequestedservicefromtheenv.Automaticallyaddstheglobal
     *contexttoRPCs.
     *
     *@private
     *@param{FlectraEvent}event
     */
    _onCallService:function(ev){
        function_computeContext(context,noContextKeys){
            context=_.extend({},this._getContext(),context);
            if(noContextKeys){
                context=_.omit(context,noContextKeys);
            }
            returnJSON.parse(JSON.stringify(context));
        }

        constpayload=ev.data;
        letargs=payload.args||[];
        if(payload.service==='ajax'&&payload.method==='rpc'){
            //ajaxserviceusesanextra'target'argumentforrpc
            args=args.concat(ev.target);

            varroute=args[0];
            if(_.str.startsWith(route,'/web/dataset/call_kw/')){
                varparams=args[1];
                varoptions=args[2];
                varnoContextKeys;
                if(options){
                    noContextKeys=options.noContextKeys;
                    args[2]=_.omit(options,'noContextKeys');
                }
                params.kwargs.context=_computeContext.call(this,params.kwargs.context,noContextKeys);
            }
        }elseif(payload.service==='ajax'&&payload.method==='loadLibs'){
            args[1]=_computeContext.call(this,args[1]);
        }

        constservice=this.env.services[payload.service];
        constresult=service[payload.method].apply(service,args);
        payload.callback(result);
    },
    /**
     *Calledwhensomeoneaskedfortheglobalpubliccontext.
     *
     *@private
     *@param{FlectraEvent}ev
     */
    _onContextGet:function(ev){
        if(ev.data.extra){
            ev.data.callback(this._getExtraContext(ev.data.context));
        }else{
            ev.data.callback(this._getContext(ev.data.context));
        }
    },
    /**
     *Checksinformationaboutthepagemainobject.
     *
     *@private
     *@param{FlectraEvent}ev
     */
    _onMainObjectRequest:function(ev){
        varrepr=$('html').data('main-object');
        varm=repr.match(/(.+)\((\d+),(.*)\)/);
        ev.data.callback({
            model:m[1],
            id:m[2]|0,
        });
    },
    /**
     *Calledwhentherootisnotifiedthatthepublicwidgetshavetobe
     *(re)started.
     *
     *@private
     *@param{FlectraEvent}ev
     */
    _onWidgetsStartRequest:function(ev){
        this._startWidgets(ev.data.$target,ev.data.options)
            .then(ev.data.onSuccess)
            .guardedCatch(ev.data.onFailure);
    },
    /**
     *Calledwhentherootisnotifiedthatthepublicwidgetshavetobe
     *stopped.
     *
     *@private
     *@param{FlectraEvent}ev
     */
    _onWidgetsStopRequest:function(ev){
        this._stopWidgets(ev.data.$target);
    },
    /**
     *@todoreview
     *@private
     */
    _onWebsiteFormSubmit:function(ev){
        var$buttons=$(ev.currentTarget).find('button[type="submit"],a.a-submit');
        _.each($buttons,function(btn){
            var$btn=$(btn);
            $btn.html('<iclass="fafa-spinnerfa-spin"></i>'+$btn.text());
            $btn.prop('disabled',true);
        });
    },
    /**
     *Calledwhentherootisnotifiedthatthebuttonshouldbe
     *disabledafterthefirstclick.
     *
     *@private
     *@param{Event}ev
     */
    _onDisableOnClick:function(ev){
        $(ev.currentTarget).addClass('disabled');
    },
    /**
     *Libraryclearsthewrongdateformatsojustignoreerror
     *
     *@private
     *@param{Event}ev
     */
    _onDateTimePickerError:function(ev){
        returnfalse;
    },
});

return{
    PublicRoot:PublicRoot,
    publicRootRegistry:publicRootRegistry,
};
});
