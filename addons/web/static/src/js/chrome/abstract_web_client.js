flectra.define('web.AbstractWebClient',function(require){
"usestrict";

/**
 *AbstractWebClient
 *
 *Thisclassdefinesasimple,basicwebclient. Itismostlyfunctional.
 *TheWebClientisinsomewaythemostimportantclassforthewebframework:
 *-thisistheclassthatinstantiateeverythingelse,
 *-itisthetopofthecomponenttree,
 *-itcoordinatesmanyeventsbubblingup
 */

varActionManager=require('web.ActionManager');
varconcurrency=require('web.concurrency');
varcore=require('web.core');
varconfig=require('web.config');
varWarningDialog=require('web.CrashManager').WarningDialog;
vardata_manager=require('web.data_manager');
vardom=require('web.dom');
varKeyboardNavigationMixin=require('web.KeyboardNavigationMixin');
varLoading=require('web.Loading');
varRainbowMan=require('web.RainbowMan');
varsession=require('web.session');
varutils=require('web.utils');
varWidget=require('web.Widget');

constenv=require('web.env');

var_t=core._t;

varAbstractWebClient=Widget.extend(KeyboardNavigationMixin,{
    dependencies:['notification'],
    events:_.extend({},KeyboardNavigationMixin.events),
    custom_events:{
        call_service:'_onCallService',
        clear_uncommitted_changes:function(e){
            this.clear_uncommitted_changes().then(e.data.callback);
        },
        toggle_fullscreen:function(event){
            this.toggle_fullscreen(event.data.fullscreen);
        },
        current_action_updated:function(ev){
            this.current_action_updated(ev.data.action,ev.data.controller);
        },
        //GENERICSERVICES
        //thenexteventsarededicatedtogenericservicesrequiredby
        //downstreamwidgets. Mainlysideeffects,suchasrpcs,notifications
        //orcache.
        warning:'_onDisplayWarning',
        load_action:'_onLoadAction',
        load_views:function(event){
            varparams={
                model:event.data.modelName,
                context:event.data.context,
                views_descr:event.data.views,
            };
            returndata_manager
                .load_views(params,event.data.options||{})
                .then(event.data.on_success);
        },
        load_filters:function(event){
            returndata_manager
                .load_filters(event.data)
                .then(event.data.on_success);
        },
        create_filter:'_onCreateFilter',
        delete_filter:'_onDeleteFilter',
        push_state:'_onPushState',
        show_effect:'_onShowEffect',
        //session
        get_session:function(event){
            if(event.data.callback){
                event.data.callback(session);
            }
        },
        do_action:function(event){
            constactionProm=this.do_action(event.data.action,event.data.options||{});
            this.menu_dp.add(actionProm).then(function(result){
                if(event.data.on_success){
                    event.data.on_success(result);
                }
            }).guardedCatch(function(result){
                if(event.data.on_fail){
                    event.data.on_fail(result);
                }
            });
        },
        getScrollPosition:'_onGetScrollPosition',
        scrollTo:'_onScrollTo',
        set_title_part:'_onSetTitlePart',
        webclient_started:'_onWebClientStarted',
    },
    init:function(parent){
        //aflagtodeterminethatflectraisfullyloaded
        flectra.isReady=false;
        this.client_options={};
        this._super(parent);
        KeyboardNavigationMixin.init.call(this);
        this.origin=undefined;
        this._current_state=null;
        this.menu_dp=newconcurrency.DropPrevious();
        this.action_mutex=newconcurrency.Mutex();
        this.set('title_part',{"zopenerp":"Flectra"});
        this.env=env;
        this.env.bus.on('set_title_part',this,this._onSetTitlePart);
    },
    /**
     *@override
     */
    start:function(){
        KeyboardNavigationMixin.start.call(this);
        varself=this;

        //weaddtheo_touch_devicecssclasstoallowCSStotargettouch
        //devices. Thisisonlyforstylingpurpose,ifyouneedjavascript
        //specificbehaviourfortouchdevice,justusetheconfigobject
        //exportedbyweb.config
        this.$el.toggleClass('o_touch_device',config.device.touch);
        this.on("change:title_part",this,this._title_changed);
        this._title_changed();

        varstate=$.bbq.getState();
        //Ifnotsetontheurl,retrievecidsfromthelocalstorage
        //offromthedefaultcompanyontheuser
        varcurrent_company_id=session.user_companies.current_company[0]
        if(!state.cids){
            state.cids=utils.get_cookie('cids')!==null?utils.get_cookie('cids'):String(current_company_id);
        }
        //Ifakeyappearsseveraltimesinthehash,itisavailableinthe
        //bbqstateasanarraycontainingalloccurrencesofthatkey
        constcids=Array.isArray(state.cids)?state.cids[0]:state.cids;
        letstateCompanyIDS=cids.split(',').map(cid=>parseInt(cid,10));
        varuserCompanyIDS=_.map(session.user_companies.allowed_companies,function(company){returncompany[0]});
        //Checkthattheuserhasaccesstoallthecompanies
        if(!_.isEmpty(_.difference(stateCompanyIDS,userCompanyIDS))){
            state.cids=String(current_company_id);
            stateCompanyIDS=[current_company_id]
        }
        //Updatetheusercontextwiththisconfiguration
        session.user_context.allowed_company_ids=stateCompanyIDS;
        $.bbq.pushState(state);
        //Updatefavicon
        $("link[type='image/x-icon']").attr('href','/web/image/res.company/'+String(stateCompanyIDS[0])+'/favicon/')

        returnsession.is_bound
            .then(function(){
                self.$el.toggleClass('o_rtl',_t.database.parameters.direction==="rtl");
                self.bind_events();
                returnPromise.all([
                    self.set_action_manager(),
                    self.set_loading()
                ]);
            }).then(function(){
                if(session.session_is_valid()){
                    returnself.show_application();
                }else{
                    //databasemanagerneedsthewebclienttokeepgoingeven
                    //thoughithasnovalidsession
                    returnPromise.resolve();
                }
            });
    },
    /**
     *@override
     */
    destroy:function(){
        KeyboardNavigationMixin.destroy.call(this);
        returnthis._super(...arguments);
    },
    bind_events:function(){
        varself=this;
        $('.oe_systray').show();
        this.$el.on('mouseenter','.oe_systray>div:not([data-toggle=tooltip])',function(){
            $(this).attr('data-toggle','tooltip').tooltip().trigger('mouseenter');
        });
        //TODO:thishandlerseemsuselesssince11.0,shouldberemoved
        this.$el.on('click','.oe_dropdown_toggle',function(ev){
            ev.preventDefault();
            var$toggle=$(this);
            vardoc_width=$(document).width();
            var$menu=$toggle.siblings('.oe_dropdown_menu');
            $menu=$menu.length>=1?$menu:$toggle.find('.oe_dropdown_menu');
            varstate=$menu.is('.oe_opened');
            setTimeout(function(){
                //Donotalterpropagation
                $toggle.add($menu).toggleClass('oe_opened',!state);
                if(!state){
                    //Move$menuifoutsidewindow'sedge
                    varoffset=$menu.offset();
                    varmenu_width=$menu.width();
                    varx=doc_width-offset.left-menu_width-2;
                    if(x<0){
                        $menu.offset({left:offset.left+x}).width(menu_width);
                    }
                }
            },0);
        });
        core.bus.on('click',this,function(ev){
            $('.tooltip').remove();
            if(!$(ev.target).is('input[type=file]')){
                $(this.el.getElementsByClassName('oe_dropdown_menuoe_opened')).removeClass('oe_opened');
                $(this.el.getElementsByClassName('oe_dropdown_toggleoe_opened')).removeClass('oe_opened');
            }
        });
        core.bus.on('connection_lost',this,this._onConnectionLost);
        core.bus.on('connection_restored',this,this._onConnectionRestored);
    },
    set_action_manager:function(){
        varself=this;
        this.action_manager=newActionManager(this,session.user_context);
        this.env.bus.on('do-action',this,payload=>{
            this.do_action(payload.action,payload.options||{})
                .then(payload.on_success||(()=>{}))
                .guardedCatch(payload.on_fail||(()=>{}));
        });
        varfragment=document.createDocumentFragment();
        returnthis.action_manager.appendTo(fragment).then(function(){
            dom.append(self.$el,fragment,{
                in_DOM:true,
                callbacks:[{widget:self.action_manager}],
            });
        });
    },
    set_loading:function(){
        this.loading=newLoading(this);
        returnthis.loading.appendTo(this.$el);
    },
    show_application:function(){
    },
    clear_uncommitted_changes:function(){
        returnthis.action_manager.clearUncommittedChanges();
    },
    destroy_content:function(){
        _.each(_.clone(this.getChildren()),function(el){
            el.destroy();
        });
        this.$el.children().remove();
    },
    //--------------------------------------------------------------
    //Windowtitlehandling
    //--------------------------------------------------------------
    /**
     *Setsthefirstpartofthetitleofthewindow,dedicatedtothecurrentaction.
    */
    set_title:function(title){
        this.set_title_part("action",title);
    },
    /**
     *Setsanarbitrarypartofthetitleofthewindow.Titlepartsare
     *identifiedbystrings.Eachtimeatitlepartischanged,allparts
     *aregathered,orderedbyalphabeticalorderanddisplayedinthetitle
     *ofthewindowseparatedby``-``.
     *
     *@private
     *@param{string}part
     *@param{string}title
     */
    set_title_part:function(part,title){
        vartmp=_.clone(this.get("title_part"));
        tmp[part]=title;
        this.set("title_part",tmp);
    },
    _title_changed:function(){
        varparts=_.sortBy(_.keys(this.get("title_part")),function(x){returnx;});
        vartmp="";
        _.each(parts,function(part){
            varstr=this.get("title_part")[part];
            if(str){
                tmp=tmp?tmp+"-"+str:str;
            }
        },this);
        document.title=tmp;
    },
    //--------------------------------------------------------------
    //do_*
    //--------------------------------------------------------------
    /**
     *Whendo_actionisperformedontheWebClient,forwardittothemainActionManager
     *ThisallowstowidgetsthatarenotinsidetheActionManagertoperformdo_action
     */
    do_action:function(){
        returnthis.action_manager.doAction.apply(this.action_manager,arguments);
    },
    do_reload:function(){
        varself=this;
        returnsession.session_reload().then(function(){
            session.load_modules(true).then(
                self.menu.proxy('do_reload'));
        });
    },
    do_push_state:function(state){
        if(!state.menu_id&&this.menu){//this.menudoesn'texistinthePOS
            state.menu_id=this.menu.getCurrentPrimaryMenu();
        }
        if('title'instate){
            this.set_title(state.title);
            deletestate.title;
        }
        varurl='#'+$.param(state);
        this._current_state=$.deparam($.param(state),false);//stringifyallvalues
        $.bbq.pushState(url);
        this.trigger('state_pushed',state);
    },
    //--------------------------------------------------------------
    //Connectionnotifications
    //--------------------------------------------------------------
    /**
     *Handlertobeoverridden,calledeachtimetheUIisupdatedbythe
     *ActionManager.
     *
     *@param{Object}actiontheactionofthecurrentlydisplayedcontroller
     *@param{Object}controllerthecurrentlydisplayedcontroller
     */
    current_action_updated:function(action,controller){
    },
    //--------------------------------------------------------------
    //Misc.
    //--------------------------------------------------------------
    toggle_fullscreen:function(fullscreen){
        this.$el.toggleClass('o_fullscreen',fullscreen);
    },

    //--------------------------------------------------------------------------
    //Public
    //--------------------------------------------------------------------------

    /**
     *Returnstheleftandtopscrollpositionsofthemainscrollingarea
     *(i.e.the'.o_content'divindesktop).
     *
     *@returns{Object}withkeysleftandtop
     */
    getScrollPosition:function(){
        varscrollingEl=this.action_manager.el.getElementsByClassName('o_content')[0];
        return{
            left:scrollingEl?scrollingEl.scrollLeft:0,
            top:scrollingEl?scrollingEl.scrollTop:0,
        };
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Callstherequestedservicefromtheenv.
     *
     *Fortheajaxservice,theargumentsareextendedwiththetargetsothat
     *itcancallbackthecaller.
     *
     *@private
     *@param{FlectraEvent}event
     */
    _onCallService:function(ev){
        constpayload=ev.data;
        letargs=payload.args||[];
        if(payload.service==='ajax'&&payload.method==='rpc'){
            //ajaxserviceusesanextra'target'argumentforrpc
            args=args.concat(ev.target);
        }
        constservice=this.env.services[payload.service];
        constresult=service[payload.method].apply(service,args);
        payload.callback(result);
    },
    /**
     *Whenevertheconnectionislost,weneedtonotifytheuser.
     *
     *@private
     */
    _onConnectionLost:function(){
        this.connectionNotificationID=this.displayNotification({
            message:_t('Connectionlost.Tryingtoreconnect...'),
            sticky:true
        });
    },
    /**
     *Whenevertheconnectionisrestored,weneedtonotifytheuser.
     *
     *@private
     */
    _onConnectionRestored:function(){
        if(this.connectionNotificationID){
            this.call('notification','close',this.connectionNotificationID);
            this.displayNotification({
                type:'info',
                message:_t('Connectionrestored.Youarebackonline.'),
                sticky:false
            });
            this.connectionNotificationID=false;
        }
    },
    /**
     *@private
     *@param{FlectraEvent}e
     *@param{Object}e.data.filterthefilterdescription
     *@param{function}e.data.on_successcalledwhentheRPCsucceedswithits
     *  returnedvalueasargument
     */
    _onCreateFilter:function(e){
        data_manager
            .create_filter(e.data.filter)
            .then(e.data.on_success);
    },
    /**
     *@private
     *@param{FlectraEvent}e
     *@param{Object}e.data.filterthefilterdescription
     *@param{function}e.data.on_successcalledwhentheRPCsucceedswithits
     *  returnedvalueasargument
     */
    _onDeleteFilter:function(e){
        data_manager
            .delete_filter(e.data.filterId)
            .then(e.data.on_success);
    },
    /**
     *Displaysawarninginadialogorwiththenotificationservice
     *
     *@private
     *@param{FlectraEvent}e
     *@param{string}e.data.messagethewarning'smessage
     *@param{string}e.data.titlethewarning'stitle
     *@param{string}[e.data.type]'dialog'todisplayinadialog
     *@param{boolean}[e.data.sticky]whetherornotthewarningshouldbe
     *  sticky(ifdisplayedwiththeNotification)
     */
    _onDisplayWarning:function(e){
        vardata=e.data;
        if(data.type==='dialog'){
            newWarningDialog(this,{
                title:data.title,
            },data).open();
        }else{
            data.type='warning';
            this.call('notification','notify',data);
        }
    },
    /**
     *Providestothecallerthecurrentscrollposition(leftandtop)ofthe
     *mainscrollingareaofthewebclient.
     *
     *@private
     *@param{FlectraEvent}ev
     *@param{function}ev.data.callback
     */
    _onGetScrollPosition:function(ev){
        ev.data.callback(this.getScrollPosition());
    },
    /**
     *LoadsanactionfromthedatabasegivenitsID.
     *
     *@private
     *@param{FlectraEvent}event
     *@param{integer}event.data.actionID
     *@param{Object}event.data.context
     *@param{function}event.data.on_success
     */
    _onLoadAction:function(event){
        data_manager
            .load_action(event.data.actionID,event.data.context)
            .then(event.data.on_success);
    },
    /**
     *@private
     *@param{FlectraEvent}e
     */
    _onPushState:function(e){
        this.do_push_state(_.extend(e.data.state,{'cids':$.bbq.getState().cids}));
    },
    /**
     *Scrollseithertoagivenoffsetortoatargetelement(givenaselector).
     *Itmustbecalledwith:trigger_up('scrollTo',options).
     *
     *@private
     *@param{FlectraEvent}ev
     *@param{integer}[ev.data.top]thenumberofpixelstoscrollfromtop
     *@param{integer}[ev.data.left]thenumberofpixelstoscrollfromleft
     *@param{string}[ev.data.selector]theselectorofthetargetelementto
     *  scrollto
     */
    _onScrollTo:function(ev){
        varscrollingEl=this.action_manager.el.getElementsByClassName('o_content')[0];
        if(!scrollingEl){
            return;
        }
        varoffset={top:ev.data.top,left:ev.data.left||0};
        if(ev.data.selector){
            offset=dom.getPosition(document.querySelector(ev.data.selector));
            //Substractthepositionofthescrollingelement
            offset.top-=dom.getPosition(scrollingEl).top;
        }

        scrollingEl.scrollTop=offset.top;
        scrollingEl.scrollLeft=offset.left;
    },
    /**
     *@private
     *@param{Object}payload
     *@param{string}payload.part
     *@param{string}[payload.title]
     */
    _onSetTitlePart:function(payload){
        varpart=payload.part;
        vartitle=payload.title;
        this.set_title_part(part,title);
    },
    /**
     *Displaysavisualeffect(forexample,arainbowman0
     *
     *@private
     *@param{FlectraEvent}e
     *@param{Object}[e.data]-key-valueoptionstodeciderainbowman
     *  behavior/appearance
     */
    _onShowEffect:function(e){
        vardata=e.data||{};
        vartype=data.type||'rainbow_man';
        if(type==='rainbow_man'){
            if(session.show_effect){
                newRainbowMan(data).appendTo(this.$el);
            }else{
                //Forinstancekeeptitleblank,aswedon'thavetitleindata
                this.call('notification','notify',{
                    title:"",
                    message:data.message,
                    sticky:false
                });
            }
        }else{
            thrownewError('Unknowneffecttype:'+type);
        }
    },
    /**
     *ReactstotheendoftheloadingoftheWebClientasawhole
     *Itallowsforsignallingtotherestoftheecosystemthattheinterfaceisusable
     *
     *@private
     */
    _onWebClientStarted:function(){
        if(!this.isStarted){
            //Listento'scroll'eventandpropagateitonmainbus
            this.action_manager.$el.on('scroll',core.bus.trigger.bind(core.bus,'scroll'));
            flectra.isReady=true;
            core.bus.trigger('web_client_ready');
            if(session.uid===1){
                this.$el.addClass('o_is_superuser');
            }
            this.isStarted=true;
        }
    }
});

returnAbstractWebClient;

});
