/**
 *Client-sideimplementationofaqwebview.
 */
flectra.define('web.qweb',function(require){
"usestrict";

varcore=require('web.core');
varAbstractView=require('web.AbstractView');
varAbstractModel=require('web.AbstractModel');
varAbstractRenderer=require('web.AbstractRenderer');
varAbstractController=require('web.AbstractController');
varregistry=require('web.view_registry');

var_lt=core._lt;

/**
 *model
 */
varModel=AbstractModel.extend({
    /**
     *init
     */
    init:function(){
        this._super.apply(this,arguments);
        this._state={
            viewId:false,
            modelName:false,
            body:'',
            context:{},
            domain:[],
        };
    },
    /**
     *fetchestherenderedqwebview
     */
    _fetch:function(){
        varstate=this._state;
        returnthis._rpc({
            model:state.modelName,
            method:'qweb_render_view',
            kwargs:{
                view_id:state.viewId,
                domain:state.domain,
                context:state.context
            }
        }).then(function(r){
            state.body=r;
            returnstate.viewId;
        });
    },
    /**
     *get
     */
    __get:function(){
        returnthis._state;
    },
    /**
     *load
     */
    __load:function(params){
        _.extend(this._state,_.pick(params,['viewId','modelName','domain','context']));

        returnthis._fetch();
    },
    /**
     *reload
     */
    __reload:function(_id,params){
        _.extend(this._state,_.pick(params,['domain','context']));

        returnthis._fetch();
    }
});
/**
 *renderer
 */
varRenderer=AbstractRenderer.extend({
    /**
     *render
     */
    _render:function(){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(){
            self.$el.html(self.state.body);
        });
    }
});
/**
 *controller
 */
varController=AbstractController.extend({
    events:_.extend({},AbstractController.prototype.events,{
        'click[type="toggle"]':'_onLazyToggle',
        'click[type="action"]':'_onActionClicked',
    }),

    init:function(){
        this._super.apply(this,arguments);
    },

    /**
     *@override
     */
    renderButtons:function($node){
        this.$buttons=$('<nav/>');
        if($node){
            $node.append(this.$buttons);
        }
    },
    _update:function(){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(){
            //movecontrolpanelbuttonsfromtheviewtothecontrolpanel
            //area
            var$cp_buttons=self.renderer.$('nav.o_qweb_cp_buttons');
            $cp_buttons.children().appendTo(self.$buttons.empty());
            $cp_buttons.remove();
        });
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Lazytoggle.Contentisnotrememberedbetweenunfolds.
     */
    _onLazyToggle:function(e){
        //TODO:addsupportforview(possiblyactionaswell?)
        var$target=$(e.target);
        var$t=$target.closest('[data-model]');
        if(!($target.hasClass('fa-caret-down')||$target.hasClass('fa-caret-right'))){
            $target=$t.find('.fa-caret-down,.fa-caret-right');
        }

        vardata=$t.data();
        if(this._fold($t)){
            $target.removeClass('fa-caret-down').addClass('fa-caret-right');
            return;
        }

        //NB:$.data()automaticallyparsesjsonattributes,butdoesnot
        //    automaticallyparselonefloatliteralsindata-*,soa
        //    data-args(asajsonobject)isveryconvenient
        varargs=data.args||_.omit(data,'model','method','id');

        returnthis._rpc({
            model:data.model,
            method:data.method,
            args:data.id?[data.id]:undefined,
            kwargs:args//FIXME:context?
        }).then(function(s){
            return$(s);
        }).then(function($newcontent){
            $t.data('children',$newcontent).after($newcontent);
            $target.removeClass('fa-caret-right').addClass('fa-caret-down');
        });
    },
    /**
     *Attemptstofoldtheparameter,returnswhetherthathappened.
     */
    _fold:function($el){
        var$children=$el.data('children');
        if(!$children){
            returnfalse;
        }

        varself=this;
        $children.each(function(_i,e){
            self._fold($(e));
        }).remove();
        $el.removeData('children');
        returntrue;
    }
});

/**
 *view
 */
varQWebView=AbstractView.extend({
    display_name:_lt('FreedomView'),
    icon:'fa-file-picture-o',
    viewType:'qweb',
    //groupable?
    enableTimeRangeMenu:true,
    config:_.extend({},AbstractView.prototype.config,{
        Model:Model,
        Renderer:Renderer,
        Controller:Controller,
    }),

    /**
     *initmethod
     */
    init:function(viewInfo,params){
        this._super.apply(this,arguments);
        this.loadParams.viewId=viewInfo.view_id;
    }
});

registry.add('qweb',QWebView);
return{
    View:QWebView,
    Controller:Controller,
    Renderer:Renderer,
    Model:Model
};
});
