
flectra.define('web.translation',function(require){
"usestrict";

varClass=require('web.Class');

varTranslationDataBase=Class.extend(/**@lendsinstance.TranslationDataBase#*/{
    init:function(){
        this.db={};
        this.multi_lang=false
        this.parameters={"direction":'ltr',
                        "date_format":'%m/%d/%Y',
                        "time_format":'%H:%M:%S',
                        "grouping":[],
                        "decimal_point":".",
                        "thousands_sep":",",
                        "code":"en_US"};
    },
    set_bundle:function(translation_bundle){
        varself=this;
        this.multi_lang=translation_bundle.multi_lang
        varmodules=_.keys(translation_bundle.modules);
        modules.sort();
        if(_.include(modules,"web")){
            modules=["web"].concat(_.without(modules,"web"));
        }
        _.each(modules,function(name){
            self.add_module_translation(translation_bundle.modules[name]);
        });
        if(translation_bundle.lang_parameters){
            this.parameters=translation_bundle.lang_parameters;
            this.parameters.grouping=JSON.parse(this.parameters.grouping);
        }
    },
    add_module_translation:function(mod){
        varself=this;
        _.each(mod.messages,function(message){
            self.db[message.id]=message.string;
        });
    },
    build_translation_function:function(){
        varself=this;
        varfcnt=function(str){
            vartmp=self.get(str);
            returntmp===undefined?str:tmp;
        };
        fcnt.database=this;
        returnfcnt;
    },
    get:function(key){
        returnthis.db[key];
    },
    /**
        LoadsthetranslationsfromanOpenERPserver.

        @param{openerp.Session}sessionThesessionobjecttocontacttheserver.
        @param{Array}[modules]Thelistofmodulestoloadthetranslation.Ifnotspecified,
        itwilldefaulttoallthemodulesinstalledinthecurrentdatabase.
        @param{Object}[lang]langThelanguage.Ifnotspecifieditwilldefaulttothelanguage
        ofthecurrentuser.
        @param{string}[url='/web/webclient/translations']
        @returns{Promise}
    */
    load_translations:function(session,modules,lang,url){
        varself=this;
        varcacheId=session.cache_hashes&&session.cache_hashes.translations;
        url=url||'/web/webclient/translations';
        url+='/'+(cacheId?cacheId:Date.now());
        return$.get(url,{
            mods:modules?modules.join(','):null,
            lang:lang||null,
        }).then(function(trans){
            self.set_bundle(trans);
        });
    }
});

/**
 *Eagertranslationfunction,performstranslationimmediatelyatcall
 *site.Bewareusingthisoutsideofmethodbodies(beforethe
 *translationdatabaseisloaded),youprobablywant:func:`_lt`
 *instead.
 *
 *@function_t
 *@param{String}sourcestringtotranslate
 *@returns{String}sourcetranslatedintothecurrentlocale
 */
var_t=newTranslationDataBase().build_translation_function();
/**
 *Lazytranslationfunction,onlyperformsthetranslationwhenactually
 *printed(e.g.insertedintoatemplate)
 *
 *Usefulwhendefiningtranslatablestringsincodeevaluatedbeforethe
 *translationdatabaseisloaded,asclassattributesoratthetop-levelof
 *anOpenERPWebmodule
 *
 *@param{String}sstringtotranslate
 *@returns{Object}lazytranslationobject
 */
var_lt=function(s){
    return{toString:function(){return_t(s);}};
};

/**SetupjQuerytimeago*/
/*
 *Stringsintimeagoare"composed"withprefixes,wordsandsuffixes.This
 *makestheirdetectionbyourtranslatingsystemimpossible.Useallliteral
 *stringswe'reusingwithatranslationmarkheresotheextractorcandoits
 *job.
 */
{
    _t('lessthanaminuteago');
    _t('aboutaminuteago');
    _t('%dminutesago');
    _t('aboutanhourago');
    _t('%dhoursago');
    _t('adayago');
    _t('%ddaysago');
    _t('aboutamonthago');
    _t('%dmonthsago');
    _t('aboutayearago');
    _t('%dyearsago');
}


return{
    _t:_t,
    _lt:_lt,
    TranslationDataBase:TranslationDataBase,
};

});
