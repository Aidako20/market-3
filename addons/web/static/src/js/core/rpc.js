flectra.define('web.rpc',function(require){
"usestrict";

varajax=require('web.ajax');

constrpc={
    /**
     *PerformaRPC. Pleasenotethatthisisnotthepreferredwaytodoa
     *rpcifyouareinthecontextofawidget. Inthatcase,youshoulduse
     *thethis._rpcmethod.
     *
     *@param{Object}params@seebuildQueryforadescription
     *@param{Object}options
     *@returns{Promise<any>}
     */
    query:function(params,options){
        varquery=rpc.buildQuery(params);
        returnajax.rpc(query.route,query.params,options);
    },
    /**
     *@param{Object}options
     *@param{any[]}[options.args]
     *@param{Object}[options.context]
     *@param{any[]}[options.domain]
     *@param{string[]}[options.fields]
     *@param{string[]}[options.groupBy]
     *@param{Object}[options.kwargs]
     *@param{integer|false}[options.limit]
     *@param{string}[options.method]
     *@param{string}[options.model]
     *@param{integer}[options.offset]
     *@param{string[]}[options.orderBy]
     *@param{Object}[options.params]
     *@param{string}[options.route]
     *@returns{Object}with2keys:routeandparams
     */
    buildQuery:function(options){
        varroute;
        varparams=options.params||{};
        varorderBy;
        if(options.route){
            route=options.route;
        }elseif(options.model&&options.method){
            route='/web/dataset/call_kw/'+options.model+'/'+options.method;
        }
        if(options.method){
            params.args=options.args||[];
            params.model=options.model;
            params.method=options.method;
            params.kwargs=_.extend(params.kwargs||{},options.kwargs);
            params.kwargs.context=options.context||params.context||params.kwargs.context;
        }

        if(options.method==='read_group'||options.method==='web_read_group'){
            if(!(params.args&&params.args[0]!==undefined)){
                params.kwargs.domain=options.domain||params.domain||params.kwargs.domain||[];
            }
            if(!(params.args&&params.args[1]!==undefined)){
                params.kwargs.fields=options.fields||params.fields||params.kwargs.fields||[];
            }
            if(!(params.args&&params.args[2]!==undefined)){
                params.kwargs.groupby=options.groupBy||params.groupBy||params.kwargs.groupby||[];
            }
            params.kwargs.offset=options.offset||params.offset||params.kwargs.offset;
            params.kwargs.limit=options.limit||params.limit||params.kwargs.limit;
            //Inkwargs,welookfor"orderby"ratherthan"orderBy"(notetheabsenceofcapitalB),
            //sincethePythonargumenttotheactualfunctionis"orderby".
            orderBy=options.orderBy||params.orderBy||params.kwargs.orderby;
            params.kwargs.orderby=orderBy?rpc._serializeSort(orderBy):orderBy;
            params.kwargs.lazy='lazy'inoptions?options.lazy:params.lazy;

            if(options.method==='web_read_group'){
                params.kwargs.expand=options.expand||params.expand||params.kwargs.expand;
                params.kwargs.expand_limit=options.expand_limit||params.expand_limit||params.kwargs.expand_limit;
                varexpandOrderBy=options.expand_orderby||params.expand_orderby||params.kwargs.expand_orderby;
                params.kwargs.expand_orderby=expandOrderBy?rpc._serializeSort(expandOrderBy):expandOrderBy;
            }
        }

        if(options.method==='search_read'){
            //callthemodelmethod
            params.kwargs.domain=options.domain||params.domain||params.kwargs.domain;
            params.kwargs.fields=options.fields||params.fields||params.kwargs.fields;
            params.kwargs.offset=options.offset||params.offset||params.kwargs.offset;
            params.kwargs.limit=options.limit||params.limit||params.kwargs.limit;
            //Inkwargs,welookfor"order"ratherthan"orderBy"sincethePython
            //argumenttotheactualfunctionis"order".
            orderBy=options.orderBy||params.orderBy||params.kwargs.order;
            params.kwargs.order=orderBy?rpc._serializeSort(orderBy):orderBy;
        }

        if(options.route==='/web/dataset/search_read'){
            //specificallycallthecontroller
            params.model=options.model||params.model;
            params.domain=options.domain||params.domain;
            params.fields=options.fields||params.fields;
            params.limit=options.limit||params.limit;
            params.offset=options.offset||params.offset;
            orderBy=options.orderBy||params.orderBy;
            params.sort=orderBy?rpc._serializeSort(orderBy):orderBy;
            params.context=options.context||params.context||{};
        }

        return{
            route:route,
            params:JSON.parse(JSON.stringify(params)),
        };
    },
    /**
     *Helpermethod,generatesastringtodescribeaorderedbysequencefor
     *SQL.
     *
     *Forexample,[{name:'foo'},{name:'bar',asc:false}]will
     *beconvertedinto'fooASC,barDESC'
     *
     *@param{Object[]}orderBylistofobjects{name:...,[asc:...]}
     *@returns{string}
     */
    _serializeSort:function(orderBy){
        return_.map(orderBy,function(order){
            returnorder.name+(order.asc!==false?'ASC':'DESC');
        }).join(',');
    },
};

returnrpc;

});
