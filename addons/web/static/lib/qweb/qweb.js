/*
Copyright(c)2013,FabienMeghazi

ReleasedundertheMITlicense

Permissionisherebygranted,freeofcharge,toanypersonobtainingacopyof
thissoftwareandassociateddocumentationfiles(the"Software"),todealin
theSoftwarewithoutrestriction,includingwithoutlimitationtherightstouse,
copy,modify,merge,publish,distribute,sublicense,and/orsellcopiesofthe
Software,andtopermitpersonstowhomtheSoftwareisfurnishedtodoso,
subjecttothefollowingconditions:

Theabovecopyrightnoticeandthispermissionnoticeshallbeincludedinall
copiesorsubstantialportionsoftheSoftware.

THESOFTWAREISPROVIDED"ASIS",WITHOUTWARRANTYOFANYKIND,EXPRESSOR
IMPLIED,INCLUDINGBUTNOTLIMITEDTOTHEWARRANTIESOFMERCHANTABILITY,FITNESS
FORAPARTICULARPURPOSEANDNONINFRINGEMENT.INNOEVENTSHALLTHEAUTHORSOR
COPYRIGHTHOLDERSBELIABLEFORANYCLAIM,DAMAGESOROTHERLIABILITY,WHETHERIN
ANACTIONOFCONTRACT,TORTOROTHERWISE,ARISINGFROM,OUTOFORINCONNECTION
WITHTHESOFTWAREORTHEUSEOROTHERDEALINGSINTHESOFTWARE.
*/

//---------------------------------------------------------
//QWebjavascript
//---------------------------------------------------------

/*
	TODO

		Stringparsing
			if(window.DOMParser){
				parser=newDOMParser();
				xmlDoc=parser.parseFromString(text,"text/xml");
			}else{
				xmlDoc=newActiveXObject("Msxml2.DOMDocument.4.0");
				xmlDoc=newActiveXObject("Microsoft.XMLDOM");
					Whichversionstotry,it'sconfusing...
				xmlDoc.async="false";
				xmlDoc.async=false;
				xmlDoc.preserveWhiteSpace=true;
				xmlDoc.load("f.xml");
				xmlDoc.loadXML(text); ?
			}

		SupportspaceinIEbyreparsingtheresponseText
			xmlhttp.responseXML.loadXML(xmlhttp.responseText);?

		Preprocess:(niceoptimization)
			preprocessbyflatteningallnont-elementtoaTEXT_NODE.
			countthenumberof"\n"intextnodestogiveanaproximateLINENUMBERonelementsforerrorreporting
			iffromIEHTMLDOMuseif(a[i].specified)toavoid88emptyattributesperelementduringthepreprocess,

		implementt-trim'left''right''both',isitneeded?inner=render_trim(l_inner.join(),t_att)

		Ruby/python:tobackportfromjavascripttopython/rubyrender_nodetouseregexp,factorizeforeach%var,t-atttestfortuple(attname,value)

	DONE
		wereintroducedt-att-id,nomoret-esc-idbecauseofthenewconventiont-att="["id","val"]"
*/

varQWeb={
    templates:{},
    prefix:"t",
    reg:newRegExp(),
    tag:{},
    att:{},
    ValueException:function(value,message){
        this.value=value;
        this.message=message;
    },
    eval_object:function(e,v){
        //TODO:Currentlythiswillalsoreplaceand,or,...instrings.Try
        //'hiboysandgirls'!=''and1==1 --willbereplacedto:'hiboys&&girls'!=''&&1==1
        //trytofindasolutionwithouttokenizing
        e='('+e+')';
        e=e.replace(/\band\b/g,"&&");
        e=e.replace(/\bor\b/g,"||");
        e=e.replace(/\bgt\b/g,">");
        e=e.replace(/\bgte\b/g,">=");
        e=e.replace(/\blt\b/g,"<");
        e=e.replace(/\blte\b/g,"<=");
        if(v[e]!=undefined){
            returnv[e];
        }else{
            with(v)returneval(e);
        }
    },
    eval_str:function(e,v){
        varr=this.eval_object(e,v);
        r=(typeof(r)=="undefined"||r==null)?"":r.toString();
        returne=="0"?v["0"]:r;
    },
    eval_format:function(e,v){
        varm,src=e.split(/#/),r=src[0];
        for(vari=1;i<src.length;i++){
            if(m=src[i].match(/^{(.*)}(.*)/)){
                r+=this.eval_str(m[1],v)+m[2];
            }else{
                r+="#"+src[i];
            }
        }
        returnr;
    },
    eval_bool:function(e,v){
        return!!this.eval_object(e,v);
    },
    trim:function(v,mode){
        if(!v||!mode)returnv;
        switch(mode){
            case'both':
                returnv.replace(/^\s*|\s*$/g,"");
            case"left":
                returnv.replace(/^\s*/,"");
            case"right":
                returnv.replace(/\s*$/,"");
        }
        thrownewQWeb.ValueException(
            mode,"unknowntrimmingmode,trimmodemustfollowthepattern'[inner](left|right|both)'");
    },
    escape_text:function(s){
        returns.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    },
    escape_att:function(s){
        returns.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    },
    render_node:function(e,v,inner_trim){
        if(e.nodeType==3){
            returninner_trim?this.trim(e.data,inner_trim):e.data;
        }
        if(e.nodeType==1){
            varg_att={};
            vart_att={};
            vart_render=null;
            vara=e.attributes;
            for(vari=0;i<a.length;i++){
                varan=a[i].name,av=a[i].value;
                varm;
                if(m=an.match(this.reg)){
                    varn=m[1];
                    if(n=="eval"){
                        n=m[2].substring(1);
                        av=this.eval_str(av,v);
                    }
                    varf;
                    if(f=this.att[n]){
                        this[f](e,t_att,g_att,v,m[2],av);
                    }elseif(f=this.tag[n]){
                        t_render=f;
                    }
                    t_att[n]=av;
                }else{
                    g_att[an]=av;
                }
            }
            if(inner_trim&&!t_att["trim"]){
                t_att["trim"]="inner"+inner_trim;
            }
            if(t_render){
                returnthis[t_render](e,t_att,g_att,v);
            }
            returnthis.render_element(e,t_att,g_att,v);
        }
        return"";
    },
    render_element:function(e,t_att,g_att,v){
        varinner="",ec=e.childNodes,trim=t_att["trim"],inner_trim;
        if(trim){
            if(/\binner\b/.test(trim)){
                inner_trim=true;
                if(trim=='inner'){
                    trim="both";
                }
            }
            vartm=/\b(both|left|right)\b/.exec(trim);
            if(tm)trim=tm[1];
        }
        for(vari=0;i<ec.length;i++){
            inner+=inner_trim?this.trim(this.render_node(ec[i],v,inner_trim?trim:null),trim):this.render_node(ec[i],v,inner_trim?trim:null);
        }
        if(trim&&!inner_trim){
            inner=this.trim(inner,trim);
        }
        if(e.tagName==this.prefix){
            returninner;
        }
        varatt="";
        for(varaning_att){
            att+=""+an+'="'+this.escape_att(g_att[an])+'"';
        }
        //SomeIEversionshaveproblemswithclosedtags
        varopentag=!!t_att['opentag']&&this.eval_bool(t_att["opentag"],v);
        returninner.length||opentag?"<"+e.tagName+att+">"+inner+"</"+e.tagName+">":"<"+e.tagName+att+"/>";
    },
    render_att_att:function(e,t_att,g_att,v,ext,av){
        if(ext){
            varattv=this.eval_object(av,v);
            if(attv!=null){
                g_att[ext.substring(1)]=attv.toString();
            }
        }else{
            varo=this.eval_object(av,v);
            if(o!=null){
                //TODO:http://bonsaiden.github.com/JavaScript-Garden/#types.typeof
                if(o.constructor==Array&&o.length>1&&o[1]!=null){
                    g_att[o[0]]=newString(o[1]);
                }elseif(o.constructor==Object){
                    for(variino){
                    	if(o[i]!=null){
                    		g_att[i]=newString(o[i]);
                    	}
                    }
                }
            }
        }
    },
    render_att_attf:function(e,t_att,g_att,v,ext,av){
        g_att[ext.substring(1)]=this.eval_format(av,v);
    },
    render_tag_raw:function(e,t_att,g_att,v){
        returnthis.eval_str(t_att["raw"],v);
    },
    render_tag_rawf:function(e,t_att,g_att,v){
        returnthis.eval_format(t_att["rawf"],v);
    },
    /*
     *Idea:ifthenameofthetag!=trenderthetagaroundthevalue<aname="a"t-esc="label"/>
     */
    render_tag_esc:function(e,t_att,g_att,v){
        returnthis.escape_text(this.eval_str(t_att["esc"],v));
    },
    render_tag_escf:function(e,t_att,g_att,v){
        returnthis.escape_text(this.eval_format(t_att["escf"],v));
    },
    render_tag_if:function(e,t_att,g_att,v){
        returnthis.eval_bool(t_att["if"],v)?this.render_element(e,t_att,g_att,v):"";
    },
    render_tag_set:function(e,t_att,g_att,v){
        varev=t_att["value"];
        if(ev&&ev.constructor!=Function){
            v[t_att["set"]]=this.eval_object(ev,v);
        }else{
            v[t_att["set"]]=this.render_element(e,t_att,g_att,v);
        }
        return"";
    },
    render_tag_call:function(e,t_att,g_att,v){
        vard=v;
        if(!t_att["import"]){
            d={};
            for(variinv){
                d[i]=v[i];
            }
        }
        d["0"]=this.render_element(e,t_att,g_att,d);
        returnthis.render(t_att["call"],d);
    },
    render_tag_js:function(e,t_att,g_att,v){
        vardict_name=t_att["js"]||"dict";
        v[dict_name]=v;
        varr=this.eval_str(this.render_element(e,t_att,g_att,v),v);
        delete(v[dict_name]);
        returnr||'';
    },
    /**
     *Rendersaforeachloop(@t-foreach).
     *
     *Addsthefollowingelementstoitscontext,where<code>${name}</code>
     *isspecifiedvia<code>@t-as</code>:
     **<code>${name}</code>Thecurrentelementitself
     **<code>${name}_value</code>Sameas<code>${name}</code>
     **<code>${name}_index</code>The0-basedindexofthecurrentelement
     **<code>${name}_first</code>Whetherthecurrentelementisthefirstone
     **<code>${name}_parity</code>odd|even(asstrings)
     **<code>${name}_all</code>Theiteratedcollectionitself
     *
     *Ifthecollectionbeingiteratedisanarray,alsoadds:
     **<code>${name}_last</code>Whetherthecurrentelementisthelastone
     **Allmembersofthecurrentobject
     *
     *Ifthecollectionbeingiteratedisanobject,thevalueisactuallytheobject'skey
     *
     *@parame?
     *@paramt_attattributesoftheelementbeing<code>t-foreach</code>'d
     *@paramg_att?
     *@paramold_contextthecontextinwhichtheforeachisevaluated
     */
    render_tag_foreach:function(e,t_att,g_att,old_context){
        varexpr=t_att["foreach"];
        varenu=this.eval_object(expr,old_context);
        varru=[];
        if(enu){
            varval=t_att['as']||expr.replace(/[^a-zA-Z0-9]/g,'_');
            varcontext={};
            for(variinold_context){
                context[i]=old_context[i];
            }
            context[val+"_all"]=enu;
            varval_value=val+"_value",
                val_index=val+"_index",
                val_first=val+"_first",
                val_last=val+"_last",
                val_parity=val+"_parity";
            varsize=enu.length;
            if(size){
                context[val+"_size"]=size;
                for(varj=0;j<size;j++){
                    varcur=enu[j];
                    context[val_value]=cur;
                    context[val_index]=j;
                    context[val_first]=j==0;
                    context[val_last]=j+1==size;
                    context[val_parity]=(j%2==1?'odd':'even');
                    if(cur.constructor==Object){
                        for(varkincur){
                            context[k]=cur[k];
                        }
                    }
                    context[val]=cur;
                    varr=this.render_element(e,t_att,g_att,context);
                    ru.push(r);
                }
            }else{
                varindex=0;
                for(curinenu){
                    context[val_value]=cur;
                    context[val_index]=index;
                    context[val_first]=index==0;
                    context[val_parity]=(index%2==1?'odd':'even');
                    context[val]=cur;
                    ru.push(this.render_element(e,t_att,g_att,context));
                    index+=1;
                }
            }
            returnru.join("");
        }else{
            return"qweb:foreach"+expr+"notfound.";
        }
    },
    hash:function(){
        varl=[],m;
        for(variinthis){
            if(m=i.match(/render_tag_(.*)/)){
                this.tag[m[1]]=i;
                l.push(m[1]);
            }elseif(m=i.match(/render_att_(.*)/)){
                this.att[m[1]]=i;
                l.push(m[1]);
            }
        }
        l.sort(function(a,b){
            returna.length>b.length?-1:1;
        });
        vars="^"+this.prefix+"-(eval|"+l.join("|")+"|.*)(.*)$";
        this.reg=newRegExp(s);
    },
    /**
     *returnsthecorrectXMLHttpRequestinstanceforthebrowser,ornullif
     *itwasnotabletobuildanyXHRinstance.
     *
     *@returnsXMLHttpRequest|MSXML2.XMLHTTP.3.0|null
     */
    get_xhr:function(){
        if(window.XMLHttpRequest){
            returnnewwindow.XMLHttpRequest();
        }
        try{
            returnnewActiveXObject('MSXML2.XMLHTTP.3.0');
        }catch(e){
            returnnull;
        }
    },
    load_xml:function(s){
        varxml;
        if(s[0]=="<"){
            /*
             manquecapoursarrisa
             if(window.DOMParser){
             mozilla
             if(!window.DOMParser){
             vardoc=Sarissa.getDomDocument();
             doc.loadXML(sXml);
             returndoc;
             };
             };
             */
        }else{
            varreq=this.get_xhr();
            if(req){
                req.open("GET",s,false);
                req.send(null);
                //ifier.setRequestHeader("If-Modified-Since","Sat,1Jan200000:00:00GMT");
                xml=req.responseXML;
                /*
                 TODO
                 ifintsernetexploror
                 getdomimplmentation()fortrycatch
                 responseXML.getImplet
                 d=domimple()
                 d.preserverWhitespace=1
                 d.loadXML()

                 xml.preserverWhitespace=1
                 xml.loadXML(r.reponseText)
                 */
                returnxml;
            }
        }
    },
    add_template:function(e){
        //TODO:keepsourcessowecanimplementreload()
        this.hash();
        if(e.constructor==String){
            e=this.load_xml(e);
        }
        
        varec=e.documentElement?e.documentElement.childNodes:(e.childNodes?e.childNodes:[]);

        for(vari=0;i<ec.length;i++){
            varn=ec[i];
            if(n.nodeType==1){
                varname=n.getAttribute(this.prefix+"-name");
                this.templates[name]=n;
            }
        }
    },
    render:function(name,v){
        vare;
        if(e=this.templates[name]){
            returnthis.render_node(e,v);
        }
        return"template"+name+"notfound";
    }
};

