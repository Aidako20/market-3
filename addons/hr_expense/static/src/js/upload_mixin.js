flectra.define('hr_expense.documents.upload.mixin',function(require){
"usestrict";

varcore=require('web.core');
varconfig=require('web.config');
var_t=core._t;
varqweb=core.qweb;

/**
*Mixinforuploadingsingleormultipledocuments.
*/
varDocumentUploadMixin={
    start:function(){
        //defineauniqueuploadIdandacallbackmethod
        this.fileUploadID=_.uniqueId('hr_expense_document_upload');
        $(window).on(this.fileUploadID,this._onFileUploaded.bind(this));
        returnthis._super.apply(this,arguments);
    },
    /**
     *@private
     */
    _onAddAttachment:function(ev){
        //Autosubmitformoncewe'veselectedanattachment
        var$input=$(ev.currentTarget).find('input.o_input_file');
        if($input.val()!==''){
            var$binaryForm=this.$('.o_expense_documents_uploadform.o_form_binary_form');
            $binaryForm.submit();
        }
    },
    /**
     *@private
     */
    _onFileUploaded:function(){
        //Callbackonceattachmenthavebeencreated,createanexpensewithattachmentids
        varself=this;
        varattachments=Array.prototype.slice.call(arguments,1);
        //Getidfromresult
        varattachent_ids=attachments.reduce(function(filtered,record){
            if(record.id){
                filtered.push(record.id);
            }
            returnfiltered;
        },[]);
        if(!attachent_ids.length){
            returnself.do_notify(false,_t("Anerroroccurredduringtheupload"));
        }
        varmyContext= this.initialState.context
        myContext['isMobile']= config.device.isMobile
        returnthis._rpc({
            model:'hr.expense',
            method:'create_expense_from_attachments',
            args:["",attachent_ids,this.viewType],
            context:myContext,
        }).then(function(result){
            self.do_action(result);
        });
    },
    /**
     *@private
     *@param{Event}event
     */
    _onUpload:function(event){
        varself=this;
        //Ifhiddenuploadformdon'texists,createit
        var$formContainer=this.$('.o_content').find('.o_expense_documents_upload');
        if(!$formContainer.length){
            $formContainer=$(qweb.render('hr.expense.DocumentsHiddenUploadForm',{widget:this}));
            $formContainer.appendTo(this.$('.o_content'));
        }
        //Triggertheinputtoselectafile
        this.$('.o_expense_documents_upload.o_input_file').click();
    },
};

returnDocumentUploadMixin;

});
