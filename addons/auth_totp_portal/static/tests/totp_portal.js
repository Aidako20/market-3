flectra.define('auth_totp_portal.tours',function(require){
"usestrict";

consttour=require('web_tour.tour');
constajax=require('web.ajax');

tour.register('totportal_tour_setup',{
    test:true,
    url:'/my/security'
},[{
    content:"Opentotpwizard",
    trigger:'button#auth_totp_portal_enable',
},{
    content:"Checkthatwehavetoenterenhancedsecuritymode",
    trigger:'div:contains("confirmyourpassword")',
    run:()=>{},
},{
    content:"Inputpassword",
    trigger:'[name=password]',
    run:'textportal',//FIXME:betterwaytodothis?
},{
    content:"Confirm",
    trigger:"button:contains(ConfirmPassword)",
},{
    content:"Checkthewizardhasopened",
    trigger:'div:contains("Scantheimagebelow")',
    run:()=>{}
},{
    content:"Getsecretfromcollapseddiv",
    trigger:'a:contains("showthecode")',
    run:asyncfunction(helpers){
        constsecret=this.$anchor.closest('div').find('code').text();
        consttoken=awaitajax.jsonRpc('/totphook','call',{
            secret
        });
        helpers._text(helpers._get_action_values('input[name=code]'),token);
        helpers._click(helpers._get_action_values('button.btn-primary:contains(Enable)'));
    }
},{
    content:"Checkthatthebuttonhaschanged",
    trigger:'button:contains(Disabletwo-factorauthentication)',
    run:()=>{}
}]);

tour.register('totportal_login_enabled',{
    test:true,
    url:'/'
},[{
    content:"checkthatwe'reontheloginpageorgotoit",
    trigger:'input#login,a:contains(Signin)'
},{
    content:"inputlogin",
    trigger:'input#login',
    run:'textportal',
},{
    content:'inputpassword',
    trigger:'input#password',
    run:'textportal',
},{
    content:"clickdabutton",
    trigger:'button:contains("Login")',
},{
    content:"expecttotpscreen",
    trigger:'label:contains(AuthenticationCode)',
},{
    content:"inputcode",
    trigger:'input[name=totp_token]',
    run:asyncfunction(helpers){
        consttoken=awaitajax.jsonRpc('/totphook','call',{});
        helpers._text(helpers._get_action_values(),token);
        //FIXME:isthereawaytoputthebuttonasitsownsteptriggerwithout
        //       thetourstraightblowingthroughandnotwaitingforthis?
        helpers._click(helpers._get_action_values('button:contains("Verify")'));
    }
},{
    content:"checkwe'reloggedin",
    trigger:"h3:contains(Documents)",
    run:()=>{}
},{
    content:"gobacktosecurity",
    trigger:"a:contains(Security)",
},{
    content:"Opentotpwizard",
    trigger:'button#auth_totp_portal_disable',
},{
    content:"Checkthatwehavetoenterenhancedsecuritymode",
    trigger:'div:contains("confirmyourpassword")',
    run:()=>{},
},{
    content:"Inputpassword",
    trigger:'[name=password]',
    run:'textportal',//FIXME:betterwaytodothis?
},{
    content:"Confirm",
    trigger:"button:contains(ConfirmPassword)",
},{
    content:"Checkthatthebuttonhaschanged",
    trigger:'button:contains(Enabletwo-factorauthentication)',
    run:()=>{}
}]);

tour.register('totportal_login_disabled',{
    test:true,
    url:'/'
},[{
    content:"checkthatwe'reontheloginpageorgotoit",
    trigger:'input#login,a:contains(Signin)'
},{
    content:"inputlogin",
    trigger:'input#login',
    run:'textportal',
},{
    content:'inputpassword',
    trigger:'input#password',
    run:'textportal',
},{
    content:"clickdabutton",
    trigger:'button:contains("Login")',
},{
    content:"checkwe'reloggedin",
    trigger:"h3:contains(Documents)",
    run:()=>{}
}]);
});
