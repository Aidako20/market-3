flectra.define('auth_totp.tours',function(require){
"usestrict";

consttour=require('web_tour.tour');
constajax=require('web.ajax');

functionopenRoot(){
    return[{
        content:"returntoclientroottoavoidracecondition",
        trigger:'body',
        run(){
            $('body').addClass('wait');
            window.location='/web';
        }
    },{
        content:"waitforclientreload",
        trigger:'body:not(.wait)',
        run(){}
    }];
}
functionopenUserProfileAtSecurityTab(){
    return[{
        content:'Openuseraccountmenu',
        trigger:'.o_user_menu.oe_topbar_name',
        run:'click',
    },{
        content:"Openpreferences/profilescreen",
        trigger:'[data-menu=settings]',
        run:'click',
    },{
        content:"Switchtosecuritytab",
        trigger:'a[role=tab]:contains("AccountSecurity")',
        run:'click',
    }];
}

tour.register('totp_tour_setup',{
    test:true,
    url:'/web'
},[...openUserProfileAtSecurityTab(),{
    content:"Opentotpwizard",
    trigger:'button[name=totp_enable_wizard]',
},{
    content:"Checkthatwehavetoenterenhancedsecuritymode",
    trigger:'div:contains("confirmyourpassword")',
    run:()=>{},
},{
    content:"Inputpassword",
    trigger:'[name=password]',
    run:'textdemo',//FIXME:betterwaytodothis?
},{
    content:"Confirm",
    trigger:"button:contains(ConfirmPassword)",
},{
    content:"Checkthewizardhasopened",
    trigger:'div:contains("Scantheimagebelow")',
    run:()=>{}
},{
    content:"Getsecretfromcollapseddiv",
    trigger:'a:contains("showthecode")',
    run(helpers){
        constsecret=this.$anchor.closest('div').find('code').text();
        ajax.jsonRpc('/totphook','call',{
            secret
        }).then((token)=>{
            helpers._text(helpers._get_action_values('input[name=code]'),token);
            helpers._click(helpers._get_action_values('button.btn-primary:contains(Enable)'));
            $('body').addClass('got-token')
        });
    }
},{
    content:'waitforrpc',
    trigger:'body.got-token',
    run(){}
},
...openRoot(),
...openUserProfileAtSecurityTab(),
{
    content:"Checkthatthebuttonhaschanged",
    trigger:'button:contains(Disabletwo-factorauthentication)',
    run:()=>{}
}]);

tour.register('totp_login_enabled',{
    test:true,
    url:'/'
},[{
    content:"checkthatwe'reontheloginpageorgotoit",
    trigger:'input#login,a:contains(Signin)'
},{
    content:"inputlogin",
    trigger:'input#login',
    run:'textdemo',
},{
    content:'inputpassword',
    trigger:'input#password',
    run:'textdemo',
},{
    content:"clickdabutton",
    trigger:'button:contains("Login")',
},{
    content:"expecttotpscreen",
    trigger:'label:contains(AuthenticationCode)',
},{
    content:"inputcode",
    trigger:'input[name=totp_token]',
    run(helpers){
        ajax.jsonRpc('/totphook','call',{}).then((token)=>{
            helpers._text(helpers._get_action_values(),token);
            //FIXME:isthereawaytoputthebuttonasitsownsteptriggerwithout
            //       thetourstraightblowingthroughandnotwaitingforthis?
            helpers._click(helpers._get_action_values('button:contains("Verify")'));
        });
    }
},{
    content:"checkwe'reloggedin",
    trigger:".o_user_menu.oe_topbar_name",
    run:()=>{}
}]);

tour.register('totp_login_device',{
    test:true,
    url:'/'
},[{
    content:"checkthatwe'reontheloginpageorgotoit",
    trigger:'input#login,a:contains(Signin)'
},{
    content:"inputlogin",
    trigger:'input#login',
    run:'textdemo',
},{
    content:'inputpassword',
    trigger:'input#password',
    run:'textdemo',
},{
    content:"clickdabutton",
    trigger:'button:contains("Login")',
},{
    content:"expecttotpscreen",
    trigger:'label:contains(AuthenticationCode)',
},{
    content:"checkrememberdevicebox",
    trigger:'label[for=switch-remember]',
},{
    content:"inputcode",
    trigger:'input[name=totp_token]',
    run(helpers){
        ajax.jsonRpc('/totphook','call',{}).then((token)=>{
            helpers._text(helpers._get_action_values(),token);
            //FIXME:isthereawaytoputthebuttonasitsownsteptriggerwithout
            //       thetourstraightblowingthroughandnotwaitingforthis?
            helpers._click(helpers._get_action_values('button:contains("Verify")'));
        });
    }
},{
    content:"checkwe'reloggedin",
    trigger:".o_user_menu.oe_topbar_name",
    run:()=>{}
},{
    content:"clickontheuser",
    trigger:'li[class=o_user_menu]>a',
},{
    content:"clicktheLogoutbutton",
    trigger:'a[data-menu=logout]',
},{
    content:"checkthatwe'rebackontheloginpageorgotoit",
    trigger:'input#login,a:contains(Login)'
},{
    content:"inputloginagain",
    trigger:'input#login',
    run:'textdemo',
},{
    content:'inputpasswordagain',
    trigger:'input#password',
    run:'textdemo',
},{
    content:"clickdabuttonagain",
    trigger:'button:contains("Login")',
}, {
    content:"checkwe'reloggedinwithout2FA",
    trigger:".o_user_menu.oe_topbar_name",
    run:()=>{}
},
//nowgoanddisabletotpwouldbeannoyingtodoinaseparatetour
//becausewe'dneedtologin&totpagainasHttpCase.authenticatecan't
//succeedw/totpenabled
...openUserProfileAtSecurityTab(),
{
    content:"Opentotpwizard",
    trigger:'button[name=totp_disable]',
},{
    content:"Checkthatwehavetoenterenhancedsecuritymode",
    trigger:'div:contains("confirmyourpassword")',
    run:()=>{},
},{
    content:"Inputpassword",
    trigger:'[name=password]',
    run:'textdemo',//FIXME:betterwaytodothis?
},{
    content:"Confirm",
    trigger:"button:contains(ConfirmPassword)",
},
...openRoot(),
...openUserProfileAtSecurityTab(),
{
    content:"Checkthatthebuttonhaschanged",
    trigger:'button:contains(Enabletwo-factorauthentication)',
    run:()=>{}
}]);

tour.register('totp_login_disabled',{
    test:true,
    url:'/'
},[{
    content:"checkthatwe'reontheloginpageorgotoit",
    trigger:'input#login,a:contains(Signin)'
},{
    content:"inputlogin",
    trigger:'input#login',
    run:'textdemo',
},{
    content:'inputpassword',
    trigger:'input#password',
    run:'textdemo',
},{
    content:"clickdabutton",
    trigger:'button:contains("Login")',
},
//normallywe'dendthetourhereasit'sallwecareaboutbuttherearea
//bunchofongoingqueriesfromtheloadingofthewebclientwhichcause
//issues,sogoandopenthepreferences/profilescreentomakesure
//everythingsettlesdown
...openUserProfileAtSecurityTab(),
]);

constcolumns={};
tour.register('totp_admin_disables',{
    test:true,
    url:'/web'
},[tour.stepUtils.showAppsMenuItem(),{
    content:'Gotosettings',
    trigger:'[data-menu-xmlid="base.menu_administration"]'
},{
    content:'Waitforpage',
    trigger:'.o_menu_brand:contains("Settings")',
    run:()=>{}
},{
    content:"OpenUsersmenu",
    trigger:'[data-menu-xmlid="base.menu_users"]'
},{
    content:"OpenUsersview",
    trigger:'[data-menu-xmlid="base.menu_action_res_users"]',
    run:function(helpers){
        //funnystory:theusersviewwe'retryingtoreach,sometimeswe're
        //alreadythere,butifwere-clickthenextstepexecutesbeforethe
        //actionhasthetimetore-load,theoneafterthatdoesn't,andour
        //selectiongetdiscardedbytheactionreloading,soheretryto
        //seeifwe'realreadyontheusersactionthroughthebreadcrumband
        //justclosethemenuifso
        const$crumb=$('.breadcrumb');
        if($crumb.text().indexOf('Users')===-1){
            //ongeneralsettingspage,clickmenu
            helpers.click();
        }else{
            //elseclosemenu
            helpers.click($('[data-menu-xmlid="base.menu_users"]'));
        }
    }
},{
    content:"FindDemoUser",
    trigger:'td.o_data_cell:contains("demo")',
    run:function(helpers){
        const$titles=this.$anchor.closest('table').find('tr:firstth');
        for(leti=0;i<$titles.length;++i){
            columns[$titles[i].getAttribute('data-name')]=i;
        }
        const$row=this.$anchor.closest('tr');
        constsel=$row.find('.o_list_record_selectorinput[type=checkbox]');
        consttotp=$row[0].children[columns['totp_enabled']].querySelector('input');
        if(totp.checked){
            helpers.click(sel);
        }
    }
},{
    content:"OpenActionsmenu",
    trigger:'button.o_dropdown_toggler_btn:contains("Action")'
},{
    content:"Selecttotpremover",
    trigger:'a.dropdown-item:contains(DisableTOTPonusers)'
},{//enhancedsecurityyo
    content:"Checkthatwehavetoenterenhancedsecuritymode",
trigger:'div:contains("confirmyourpassword")',
    run:()=>{},
},{
    content:"Inputpassword",
    trigger:'[name=password]',
    run:'textadmin',//FIXME:betterwaytodothis?
},{
    content:"Confirm",
    trigger:"button:contains(ConfirmPassword)",
},{
    content:"checkthatdemouserhasbeende-totp'd",
    trigger:"td.o_data_cell:contains(demo)",
    run:function(){
        consttotpcell=this.$anchor.closest('tr')[0].children[columns['totp_enabled']];
        if(totpcell.querySelector('input').checked){
            thrownewError("totpshouldhavebeendisabledondemouser");
        }
    }
}])
});
