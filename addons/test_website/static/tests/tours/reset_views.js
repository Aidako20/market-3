flectra.define('test_website.reset_views',function(require){
'usestrict';

vartour=require("web_tour.tour");

varBROKEN_STEP={
    //becausesavingabrokentemplateopensarecoverypagewithnoassets
    //there'snowayforthetourtoresumeonthenewpage,andthusnoway
    //toproperlywaitforthepagetobesaved&reloadedinordertofixthe
    //raceconditionofatourendingonaside-effect(withthepossible
    //exceptionofsomehowtellingtheharness/browsertodoit)
    trigger:'body',
    run:function(){}
};
tour.register('test_reset_page_view_complete_flow_part1',{
    test:true,
    url:'/test_page_view',
},
    [
        //1.EditthepagethroughEditMode,itwillCOWtheview
        {
            content:"entereditmode",
            trigger:"a[data-action=edit]"
        },
        {
            content:"dropasnippet",
            trigger:"#oe_snippets.oe_snippet:has(.s_cover).oe_snippet_thumbnail",
            //idstartingby'oe_structure..'willactuallycreateaninheritedview
            run:"drag_and_drop#oe_structure_test_website_page",
        },
        {
            content:"savethepage",
            extra_trigger:'#oe_structure_test_website_page.o_dirty',
            trigger:"button[data-action=save]",
        },
        //2.EditthatCOW'dviewintheHTMLeditortobreakit.
        {
            content:"opencustomizemenu",
            extra_trigger:"body:not(.editor_enable)",
            trigger:'#customize-menu>a',
        },
        {
            content:"openhtmleditor",
            trigger:'#html_editor',
        },
        {
            content:"addabrokent-fieldinpageDOM",
            trigger:'div.ace_line.ace_xml:contains("placeholder")',
            run:function(){
                ace.edit('ace-view-editor').getSession().insert({row:4,column:1},'<tt-field="not.exist"/>\n');
            },
        },
        {
            content:"savethehtmleditor",
            extra_trigger:'.ace_content:contains("not.exist")',
            trigger:".o_ace_view_editorbutton[data-action=save]",
        },
        BROKEN_STEP
    ]
);

tour.register('test_reset_page_view_complete_flow_part2',{
    test:true,
    url:'/test_page_view',
},
    [
        {
            content:"checkthattheviewgotfixed",
            trigger:'p:containsExact("TestPageView")',
            run:function(){},//it'sacheck
        },
        {
            content:"checkthattheinheritedCOWviewisstillthere(createdduringeditmode)",
            trigger:'#oe_structure_test_website_page.s_cover',
            run:function(){},//it'sacheck
        },
        //4.Nowbreaktheinheritedviewcreatedwhendroppingasnippet
        {
            content:"opencustomizemenu",
            trigger:'#customize-menu>a',
        },
        {
            content:"openhtmleditor",
            trigger:'#html_editor',
        },
        {
            content:"selectoe_structureview",
            trigger:'#s2id_ace-view-list', //useselect2version
            run:function(){
                varviewId=$('#ace-view-listoption:contains("oe_structure_test_website_page")').val();
                $('#ace-view-list').val(viewId).trigger('change');
            },
        },
        {
            content:"addabrokent-fieldinpageDOM",
            trigger:'div.ace_line.ace_xml:contains("oe_structure_test_website_page")',
            run:function(){
                ace.edit('ace-view-editor').getSession().insert({row:4,column:1},'<tt-field="not.exist"/>\n');
            },
        },
        {
            content:"savethehtmleditor",
            trigger:".o_ace_view_editorbutton[data-action=save]",
        },
        BROKEN_STEP
    ]
);

});
