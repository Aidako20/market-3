<?xmlversion="1.0"encoding="utf-8"?>
<flectra>

    <!--thisheadercanbeusedonanyChileanreport-->
    <templateid="custom_header">

        <tt-set="report_date"t-value="o.invoice_date"/>
        <tt-set="report_number"t-value="int(o.l10n_latam_document_number)"/>
        <tt-set="pre_printed_report"t-value="report_type=='pdf'"/>
        <tt-set="report_name"t-value="o.l10n_latam_document_type_id.name"/>
        <tt-set="header_address"t-value="o.company_id.partner_id"/>
        <tt-set="custom_footer">
            <tt-call="l10n_cl.custom_footer"/>
        </t>

        <div>
            <divclass="row">
                <divname="left-upper-side"class="col-8">
                    <imgt-if="o.company_id.logo"t-att-src="image_data_uri(o.company_id.logo)"
                         style="max-height:45px;"alt="Logo"/>
                    <br/>
                    <strong>
                        <spant-field="o.company_id.partner_id.name"/>
                    </strong>
                    <br/>
                    <spanname="company_activity"class="font-italic"t-field="o.company_id.report_header"/>
                    <div/>
                    <tt-esc="'-'.join([itemforitemin[
                        ','.join([itemforitemin[header_address.street,header_address.street2]ifitem]),
                        header_address.city,
                        header_address.state_idandheader_address.state_id.name,
                        header_address.zip,
                        header_address.country_idandheader_address.country_id.name]ifitem])"/>
                    <spant-if="header_address.phone">
                        <br/>
                    </span>
                    <spant-if="header_address.phone"style="white-space:nowrap;"
                          t-esc="'Tel:'+header_address.phone"/>
                    <spant-if="header_address.website">
                        <spant-att-style="'color:%s;'%o.company_id.primary_color"
                              t-esc="'-Web:%s'%'-'.join([itemforitemin[header_address.website.replace('https://','').replace('http://',''),header_address.email]ifitem])"/>
                    </span>
                </div>
                <divname="right-upper-side"class="col-4">
                    <divclass="row">
                        <divname="right-upper-side"class="col-12">
                            <divclass="rowborderborder-dark">
                                <divclass="col-12text-center">
                                    <h6t-att-style="'color:%s;'%o.company_id.primary_color">
                                        <strongt-att-style="'color:%s;'%o.company_id.primary_color">
                                            <br/>
                                            <spanstyle="line-height:180%;">RUT:</span>
                                            <tt-if="o.company_id.partner_id.vat">
                                                <spant-esc="o.company_id.partner_id._format_dotted_vat_cl(o.company_id.partner_id.vat)"/>
                                            </t>
                                            <br/>
                                            <spanclass="text-uppercase"t-esc="report_name"/>
                                            <br/>
                                            <span>NÂº:</span>
                                            <spanstyle="line-height:200%;"t-esc="report_number"/>
                                        </strong>
                                    </h6>
                                </div>
                            </div>
                            <divclass="rowtext-center">
                                <divclass="col-12text-center"t-att-style="'color:%s;'%o.company_id.primary_color"
                                     name="regional-office"/>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </template>


    <templateid="informations">
        <divid="informations"class="rowmt8mb8">
            <divclass="col-6">
                <strong>
                    <spant-att-style="'color:%s;'%o.company_id.secondary_color">Date:</span>
                </strong>
                <spant-esc="o.invoice_date"t-options='{"widget":"date"}'/>
                <br/>

                <strong>Customer:</strong>
                <spant-field="o.partner_id.name"/>
                <br/>

                <tt-if="o.partner_id.vatando.partner_id.l10n_latam_identification_type_id">
                    <strong>
                        <tt-esc="o.partner_id.l10n_latam_identification_type_id.nameoro.company_id.country_id.vat_label"id="inv_tax_id_label"/>:
                    </strong>
                    <spant-esc="o.partner_id.vat"/>
                    <br/>
                </t>
                <strong>GIRO:</strong>
                <spant-esc="o.partner_id.industry_id.nameor''"/>
                <br/>
            </div>
            <divclass="col-6">
                <strong>DueDate:</strong>
                <spant-esc="o.invoice_date_due"t-options='{"widget":"date"}'/>
                <br/>
                <strong>Address:</strong>
                <spant-field="o.partner_id"
                      t-options="{'widget':'contact','fields':['address'],'no_marker':true,'no_tag_br':True}"/>

                <strong>PaymentTerms:</strong>
                <spant-esc="o.invoice_payment_term_id.nameor''"/>


                <tt-if="o.invoice_incoterm_id">
                    <br/>
                    <strong>Incoterm:</strong>
                    <spant-field="o.invoice_incoterm_id.name"/>
                </t>

            </div>
        </div>
        <divid="references"class="row">
            <divname="references"class="col-12text-center"/>
        </div>
    </template>

    <templateid="custom_footer">
        <divname="footer_left_column"class="col-8text-center"/>
    </template>

    <templateid="report_invoice_document"inherit_id="account.report_invoice_document"primary="True">

        <tt-set="o"position="after">
            <tt-set="custom_header"t-value="'l10n_cl.custom_header'"/>
        </t>

        <!--removedefaultpartneraddress-->
        <tt-set="address"position="replace"/>

        <xpathexpr="//h2"position="replace"/>

        <xpathexpr="//span[@t-field='line.price_unit']"position="attributes">
            <attributename="t-field">line.l10n_latam_price_unit</attribute>
        </xpath>

        <xpathexpr="//span[@id='line_tax_ids']"position="attributes">
            <attributename="t-esc">','.join(map(lambdax:(x.descriptionorx.name),line.l10n_latam_tax_ids))</attribute>
        </xpath>

        <tt-set="current_subtotal"t-value="current_subtotal+line.price_subtotal"position="attributes">
            <attributename="t-value">current_subtotal+line.l10n_latam_price_subtotal</attribute>
        </t>

        <xpathexpr="//th[@name='th_subtotal']/span[@groups='account.group_show_line_subtotals_tax_included']"position="replace">
            <spangroups="account.group_show_line_subtotals_tax_included">Amount</span>
        </xpath>

        <spant-field="line.price_subtotal"position="attributes">
            <attributename="t-field">line.l10n_latam_price_subtotal</attribute>
        </span>

        <spant-field="o.amount_untaxed"position="attributes">
            <attributename="t-field">o.l10n_latam_amount_untaxed</attribute>
        </span>

        <xpathexpr="//th[@name='th_taxes']"position="replace"/>
        <xpathexpr="//span[@id='line_tax_ids']/.."position="replace"/>

        <pname="payment_term"position="replace"/>
        <xpathexpr="//span[@t-field='o.payment_reference']/../.."position="replace"/>

        <!--replaceinformationsectionandusagechileanstyle-->
        <divid="informations"position="replace">
            <tt-call="l10n_cl.informations"/>
        </div>

        <!-- weremovethemlautoandalsogivemorespacetoavoidmultiplelinesontaxdetail-->
        <xpathexpr="//div[@id='total']/div"position="attributes">
            <attributename="t-attf-class">#{'col-6'ifreport_type!='html'else'col-sm-7col-md-6'}</attribute>
        </xpath>

        <xpathexpr="//div[@id='total']/div"position="before">
            <divt-attf-class="#{'col-6'ifreport_type!='html'else'col-sm-7col-md-6'}"/>
        </xpath>

        <xpathexpr="//div[@id='total']"position="after">
            <divclass="row">
                <divname="stamp"class="col-4text-center"/>
                <divname="transferable-table"class="col-4"/>
                <divname="transferable-legend"class="col-4pull-right"/>
            </div>
        </xpath>

    </template>

    <!--FIXME:Tempfixtoallowfetchinginvoice_documemtinStudioReportswithlocalisation-->
    <templateid="report_invoice"inherit_id="account.report_invoice">
        <xpathexpr='//t[@t-call="account.report_invoice_document"]'position="after">
            <tt-if="o._get_name_invoice_report()=='l10n_cl.report_invoice_document'"
                t-call="l10n_cl.report_invoice_document"t-lang="lang"/>
        </xpath>
    </template>

    <templateid="report_invoice_with_payments"inherit_id="account.report_invoice_with_payments">
        <xpathexpr='//t[@t-call="account.report_invoice_document"]'position="after">
            <tt-if="o._get_name_invoice_report()=='l10n_cl.report_invoice_document'"
                t-call="l10n_cl.report_invoice_document"t-lang="lang"/>
        </xpath>
    </template>

</flectra>
