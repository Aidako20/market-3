flectra.define('web_unsplash.image_widgets',function(require){
'usestrict';

varcore=require('web.core');
varUnsplashAPI=require('unsplash.api');
varwidgetsMedia=require('wysiwyg.widgets.media');

varunsplashAPI=null;

//Preventbaseclassfromtreatingunsplashimageslikeregularattachments
constoriginalEvents=widgetsMedia.ImageWidget.prototype.events;
constclickHandler=originalEvents['click.o_existing_attachment_cell'];
if(!clickHandler){
    thrownewError(`Couldn'tfindahandlerforo_existing_attachment_cellclicks.
Theunsplashimagewidgetneedstopreventthishandlerfromexecutingonunsplashattachments.`);
}
_.extend(originalEvents,{
    'click.o_existing_attachment_cell:not(.o_unsplash_attachment_cell)':clickHandler,
});
deleteoriginalEvents['click.o_existing_attachment_cell'];

widgetsMedia.ImageWidget.include({
    xmlDependencies:widgetsMedia.ImageWidget.prototype.xmlDependencies.concat(
        ['/web_unsplash/static/src/xml/unsplash_image_widget.xml']
    ),
    events:_.extend({},widgetsMedia.ImageWidget.prototype.events,{
        'click.o_unsplash_attachment_cell[data-imgid]':'_onUnsplashImgClick',
        'clickbutton.save_unsplash':'_onSaveUnsplashCredentials',
    }),

    /**
     *@override
     */
    init:function(){
        this._super.apply(this,arguments);

        this._unsplash={
            selectedImages:{},
            isMaxed:false,
            query:false,
            error:false,
            records:[],
        };

        //TODOimprovethis
        //
        //Thisisa`hack`topreventtheUnsplashAPItobedestroyedevery
        //timethemediadialogisclosed.Indeed,UnsplashAPIhasacache
        //systemtorecudeunsplashcall,itisthenbettertokeepitsstate
        //totakeadvantagefromitfromonemediadialogcalltoanother.
        //
        //UnsplashAPIwilleitherbe(it'sstillbeingdiscussed):
        // *aservice(ideallycomingwithanimprovementtonotautoload
        //   theservice)
        // *initializedinthewebsite_root(trigger_up)
        if(unsplashAPI===null){
            this.unsplashAPI=newUnsplashAPI(this);
            unsplashAPI=this.unsplashAPI;
        }else{
            this.unsplashAPI=unsplashAPI;
            this.unsplashAPI.setParent(this);
        }
    },
    /**
     *@override
     */
    destroy:function(){
        //TODOSee`hack`explainedin`init`.Thispreventthemediadialogdestroy
        //     todestroyunsplashAPIwhendestroyingthechildren
        this.unsplashAPI.setParent(undefined);
        this._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Public
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _save:asyncfunction(){
        const_super=this._super;
        if(Object.keys(this._unsplash.selectedImages).length){
            this.saved=true;
            constimages=awaitthis._rpc({
                route:'/web_unsplash/attachment/add',
                params:{
                    unsplashurls:this._unsplash.selectedImages,
                    res_model:this.options.res_model,
                    res_id:this.options.res_id,
                    query:this._unsplash.query,
                },
            });
            this.attachments.push(...images);
            this.selectedAttachments.push(...images);
        }
        return_super.apply(this,arguments);
    },
    /**
     *@override
     */
    search:asyncfunction(needle){
        varself=this;
        awaitthis._super(...arguments);

        this._unsplash.query=needle;
        if(!needle){
            this._unsplash.records=[];
            return;
        }

        awaitthis.unsplashAPI.getImages(needle,this.numberOfAttachmentsToDisplay).then(function(res){
            self._unsplash.isMaxed=res.isMaxed;
            self._unsplash.records=res.images;
            self._unsplash.error=false;
        },function(err){
            self._unsplash.error=err;
        });
    },
    /**
     *@override
     */
    hasContent(){
        if(this.searchService==='all'){
            returnthis._super(...arguments)||(this.unsplashRecords&&this.unsplashRecords.length);
        }elseif(this.searchService==='unsplash'){
            return(this.unsplashRecords&&this.unsplashRecords.length);
        }
        returnthis._super(...arguments);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _highlightSelected:function(){
        this._super.apply(this,arguments);

        const$select=this.$('.o_unsplash_attachment_cell[data-imgid]').filter((i,el)=>{
            return$(el).data('imgid')inthis._unsplash.selectedImages;
        }).addClass('o_we_attachment_selected');
        return$select;
    },
    /**
     *@private
     */
    _loadMoreImages:function(forceSearch){
        if(!this.$('.o_we_search').val()){
            returnthis._super(forceSearch);
        }
        this.numberOfAttachmentsToDisplay+=10;
        this.search(this.$('.o_we_search').val()).then(()=>this._renderThumbnails());
    },
    /**
     *@override
     */
    _renderThumbnails:function(){
        this._super(...arguments);
        this.$('.unsplash_error').empty();
        if(!['all','unsplash'].includes(this.searchService)){
            return;
        }
        if(this._unsplash.query&&this._unsplash.error){
            this.$('.unsplash_error').html(
                core.qweb.render('web_unsplash.dialog.error.content',{
                    status:this._unsplash.error,
                })
            );
            return;
        }

        if(['all','unsplash'].includes(this.searchService)&&this._unsplash.query&&!this._unsplash.isMaxed){
            this.$('.o_load_more').removeClass('d-none');
            this.$('.o_load_done_msg').addClass('d-none');
        }
    },
    /**
     *@override
     */
    _renderExisting:function(attachments){
        this.unsplashRecords=this._unsplash.records.map(record=>{
            consturl=newURL(record.urls.regular);
            //Insmallwindows,rowheightcouldgetquiteabitlargerthanthemin,sowekeepsomeleeway.
            url.searchParams.set('h',2*this.MIN_ROW_HEIGHT);
            url.searchParams.delete('w');
            returnObject.assign({},record,{
                url:url.toString(),
            });
        });
        returnthis._super(...arguments);
    },
    /**
     *@override
     */
    _selectAttachement:function(attachment,save){
        if(!this.options.multiImages){
            this._unsplash.selectedImages={};
        }
        this._super(...arguments);
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _onSaveUnsplashCredentials:function(){
        varself=this;
        varkey=this.$('#accessKeyInput').val().trim();
        varappId=this.$('#appIdInput').val().trim();

        this.$('#accessKeyInput').toggleClass('is-invalid',!key);
        this.$('#appIdInput').toggleClass('is-invalid',!appId);

        if(key&&appId){
            if(!this.$el.find('.is-invalid').length){
                this._rpc({
                    route:'/web_unsplash/save_unsplash',
                    params:{key:key,appId:appId},
                }).then(function(){
                    self.unsplashAPI.clientId=key;
                    self._unsplash.error=false;
                    self.search(self._unsplash.query).then(()=>self._renderThumbnails());
                });
            }
        }
    },
    /**
     *@private
     */
    _onUnsplashImgClick:function(ev){
        if(this.saved){
            //alreadysaved,probablyadoubleclick.Ignore.
            return;
        }
        const{imgid,url,downloadUrl,description}=ev.currentTarget.dataset;
        if(!this.options.multiImages){
            this._unsplash.selectedImages={};
            this.selectedAttachments=[];
        }
        if(imgidinthis._unsplash.selectedImages){
            deletethis._unsplash.selectedImages[imgid];
        }else{
            const_1920Url=newURL(url);
            _1920Url.searchParams.set('w','1920');
            this._unsplash.selectedImages[imgid]={url:_1920Url.href,download_url:downloadUrl,description:description};
        }
        this._highlightSelected();
        if(!this.options.multiImages){
            this.trigger_up('save_request');
        }
    },
});
});
