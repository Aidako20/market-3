flectra.define('website.s_popup_options',function(require){
'usestrict';

constoptions=require('web_editor.snippets.options');

options.registry.SnippetPopup=options.Class.extend({
    /**
     *@override
     */
    start:function(){
        //Note:thelinkareexcludedheresothatinternalmodalbuttonsdo
        //notclosethepopupaswewanttoalloweditionofthosebuttons.
        this.$target.on('click.SnippetPopup','.js_close_popup:not(a,.btn)',ev=>{
            ev.stopPropagation();
            this.onTargetHide();
        });
        this.$target.on('shown.bs.modal.SnippetPopup',()=>{
            this.trigger_up('snippet_option_visibility_update',{show:true});
            //TODOduplicatedcodefromthepopuppublicwidget,thisshould
            //bemovedtoa*video*publicwidgetandbereviewedinmaster
            this.$target[0].querySelectorAll('.media_iframe_video').forEach(media=>{
                constiframe=media.querySelector('iframe');
                iframe.src=media.dataset.oeExpression||media.dataset.src;//TODOstilloeExpressiontoremovesomeday
            });
        });
        this.$target.on('hide.bs.modal.SnippetPopup',()=>{
            this.trigger_up('snippet_option_visibility_update',{show:false});
            this._removeIframeSrc();
        });
        //Thevideomightbeplayingbeforeenteringeditmode(possiblywith
        //sound).Stopthevideo,astheusercan'tdoit(nobuttononvideo
        //ineditmode).
        this._removeIframeSrc();
        returnthis._super(...arguments);
    },
    /**
     *@override
     */
    destroy:function(){
        this._super(...arguments);
        //Thevideoshouldnotstartbeforethemodalopens,removeitfromthe
        //DOM.Itwillbeaddedbackonmodalopentostartthevideo.
        this._removeIframeSrc();
        this.$target.off('.SnippetPopup');
    },
    /**
     *@override
     */
    onBuilt:function(){
        this._assignUniqueID();
    },
    /**
     *@override
     */
    onClone:function(){
        this._assignUniqueID();
    },
    /**
     *@override
     */
    onTargetShow:asyncfunction(){
        this.$target.modal('show');
        $(document.body).children('.modal-backdrop:last').addClass('d-none');
    },
    /**
     *@override
     */
    onTargetHide:asyncfunction(){
        returnnewPromise(resolve=>{
            consttimeoutID=setTimeout(()=>{
                this.$target.off('hidden.bs.modal.popup_on_target_hide');
                resolve();
            },500);
            this.$target.one('hidden.bs.modal.popup_on_target_hide',()=>{
                clearTimeout(timeoutID);
                resolve();
            });
            this.$target.modal('hide');
        });
    },
    /**
     *@override
     */
    cleanForSave:function(){
        this.$target.removeClass("s_popup_overflow_page");
    },

    //--------------------------------------------------------------------------
    //Options
    //--------------------------------------------------------------------------

    /**
     *Movesthesnippetinfootertobecommontoallpages
     *orinsidewraptobeononepageonly
     *
     *@seethis.selectClassforparameters
     */
    moveBlock:function(previewMode,widgetValue,params){
        const$container=$(widgetValue==='moveToFooter'?'footer#bottom':'main');
        this.$target.closest('.s_popup').prependTo($container.find('.oe_structure:o_editable').first());
    },
    /**
     *@seethis.selectClassforparameters
     */
    setBackdrop(previewMode,widgetValue,params){
        constcolor=widgetValue?'var(--black-50)':'';
        this.$target[0].style.setProperty('background-color',color,'important');
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *CreatesauniqueID.
     *
     *@private
     */
    _assignUniqueID:function(){
        this.$target.closest('.s_popup').attr('id','sPopup'+Date.now());
    },
    /**
     *@override
     */
    _computeWidgetState:function(methodName,params){
        switch(methodName){
            case'moveBlock':
                returnthis.$target.closest('footer#bottom').length?'moveToFooter':'moveToBody';
        }
        returnthis._super(...arguments);
    },
    /**
     *Removestheiframe`src`attribute(acopyofthesrcisalreadyonthe
     *parent`oe-expression`attribute).
     *
     *@private
     */
    _removeIframeSrc(){
        this.$target.find('.media_iframe_videoiframe').each((i,iframe)=>{
            iframe.src='';
        });
    },
});
});
