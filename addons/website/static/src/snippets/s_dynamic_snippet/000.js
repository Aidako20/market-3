flectra.define('website.s_dynamic_snippet',function(require){
'usestrict';

constcore=require('web.core');
constconfig=require('web.config');
constpublicWidget=require('web.public.widget');

constDynamicSnippet=publicWidget.Widget.extend({
    selector:'.s_dynamic_snippet',
    xmlDependencies:['/website/static/src/snippets/s_dynamic_snippet/000.xml'],
    read_events:{
        'click[data-url]':'_onCallToAction',
    },
    disabledInEditableMode:false,

    /**
     *
     *@override
     */
    init:function(){
        this._super.apply(this,arguments);
        /**
         *Thedynamicfilterdatasourcedataformattedwiththechosentemplate.
         *Canbeaccessedwhenoverridingthe_render_content()functioninordertogenerate
         *anewrenderedContentfromtheoriginaldata.
         *
         *@type{*|jQuery.fn.init|jQuery|HTMLElement}
         */
        this.data=[];
        this.renderedContent='';
        this.isDesplayedAsMobile=config.device.isMobile;
        this.uniqueId=_.uniqueId('s_dynamic_snippet_');
        this.template_key='website.s_dynamic_snippet.grid';
    },
    /**
     *
     *@override
     */
    willStart:function(){
        returnthis._super.apply(this,arguments).then(
            ()=>Promise.all([
                this._fetchData(),
                this._manageWarningMessageVisibility()
            ])
        );
    },
    /**
     *
     *@override
     */
    start:function(){
        returnthis._super.apply(this,arguments)
            .then(()=>{
                this._setupSizeChangedManagement(true);
                this._render();
                this._toggleVisibility(true);
            });
    },
    /**
     *
     *@override
     */
    destroy:function(){
        this._toggleVisibility(false);
        this._setupSizeChangedManagement(false);
        this._clearContent();
        this._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _clearContent:function(){
        const$templateArea=this.$el.find('.dynamic_snippet_template');
        this.trigger_up('widgets_stop_request',{
            $target:$templateArea,
        });
        $templateArea.html('');
    },
    /**
     *Methodtobeoverriddeninchildcomponentsifadditionalconfigurationelements
     *arerequiredinordertofetchdata.
     *@private
     */
    _isConfigComplete:function(){
        returnthis.$el.get(0).dataset.filterId!==undefined&&this.$el.get(0).dataset.templateKey!==undefined;
    },
    /**
     *Methodtobeoverriddeninchildcomponentsinordertoprovideasearch
     *domainifneeded.
     *@private
     */
    _getSearchDomain:function(){
        return[];
    },
    /**
     *Fetchesthedata.
     *@private
     */
    _fetchData:function(){
        if(this._isConfigComplete()){
            returnthis._rpc(
                {
                    'route':'/website/snippet/filters',
                    'params':{
                        'filter_id':parseInt(this.$el.get(0).dataset.filterId),
                        'template_key':this.$el.get(0).dataset.templateKey,
                        'limit':parseInt(this.$el.get(0).dataset.numberOfRecords),
                        'search_domain':this._getSearchDomain()
                    },
                })
                .then(
                    (data)=>{
                        this.data=data;
                    }
                );
        }else{
            returnnewPromise((resolve)=>{
                this.data=[];
                resolve();
            });
        }
    },
    /**
     *
     *@private
     */
    _mustMessageWarningBeHidden:function(){
        returnthis._isConfigComplete()||!this.editableMode;
    },
    /**
     *
     *@private
     */
    _manageWarningMessageVisibility:asyncfunction(){
        this.$el.find('.missing_option_warning').toggleClass(
            'd-none',
            this._mustMessageWarningBeHidden()
        );
    },
    /**
     *Methodtobeoverriddeninchildcomponentsinordertopreparecontent
     *beforerendering.
     *@private
     */
    _prepareContent:function(){
        if(this.$target[0].dataset.numberOfElements&&this.$target[0].dataset.numberOfElementsSmallDevices){
            this.renderedContent=core.qweb.render(
                this.template_key,
                this._getQWebRenderOptions());
        }else{
            this.renderedContent='';
        }
    },
    /**
     *MethodtobeoverriddeninchildcomponentsinordertoprepareQWeb
     *options.
     *
     *@private
     */
    _getQWebRenderOptions:function(){
        return{
            chunkSize:parseInt(
                config.device.isMobile
                    ?this.$target[0].dataset.numberOfElementsSmallDevices
                    :this.$target[0].dataset.numberOfElements
            ),
            data:this.data,
            uniqueId:this.uniqueId
        };
    },
    /**
     *
     *@private
     */
    _render:function(){
        if(this.data.length){
            this._prepareContent();
        }else{
            this.renderedContent='';
        }
        this._renderContent();
    },
    /**
     *@private
     */
    _renderContent:function(){
        const$templateArea=this.$el.find('.dynamic_snippet_template');
        this.trigger_up('widgets_stop_request',{
            $target:$templateArea,
        });
        $templateArea.html(this.renderedContent);
        //TODOthisisprobablynottheonlypublicwidgetwhichcreatesDOM
        //whichshouldbeattachedtoanotherpublicwidget.Maybeageneric
        //methodcouldbeaddedtoproperlydothisoperationofDOMaddition.
        this.trigger_up('widgets_start_request',{
            $target:$templateArea,
            editableMode:this.editableMode,
        });
    },
    /**
     *
     *@param{Boolean}enable
     *@private
     */
    _setupSizeChangedManagement:function(enable){
        if(enable===true){
            config.device.bus.on('size_changed',this,this._onSizeChanged);
        }else{
            config.device.bus.off('size_changed',this,this._onSizeChanged);
        }
    },
    /**
     *
     *@paramvisible
     *@private
     */
    _toggleVisibility:function(visible){
        this.$el.toggleClass('d-none',!visible);
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Navigatestothecalltoactionurl.
     *@private
     */
    _onCallToAction:function(ev){
        window.location=$(ev.currentTarget).attr('data-url');
    },
    /**
     *Calledwhenthesizehasreachedanewbootstrapbreakpoint.
     *
     *@private
     *@param{number}sizeasInteger@seeweb.config.device.SIZES
     */
    _onSizeChanged:function(size){
        if(this.isDesplayedAsMobile!==config.device.isMobile){
            this.isDesplayedAsMobile=config.device.isMobile;
            this._render();
        }
    },
});

publicWidget.registry.dynamic_snippet=DynamicSnippet;

returnDynamicSnippet;

});
