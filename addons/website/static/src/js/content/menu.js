flectra.define('website.content.menu',function(require){
'usestrict';

constconfig=require('web.config');
vardom=require('web.dom');
varpublicWidget=require('web.public.widget');
varwUtils=require('website.utils');
varanimations=require('website.content.snippets.animation');

constextraMenuUpdateCallbacks=[];

constBaseAnimatedHeader=animations.Animation.extend({
    disabledInEditableMode:false,
    effects:[{
        startEvents:'scroll',
        update:'_updateHeaderOnScroll',
    },{
        startEvents:'resize',
        update:'_updateHeaderOnResize',
    }],

    /**
     *@constructor
     */
    init:function(){
        this._super(...arguments);
        this.fixedHeader=false;
        this.scrolledPoint=0;
        this.hasScrolled=false;
        this.scrollHeightTooShort=false;
    },
    /**
     *@override
     */
    start:function(){
        this.$main=this.$el.next('main');
        this.isOverlayHeader=!!this.$el.closest('.o_header_overlay,.o_header_overlay_theme').length;
        this.$dropdowns=this.$el.find('.dropdown,.dropdown-menu');
        this.$navbarCollapses=this.$el.find('.navbar-collapse');

        //Whilescrollingthroughnavbarmenusonmediumdevices,bodyshouldnotbescrolledwithit
        this.$navbarCollapses.on('show.bs.collapse.BaseAnimatedHeader',function(){
            if(config.device.size_class<=config.device.SIZES.SM){
                $(document.body).addClass('overflow-hidden');
            }
        }).on('hide.bs.collapse.BaseAnimatedHeader',function(){
            $(document.body).removeClass('overflow-hidden');
        });

        //Wecanrelyontransitionendwhichiswellsupportedbutnoton
        //transitionstart,sowelistentoacustomflectraevent.
        this._transitionCount=0;
        this.$el.on('flectra-transitionstart.BaseAnimatedHeader',()=>{
            this.el.classList.add('o_transitioning');
            this._adaptToHeaderChangeLoop(1);
        });
        this.$el.on('transitionend.BaseAnimatedHeader',()=>this._adaptToHeaderChangeLoop(-1));

        returnthis._super(...arguments);
    },
    /**
     *@override
     */
    destroy:function(){
        this._toggleFixedHeader(false);
        this.$el.removeClass('o_header_affixedo_header_is_scrolledo_header_no_transitiono_transitioning');
        this.$navbarCollapses.off('.BaseAnimatedHeader');
        this.$el.off('.BaseAnimatedHeader');
        this._super(...arguments);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _adaptFixedHeaderPosition(){
        dom.compensateScrollbar(this.el,this.fixedHeader,false,'right');
    },
    /**
     *@private
     */
    _adaptToHeaderChange:function(){
        this._updateMainPaddingTop();
        //Takemenuintoaccountwhen`dom.scrollTo()`isusedwheneveritis
        //visible-beitfloating,fullydisplayedorpartiallyhidden.
        this.el.classList.toggle('o_top_fixed_element',this._isShown());

        for(constcallbackofextraMenuUpdateCallbacks){
            callback();
        }
    },
    /**
     *@private
     *@param{integer}[addCount=0]
     */
    _adaptToHeaderChangeLoop:function(addCount=0){
        this._adaptToHeaderChange();

        this._transitionCount+=addCount;
        this._transitionCount=Math.max(0,this._transitionCount);

        //Aslongaswedetectedatransitionstartwithoutitsrelated
        //transitionend,keepupdatingthemainpaddingtop.
        if(this._transitionCount>0){
            window.requestAnimationFrame(()=>this._adaptToHeaderChangeLoop());

            //Thenormalcasewouldbetohavethetransitionendeventtobe
            //firedbutwecannotrelyonit,soweuseatimeoutasfallback.
            if(addCount!==0){
                clearTimeout(this._changeLoopTimer);
                this._changeLoopTimer=setTimeout(()=>{
                    this._adaptToHeaderChangeLoop(-this._transitionCount);
                },500);
            }
        }else{
            //Whenwedetectedalltransitionendevents,weneedtostopthe
            //setTimeoutfallback.
            clearTimeout(this._changeLoopTimer);
            this.el.classList.remove('o_transitioning');
        }
    },
    /**
     *@private
     */
    _computeTopGap(){
        return0;
    },
    /**
     *@private
     */
    _isShown(){
        returntrue;
    },
    /**
     *@private
     *@param{boolean}[useFixed=true]
     */
    _toggleFixedHeader:function(useFixed=true){
        this.fixedHeader=useFixed;
        this._adaptToHeaderChange();
        this.el.classList.toggle('o_header_affixed',useFixed);
        this._adaptFixedHeaderPosition();
    },
    /**
     *@private
     */
    _updateMainPaddingTop:function(){
        this.headerHeight=this.$el.outerHeight();
        this.topGap=this._computeTopGap();

        if(this.isOverlayHeader){
            return;
        }
        this.$main.css('padding-top',this.fixedHeader?this.headerHeight:'');
    },
    /**
     *Checksifthesizeoftheheaderwilldecreasebyaddingthe
     *'o_header_is_scrolled'class.Ifso,wedonotaddthisclassifthe
     *remainingscrollheightisnotenoughtostayabove'this.scrolledPoint'
     *afterthetransition,otherwiseitcausesthescrollpositiontomoveup
     *againbelow'this.scrolledPoint'andtriggeraninfiniteloop.
     *
     *@todoheadereffectsshouldbeimprovedinthefuturetonoteverchange
     *thepagescroll-heightduringtheiranimation.Thecodewouldprobablybe
     *simplerbutalsopreventhavingweirdscroll"jumps"duringanimations
     *(=dependingonthelogoheightafter/beforescroll,ascrollstep(one
     *mousewheeleventforexample)canbebiggerthanotherones).
     *
     *@private
     *@returns{boolean}
     */
    _scrollHeightTooShort(){
        constscrollEl=$().getScrollingElement()[0];
        constremainingScroll=(scrollEl.scrollHeight-scrollEl.clientHeight)-this.scrolledPoint;
        constclonedHeader=this.el.cloneNode(true);
        scrollEl.append(clonedHeader);
        clonedHeader.classList.add('o_header_is_scrolled','o_header_affixed','o_header_no_transition');
        constendHeaderHeight=clonedHeader.offsetHeight;
        clonedHeader.remove();
        constheightDiff=this.headerHeight-endHeaderHeight;
        returnheightDiff>0?remainingScroll<=heightDiff:false;
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Calledwhenthewindowisscrolled
     *
     *@private
     *@param{integer}scroll
     */
    _updateHeaderOnScroll:function(scroll){
        //DisablecsstransitionifrefreshwithscrollTop>0
        if(!this.hasScrolled){
            this.hasScrolled=true;
            if(scroll>0){
                this.$el.addClass('o_header_no_transition');
            }
        }else{
            this.$el.removeClass('o_header_no_transition');
        }

        //Indicatesthepageisscrolled,thelogosizeischanged.
        constheaderIsScrolled=(scroll>this.scrolledPoint);
        if(this.headerIsScrolled!==headerIsScrolled){
            this.scrollHeightTooShort=headerIsScrolled&&this._scrollHeightTooShort();
            if(!this.scrollHeightTooShort){
                this.el.classList.toggle('o_header_is_scrolled',headerIsScrolled);
                this.$el.trigger('flectra-transitionstart');
                this.headerIsScrolled=headerIsScrolled;
            }
        }

        //Closeopenedmenus
        this.$dropdowns.removeClass('show');
        this.$navbarCollapses.removeClass('show').attr('aria-expanded',false);
    },
    /**
     *Calledwhenthewindowisresized
     *
     *@private
     */
    _updateHeaderOnResize:function(){
        this._adaptFixedHeaderPosition();
        if(document.body.classList.contains('overflow-hidden')
                &&config.device.size_class>config.device.SIZES.SM){
            document.body.classList.remove('overflow-hidden');
            this.$el.find('.navbar-collapse').removeClass('show');
        }
    },
});

publicWidget.registry.StandardAffixedHeader=BaseAnimatedHeader.extend({
    selector:'header.o_header_standard:not(.o_header_sidebar)',

    /**
     *@constructor
     */
    init:function(){
        this._super(...arguments);
        this.fixedHeaderShow=false;
        this.scrolledPoint=300;
    },
    /**
     *@override
     */
    start:function(){
        this.headerHeight=this.$el.outerHeight();
        returnthis._super.apply(this,arguments);
    },
    /**
     *@override
     */
    destroy(){
        this.$el.css('transform','');
        this._super(...arguments);
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _isShown(){
        return!this.fixedHeader||this.fixedHeaderShow;
    },
    /**
     *Calledwhenthewindowisscrolled
     *
     *@override
     *@param{integer}scroll
     */
    _updateHeaderOnScroll:function(scroll){
        this._super(...arguments);

        constmainPosScrolled=(scroll>this.headerHeight+this.topGap);
        constreachPosScrolled=(scroll>this.scrolledPoint+this.topGap)&&!this.scrollHeightTooShort;
        constfixedUpdate=(this.fixedHeader!==mainPosScrolled);
        constshowUpdate=(this.fixedHeaderShow!==reachPosScrolled);

        if(fixedUpdate||showUpdate){
            this.$el.css('transform',
                reachPosScrolled
                ?`translate(0,-${this.topGap}px)`
                :mainPosScrolled
                ?'translate(0,-100%)'
                :'');
            voidthis.$el[0].offsetWidth;//Forceapaintrefresh
        }

        this.fixedHeaderShow=reachPosScrolled;

        if(fixedUpdate){
            this._toggleFixedHeader(mainPosScrolled);
        }elseif(showUpdate){
            this._adaptToHeaderChange();
        }
    },
});

publicWidget.registry.FixedHeader=BaseAnimatedHeader.extend({
    selector:'header.o_header_fixed:not(.o_header_sidebar)',

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _updateHeaderOnScroll:function(scroll){
        this._super(...arguments);
        //Needtobe'unfixed'whenthewindowisnotscrolledsothatthe
        //transparentmenuoptionstillworks.
        if(scroll>(this.scrolledPoint+this.topGap)){
            if(!this.$el.hasClass('o_header_affixed')){
                this.$el.css('transform',`translate(0,-${this.topGap}px)`);
                voidthis.$el[0].offsetWidth;//Forceapaintrefresh
                this._toggleFixedHeader(true);
            }
        }else{
            this._toggleFixedHeader(false);
            voidthis.$el[0].offsetWidth;//Forceapaintrefresh
            this.$el.css('transform','');
        }
    },
});

constBaseDisappearingHeader=publicWidget.registry.FixedHeader.extend({
    /**
     *@override
     */
    init:function(){
        this._super(...arguments);
        this.scrollingDownwards=true;
        this.hiddenHeader=false;
        this.position=0;
        this.atTop=true;
        this.checkPoint=0;
        this.scrollOffsetLimit=200;
    },
    /**
     *@override
     */
    destroy:function(){
        this._showHeader();
        this._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _hideHeader:function(){
        this.$el.trigger('flectra-transitionstart');
    },
    /**
     *@override
     */
    _isShown(){
        return!this.fixedHeader||!this.hiddenHeader;
    },
    /**
     *@private
     */
    _showHeader:function(){
        this.$el.trigger('flectra-transitionstart');
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _updateHeaderOnScroll:function(scroll){
        this._super(...arguments);

        constscrollingDownwards=(scroll>this.position);
        constatTop=(scroll<=0);
        if(scrollingDownwards!==this.scrollingDownwards){
            this.checkPoint=scroll;
        }

        this.scrollingDownwards=scrollingDownwards;
        this.position=scroll;
        this.atTop=atTop;

        if(scrollingDownwards){
            if(!this.hiddenHeader&&scroll-this.checkPoint>(this.scrollOffsetLimit+this.topGap)){
                this.hiddenHeader=true;
                this._hideHeader();
            }
        }else{
            if(this.hiddenHeader&&scroll-this.checkPoint<-(this.scrollOffsetLimit+this.topGap)/2){
                this.hiddenHeader=false;
                this._showHeader();
            }
        }

        if(atTop&&!this.atTop){
            //Forcereshowingtheinvisible-on-scrollsectionswhenreaching
            //thetopagain
            this._showHeader();
        }
    },
});

publicWidget.registry.DisappearingHeader=BaseDisappearingHeader.extend({
    selector:'header.o_header_disappears:not(.o_header_sidebar)',

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _hideHeader:function(){
        this._super(...arguments);
        this.$el.css('transform','translate(0,-100%)');
    },
    /**
     *@override
     */
    _showHeader:function(){
        this._super(...arguments);
        this.$el.css('transform',this.atTop?'':`translate(0,-${this.topGap}px)`);
    },
});

publicWidget.registry.FadeOutHeader=BaseDisappearingHeader.extend({
    selector:'header.o_header_fade_out:not(.o_header_sidebar)',

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _hideHeader:function(){
        this._super(...arguments);
        this.$el.stop(false,true).fadeOut();
    },
    /**
     *@override
     */
    _showHeader:function(){
        this._super(...arguments);
        this.$el.css('transform',this.atTop?'':`translate(0,-${this.topGap}px)`);
        this.$el.stop(false,true).fadeIn();
    },
});

/**
 *Autoadapttheheaderlayoutsothatelementsarenotwrappedonanewline.
 */
publicWidget.registry.autohideMenu=publicWidget.Widget.extend({
    selector:'header#top',
    disabledInEditableMode:false,

    /**
     *@override
     */
    asyncstart(){
        awaitthis._super(...arguments);
        this.$topMenu=this.$('#top_menu');
        this.noAutohide=this.$el.is('.o_no_autohide_menu');
        if(!this.noAutohide){
            awaitwUtils.onceAllImagesLoaded(this.$('.navbar'),this.$('.o_mega_menu,.o_offcanvas_logo_container,.dropdown-menu.o_lang_flag'));

            //Thepreviouscodewillmakesurewewaitforimagestobefully
            //loadedbeforeinitializingtheautomoremenu.Butinsomecases,
            //itisnotenough,wealsohavetowaitforfontsorevenextra
            //scripts.Thosewillhavenoimpactonthefeatureinmostcases
            //though,sowewillonlyupdatetheautomoremenuatthattime,
            //nowaitforittoinitializethefeature.
            var$window=$(window);
            $window.on('load.autohideMenu',function(){
                $window.trigger('resize');
            });

            dom.initAutoMoreMenu(this.$topMenu,{unfoldable:'.divider,.divider~li,.o_no_autohide_item'});
        }
        this.$topMenu.removeClass('o_menu_loading');
        this.$topMenu.trigger('menu_loaded');
    },
    /**
     *@override
     */
    destroy(){
        this._super(...arguments);
        if(!this.noAutohide&&this.$topMenu){
            $(window).off('.autohideMenu');
            dom.destroyAutoMoreMenu(this.$topMenu);
        }
    },
});

/**
 *Note:thisworkswellwiththeaffixMenu...bychance(menuDirectionis
 *calledafteralphabetically).
 *
 *@todocheckbootstrapv4:maybehandledautomaticallynow?
 */
publicWidget.registry.menuDirection=publicWidget.Widget.extend({
    selector:'header.navbar.nav',
    disabledInEditableMode:false,
    events:{
        'show.bs.dropdown':'_onDropdownShow',
    },

    /**
     *@override
     */
    start:function(){
        constisRTL=!!this.el.closest('#wrapwrap.o_rtl');
        this.right=isRTL?'left':'right';
        this.left=isRTL?'right':'left';
        this.defaultAlignment=this.$el.is('.ml-auto,.ml-auto~*')?this.right:this.left;
        returnthis._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     *@param{string}alignment-either'left'or'right'
     *@param{integer}liOffset
     *@param{integer}liWidth
     *@param{integer}menuWidth
     *@param{integer}pageWidth
     *@returns{boolean}
     */
    _checkOpening:function(alignment,liOffset,liWidth,menuWidth,pageWidth){
        if(alignment===this.left){
            //Checkifoktoopenthedropdowntotheright(nowindowoverflow)
            return(liOffset+menuWidth<=pageWidth);
        }else{
            //Checkifoktoopenthedropdowntotheleft(nowindowoverflow)
            return(liOffset+liWidth-menuWidth>=0);
        }
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _onDropdownShow:function(ev){
        var$li=$(ev.target);
        var$menu=$li.children('.dropdown-menu');
        varliOffset=$li.offset().left;
        varliWidth=$li.outerWidth();
        varmenuWidth=$menu.outerWidth();
        varpageWidth=$('#wrapwrap').outerWidth();

        $menu.removeClass('dropdown-menu-leftdropdown-menu-right');

        varalignment=this.defaultAlignment;
        if($li.nextAll(':visible').length===0){
            //Thedropdownisthelastmenuitem,opentotheleftside
            //(rightsidewithrtllanguages).
            alignment=this.right;
        }

        //Ifcan'topeninthecurrentdirectionbecauseitwouldoverflowthe
        //page,changethedirection.Butiftheotherdirectionwoulddothe
        //same,changebackthedirection.
        for(vari=0;i<2;i++){
            if(!this._checkOpening(alignment,liOffset,liWidth,menuWidth,pageWidth)){
                alignment=(alignment===this.left?this.right:this.left);
            }
        }

        $menu.addClass('dropdown-menu-'+alignment);
    },
});

publicWidget.registry.hoverableDropdown=animations.Animation.extend({
    selector:'header.o_hoverable_dropdown',
    disabledInEditableMode:false,
    effects:[{
        startEvents:'resize',
        update:'_dropdownHover',
    }],
    events:{
        'mouseenter.dropdown':'_onMouseEnter',
        'mouseleave.dropdown':'_onMouseLeave',
    },

    /**
     *@override
     */
    start:function(){
        this.$dropdownMenus=this.$el.find('.dropdown-menu');
        this.$dropdownToggles=this.$el.find('.dropdown-toggle');
        this._dropdownHover();
        returnthis._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _dropdownHover:function(){
        if(config.device.size_class>config.device.SIZES.SM){
            this.$dropdownMenus.css('margin-top','0');
            this.$dropdownMenus.css('top','unset');
        }else{
            this.$dropdownMenus.css('margin-top','');
            this.$dropdownMenus.css('top','');
        }
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@private
     *@param{Event}ev
     */
    _onMouseEnter:function(ev){
        //Theusermustclickonthedropdownifheisonmobile(nowayto
        //hover)orifthedropdownistheextramenu('+').
        if(config.device.size_class<=config.device.SIZES.SM||
            ev.currentTarget.classList.contains('o_extra_menu_items')){
            return;
        }
        $(ev.currentTarget.querySelector('.dropdown-toggle')).dropdown('show');
    },
    /**
     *@private
     *@param{Event}ev
     */
    _onMouseLeave:function(ev){
        if(config.device.size_class<=config.device.SIZES.SM||
            ev.currentTarget.classList.contains('o_extra_menu_items')){
            return;
        }
        $(ev.currentTarget.querySelector('.dropdown-toggle')).dropdown('hide');
    },
});

publicWidget.registry.HeaderMainCollapse=publicWidget.Widget.extend({
    selector:'header#top',
    disabledInEditableMode:false,
    events:{
        'show.bs.collapse#top_menu_collapse':'_onCollapseShow',
        'hidden.bs.collapse#top_menu_collapse':'_onCollapseHidden',
    },

    /**
     *@override
     */
    start(){
        //Thisisafixinstabletomovethe"calltoaction"buttoninthe
        //navbarforthe"boxed"headerwhenthe"off-canvas"mobilemenuis
        //enabled.Withoutthis,the"calltoaction"buttonisinaccessiblein
        //the"off-canvas"mobilemenu.
        this.offcanvasAndBoxedHeader=false;
        //Ifmobilemenuis"off-canvas"andheadertemplateis"boxed".
        if(this.$target[0].querySelector('.o_offcanvas_menu_toggler')
            &&this.$target[0].querySelector('.o_header_boxed_background')){
            this.navbarEl=this.$target[0].querySelector('#top_menu');
            this.callToActionEl=this.$target[0].querySelector('#oe_structure_header_boxed_2');
            this.offcanvasAndBoxedHeader=!!this.callToActionEl;
        }
        returnthis._super(...arguments);
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _onCollapseShow(){
        this.el.classList.add('o_top_menu_collapse_shown');
        if(this.offcanvasAndBoxedHeader){
            this.callToActionEl.classList.add('nav-item');
            this.navbarEl.append(this.callToActionEl);
        }
    },
    /**
     *@private
     */
    _onCollapseHidden(){
        this.el.classList.remove('o_top_menu_collapse_shown');
        if(this.offcanvasAndBoxedHeader){
            this.callToActionEl.classList.remove('nav-item');
            this.navbarEl.after(this.callToActionEl);
        }
    },
});

return{
    extraMenuUpdateCallbacks:extraMenuUpdateCallbacks,
};
});
