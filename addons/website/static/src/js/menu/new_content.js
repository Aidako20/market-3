flectra.define('website.newMenu',function(require){
'usestrict';

varcore=require('web.core');
varDialog=require('web.Dialog');
varwebsiteNavbarData=require('website.navbar');
varwUtils=require('website.utils');
vartour=require('web_tour.tour');

const{qweb,_t}=core;

varenableFlag='enable_new_content';

varNewContentMenu=websiteNavbarData.WebsiteNavbarActionWidget.extend({
    xmlDependencies:['/website/static/src/xml/website.editor.xml'],
    actions:_.extend({},websiteNavbarData.WebsiteNavbarActionWidget.prototype.actions||{},{
        close_all_widgets:'_handleCloseDemand',
        new_page:'_createNewPage',
    }),
    events:_.extend({},websiteNavbarData.WebsiteNavbarActionWidget.prototype.events||{},{
        'click':'_onBackgroundClick',
        'click[data-module-id]':'_onModuleIdClick',
        'keydown':'_onBackgroundKeydown',
    }),
    //allowtexttobecustomizedwithinheritance
    newContentText:{
        failed:_t('Failedtoinstall"%s"'),
        installInProgress:_t("TheinstallationofanAppisalreadyinprogress."),
        installNeeded:_t('Doyouwanttoinstallthe"%s"App?'),
        installPleaseWait:_t('Installing"%s"'),
    },

    /**
     *Preparethenavigationandfindthemodulestoinstall.
     *Movenotinstalledmodulebuttonsafterinstalledmodulesbuttons,
     *butkeeptheoriginalindextobeabletomovebackthependinginstall
     *buttonatitsfinalposition,sotheusercanclickatthesameplace.
     *
     *@override
     */
    start:function(){
        this.pendingInstall=false;
        this.$newContentMenuChoices=this.$('#o_new_content_menu_choices');

        var$modules=this.$newContentMenuChoices.find('.o_new_content_element');
        _.each($modules,function(el,index){
            var$el=$(el);
            $el.data('original-index',index);
            if($el.data('module-id')){
                $el.appendTo($el.parent());
                $el.find('ai,ap').addClass('o_uninstalled_module');
            }
        });

        this.$firstLink=this.$newContentMenuChoices.find('a:eq(0)');
        this.$lastLink=this.$newContentMenuChoices.find('a:last');

        if($.deparam.querystring()[enableFlag]!==undefined){
            Object.keys(tour.tours).forEach(
                el=>{
                    letelement=tour.tours[el];
                    if(element.steps[0].trigger=='#new-content-menu>a'
                        &&!element.steps[0].extra_trigger){
                        element.steps[0].auto=true;
                    }
                }
            );
            this._showMenu();
        }
        this.$loader=$(qweb.render('website.new_content_loader'));
        returnthis._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Actions
    //--------------------------------------------------------------------------

    /**
     *Askstheuserinformationaboutanewpagetocreate,thencreatesitand
     *redirectstheusertothisnewpage.
     *
     *@private
     *@returns{Promise}Unresolvedifthereisaredirection
     */
    _createNewPage:function(){
        returnwUtils.prompt({
            id:'editor_new_page',
            window_title:_t("NewPage"),
            input:_t("PageTitle"),
            init:function(){
                var$group=this.$dialog.find('div.form-group');
                $group.removeClass('mb0');

                var$add=$('<div/>',{'class':'form-groupmb0row'})
                            .append($('<span/>',{'class':'offset-md-3col-md-9text-left'})
                                    .append(qweb.render('website.components.switch',{id:'switch_addTo_menu',label:_t("Addtomenu")})));
                $add.find('input').prop('checked',true);
                $group.after($add);
            }
        }).then(function(result){
            //Removeanyleadingslash.
            constval=result.val.replace(/^\/*/,"");
            var$dialog=result.dialog;
            if(!val){
                return;
            }
            varurl='/website/add/'+encodeURIComponent(val);
            constres=wUtils.sendRequest(url,{
                add_menu:$dialog.find('input[type="checkbox"]').is(':checked')||'',
            });
            returnnewPromise(function(){});
        });
    },
    /**
     *@private
     */
    _handleCloseDemand:function(){
        this._hideMenu();
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *Setthefocusonthefirstlink
     *
     *@private
     */
    _focusFirstLink:function(){
        this.$firstLink.focus();
    },
    /**
     *Setthefocusonthelastlink
     *
     *@private
     */
    _focusLastLink:function(){
        this.$lastLink.focus();
    },
    /**
     *Hidethemenu
     *
     *@private
     */
    _hideMenu:function(){
        this.shown=false;
        this.$newContentMenuChoices.addClass('o_hidden');
        $('body').removeClass('o_new_content_open');
    },
    /**
     *Installamodule
     *
     *@private
     *@param{number}moduleId:themoduletoinstall
     *@return{Promise}
     */
    _install:function(moduleId){
        this.pendingInstall=true;
        $('body').css('pointer-events','none');
        returnthis._rpc({
            model:'ir.module.module',
            method:'button_immediate_install',
            args:[[moduleId]],
        }).guardedCatch(function(){
            $('body').css('pointer-events','');
        });
    },
    /**
     *Showthemenu
     *
     *@private
     *@returns{Promise}
     */
    _showMenu:function(){
        varself=this;
        returnnewPromise(function(resolve,reject){
            self.trigger_up('action_demand',{
                actionName:'close_all_widgets',
                onSuccess:resolve,
            });
        }).then(function(){
            self.firstTab=true;
            self.shown=true;
            self.$newContentMenuChoices.removeClass('o_hidden');
            $('body').addClass('o_new_content_open');
            self.$('>a').focus();

            wUtils.removeLoader();
        });
    },
    /**
     *CalledtoaddloaderelementinDOM.
     *
     *@param{string}moduleName
     *@private
     */
    _addLoader(moduleName){
        constnewContentLoaderText=_.str.sprintf(_t("Buildingyour%s"),moduleName);
        this.$loader.find('#new_content_loader_text').replaceWith(newContentLoaderText);
        $('body').append(this.$loader);
    },
    /**
     *@private
     */
    _removeLoader(){
        this.$loader.remove();
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Calledwhenthemenu'stogglebuttonisclicked:
     * ->Opensthemenuandresetthetabnavigation(ifclosed)
     * ->Closethemenu(ifopen)
     *Calledwhenaclickoutsidethemenu'soptionsoccurs->Closethemenu
     *
     *@private
     *@param{Event}ev
     */
    _onBackgroundClick:function(ev){
        if(this.$newContentMenuChoices.hasClass('o_hidden')){
            this._showMenu();
        }else{
            this._hideMenu();
        }
    },
    /**
     *Calledwhenakeydownoccurs:
     * ESC->Closesthemodal
     * TAB->Navigation(capturedinthemodal)
     *
     *@private
     *@param{Event}ev
     */
    _onBackgroundKeydown:function(ev){
        if(!this.shown){
            return;
        }
        switch(ev.which){
            case$.ui.keyCode.ESCAPE:
                this._hideMenu();
                ev.stopPropagation();
                break;
            case$.ui.keyCode.TAB:
                if(ev.shiftKey){
                    if(this.firstTab||document.activeElement===this.$firstLink[0]){
                        this._focusLastLink();
                        ev.preventDefault();
                    }
                }else{
                    if(this.firstTab||document.activeElement===this.$lastLink[0]){
                        this._focusFirstLink();
                        ev.preventDefault();
                    }
                }
                this.firstTab=false;
                break;
        }
    },
    /**
     *Opentheinstalldialogrelatedtoanelement:
     * -openthedialogdependingonaccessrightandanotherpendinginstall
     * -ifoktoinstall,preparetheinstallaction:
     *     -calltheproperactiononclick
     *     -changethebuttontextandstyle
     *     -handletheresult(reloadonthesamepageorerror)
     *
     *@private
     *@param{Event}ev
     */
    _onModuleIdClick:function(ev){
        varself=this;
        var$el=$(ev.currentTarget);
        var$i=$el.find('ai');
        var$p=$el.find('ap');

        vartitle=$p.text();
        varcontent='';
        varbuttons;

        varmoduleId=$el.data('module-id');
        varname=$el.data('module-shortdesc');

        ev.stopPropagation();
        ev.preventDefault();

        if(this.pendingInstall){
            content=this.newContentText.installInProgress;
        }else{
            content=_.str.sprintf(this.newContentText.installNeeded,name);
            buttons=[{
                text:_t("Install"),
                classes:'btn-primary',
                close:true,
                click:function(){
                    //movetheelementwhereitwillbeafterinstallation
                    var$finalPosition=self.$newContentMenuChoices
                        .find('.o_new_content_element:not([data-module-id])')
                        .filter(function(){
                            return$(this).data('original-index')<$el.data('original-index');
                        }).last();
                    if($finalPosition){
                        $el.fadeTo(400,0,function(){
                            //ifonceinstalled,buttondisapeear,don'tneedtomoveit.
                            if(!$el.hasClass('o_new_content_element_once')){
                                $el.insertAfter($finalPosition);
                            }
                            //changestyletousespinner
                            $i.removeClass()
                                .addClass('fafa-spinfa-spinnerfa-pulse')
                                .css('background-image','none');
                            $p.removeClass('o_uninstalled_module')
                                .text(_.str.sprintf(self.newContentText.installPleaseWait,name));
                            $el.fadeTo(1000,1);
                            self._addLoader(name);
                        });
                    }

                    self._install(moduleId).then(function(){
                        varorigin=window.location.origin;
                        varredirectURL=$el.find('a').data('url')||(window.location.pathname+'?'+enableFlag);
                        window.location.href=origin+redirectURL;
                        self._removeLoader();
                    },function(){
                        $i.removeClass()
                            .addClass('fafa-exclamation-triangle');
                        $p.text(_.str.sprintf(self.newContentText.failed,name));
                    });
                }
            },{
                text:_t("Cancel"),
                close:true,
            }];
        }

        newDialog(this,{
            title:title,
            size:'medium',
            $content:$('<div/>',{text:content}),
            buttons:buttons
        }).open();
    },
});

websiteNavbarData.websiteNavbarRegistry.add(NewContentMenu,'.o_new_content_menu');

returnNewContentMenu;
});
