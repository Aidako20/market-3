flectra.define('website.seo',function(require){
'usestrict';

varcore=require('web.core');
varClass=require('web.Class');
varDialog=require('web.Dialog');
varmixins=require('web.mixins');
varrpc=require('web.rpc');
varWidget=require('web.Widget');
varweWidgets=require('wysiwyg.widgets');
varwebsiteNavbarData=require('website.navbar');

var_t=core._t;

//Thisreplaces\b,becauseaccents(e.g.à,é)arenotseenaswordboundaries.
//Javascript\bisnotunicodeaware,andwordsbeginningorendingbyaccentswon'tmatch\b
varWORD_SEPARATORS_REGEX='([\\u2000-\\u206F\\u2E00-\\u2E7F\'!"#\\$%&\\(\\)\\*\\+,\\-\\.\\/:;<=>\\?¿¡@\\[\\]\\^_`\\{\\|\\}~\\s]+|^|$)';

varSuggestion=Widget.extend({
    template:'website.seo_suggestion',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],
    events:{
        'click.o_seo_suggestion':'select',
    },

    init:function(parent,options){
        this.keyword=options.keyword;
        this._super(parent);
    },
    select:function(){
        this.trigger('selected',this.keyword);
    },
});

varSuggestionList=Widget.extend({
    template:'website.seo_suggestion_list',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],

    init:function(parent,options){
        this.root=options.root;
        this.language=options.language;
        this.htmlPage=options.htmlPage;
        this._super(parent);
    },
    start:function(){
        this.refresh();
    },
    refresh:function(){
        varself=this;
        self.$el.append(_t("Loading..."));
        varcontext;
        this.trigger_up('context_get',{
            callback:function(ctx){
                context=ctx;
            },
        });
        varlanguage=self.language||context.lang.toLowerCase();
        this._rpc({
            route:'/website/seo_suggest',
            params:{
                keywords:self.root,
                lang:language,
            },
        }).then(function(keyword_list){
            self.addSuggestions(JSON.parse(keyword_list));
        });
    },
    addSuggestions:function(keywords){
        varself=this;
        self.$el.empty();
        //TODOImprovealgorithm+Ajustbasedoncustomuserkeywords
        varregex=newRegExp(WORD_SEPARATORS_REGEX+self.root+WORD_SEPARATORS_REGEX,'gi');
        keywords=_.map(_.uniq(keywords),function(word){
            returnword.replace(regex,'').trim();
        });
        //TODOOrderproperly?
        _.each(keywords,function(keyword){
            if(keyword){
                varsuggestion=newSuggestion(self,{
                    keyword:keyword,
                });
                suggestion.on('selected',self,function(word,language){
                    self.trigger('selected',word,language);
                });
                suggestion.appendTo(self.$el);
            }
        });
     },
});

varKeyword=Widget.extend({
    template:'website.seo_keyword',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],
    events:{
        'clicka[data-action=remove-keyword]':'destroy',
    },

    init:function(parent,options){
        this.keyword=options.word;
        this.language=options.language;
        this.htmlPage=options.htmlPage;
        this.used_h1=this.htmlPage.isInHeading1(this.keyword);
        this.used_h2=this.htmlPage.isInHeading2(this.keyword);
        this.used_content=this.htmlPage.isInBody(this.keyword);
        this._super(parent);
    },
    start:function(){
        varself=this;
        this.$('.o_seo_keyword_suggestion').empty();
        this.suggestionList=newSuggestionList(this,{
            root:this.keyword,
            language:this.language,
            htmlPage:this.htmlPage,
        });
        this.suggestionList.on('selected',this,function(word,language){
            this.trigger('selected',word,language);
        });
        returnthis.suggestionList.appendTo(this.$('.o_seo_keyword_suggestion')).then(function(){
            self.htmlPage.on('title-changed',self,self._updateTitle);
            self.htmlPage.on('description-changed',self,self._updateDescription);
            self._updateTitle();
            self._updateDescription();
        });
    },
    destroy:function(){
        this.trigger('removed');
        this._super();
    },
    _updateTitle:function(){
        var$title=this.$('.js_seo_keyword_title');
        if(this.htmlPage.isInTitle(this.keyword)){
            $title.css('visibility','visible');
        }else{
            $title.css('visibility','hidden');
        }
    },
    _updateDescription:function(){
        var$description=this.$('.js_seo_keyword_description');
        if(this.htmlPage.isInDescription(this.keyword)){
            $description.css('visibility','visible');
        }else{
            $description.css('visibility','hidden');
        }
    },
});

varKeywordList=Widget.extend({
    template:'website.seo_list',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],
    maxKeywords:10,

    init:function(parent,options){
        this.htmlPage=options.htmlPage;
        this._super(parent);
    },
    start:function(){
        varself=this;
        varexistingKeywords=self.htmlPage.keywords();
        if(existingKeywords.length>0){
            _.each(existingKeywords,function(word){
                self.add.call(self,word);
            });
        }
    },
    keywords:function(){
        varresult=[];
        this.$('.js_seo_keyword').each(function(){
            result.push($(this).data('keyword'));
        });
        returnresult;
    },
    isFull:function(){
        returnthis.keywords().length>=this.maxKeywords;
    },
    exists:function(word){
        return_.contains(this.keywords(),word);
    },
    add:asyncfunction(candidate,language){
        varself=this;
        //TODORefine
        varword=candidate?candidate.replace(/[,;.:<>]+/g,'').replace(/+/g,'').trim().toLowerCase():'';
        if(word&&!self.isFull()&&!self.exists(word)){
            varkeyword=newKeyword(self,{
                word:word,
                language:language,
                htmlPage:this.htmlPage,
            });
            keyword.on('removed',self,function(){
               self.trigger('list-not-full');
               self.trigger('content-updated',true);
            });
            keyword.on('selected',self,function(word,language){
                self.trigger('selected',word,language);
            });
            awaitkeyword.appendTo(self.$el);
        }
        if(self.isFull()){
            self.trigger('list-full');
        }
        self.trigger('content-updated');
    },
});

varPreview=Widget.extend({
    template:'website.seo_preview',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],

    init:function(parent,options){
        this.title=options.title;
        this.url=options.url;
        this.description=options.description;
        if(this.description.length>160){
            this.description=this.description.substring(0,159)+'…';
        }
        this._super(parent);
    },
});

varHtmlPage=Class.extend(mixins.PropertiesMixin,{
    init:function(){
        mixins.PropertiesMixin.init.call(this);
        this.initTitle=this.title();
        this.defaultTitle=$('meta[name="default_title"]').attr('content');
        this.initDescription=this.description();
    },
    url:function(){
        returnwindow.location.origin+window.location.pathname;
    },
    title:function(){
        return$('headtitle').text().trim();
    },
    changeTitle:function(title){
        //TODOcreatetagifmissing
        $('headtitle').text(title.trim()||this.defaultTitle);
        this.trigger('title-changed',title);
    },
    description:function(){
        return($('meta[name=description]').attr('content')||'').trim();
    },
    changeDescription:function(description){
        //TODOcreatetagifmissing
        $('meta[name=description]').attr('content',description);
        this.trigger('description-changed',description);
    },
    keywords:function(){
        var$keywords=$('meta[name=keywords]');
        varparsed=($keywords.length>0)&&$keywords.attr('content')&&$keywords.attr('content').split(',');
        return(parsed&&parsed[0])?parsed:[];
    },
    changeKeywords:function(keywords){
        //TODOcreatetagifmissing
        $('meta[name=keywords]').attr('content',keywords.join(','));
    },
    headers:function(tag){
        return$('#wrap'+tag).map(function(){
            return$(this).text();
        });
    },
    getOgMeta:function(){
        varogImageUrl=$('meta[property="og:image"]').attr('content');
        vartitle=$('meta[property="og:title"]').attr('content');
        vardescription=$('meta[property="og:description"]').attr('content');
        return{
            ogImageUrl:ogImageUrl&&ogImageUrl.replace(window.location.origin,''),
            metaTitle:title,
            metaDescription:description,
        };
    },
    images:function(){
        return$('#wrapimg').filter(function(){
            returnthis.naturalHeight>=200&&this.naturalWidth>=200;
        }).map(function(){
            return{
                src:this.getAttribute('src'),
                alt:this.getAttribute('alt'),
            };
        });
    },
    company:function(){
        return$('html').attr('data-oe-company-name');
    },
    bodyText:function(){
        return$('body').children().not('.oe_seo_configuration').text();
    },
    heading1:function(){
        return$('body').children().not('.oe_seo_configuration').find('h1').text();
    },
    heading2:function(){
        return$('body').children().not('.oe_seo_configuration').find('h2').text();
    },
    isInBody:function(text){
        returnnewRegExp(WORD_SEPARATORS_REGEX+text+WORD_SEPARATORS_REGEX,'gi').test(this.bodyText());
    },
    isInTitle:function(text){
        returnnewRegExp(WORD_SEPARATORS_REGEX+text+WORD_SEPARATORS_REGEX,'gi').test(this.title());
    },
    isInDescription:function(text){
        returnnewRegExp(WORD_SEPARATORS_REGEX+text+WORD_SEPARATORS_REGEX,'gi').test(this.description());
    },
    isInHeading1:function(text){
        returnnewRegExp(WORD_SEPARATORS_REGEX+text+WORD_SEPARATORS_REGEX,'gi').test(this.heading1());
    },
    isInHeading2:function(text){
        returnnewRegExp(WORD_SEPARATORS_REGEX+text+WORD_SEPARATORS_REGEX,'gi').test(this.heading2());
    },
});

varMetaTitleDescription=Widget.extend({
    //FormandpreviewforSEOmetatitleandmetadescription
    //
    //Weonlywanttoshowanalertfor"descriptiontoosmall"onthosecases
    //-atinitandthedescriptionisnotempty
    //-wereachedpasttheminimumandwentbacktoit
    //-focusoutofthefield
    //Basicallywedon'twantthetoosmallalertwhenthefieldisemptyand
    //westarttypingonit.
    template:'website.seo_meta_title_description',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],
    events:{
        'inputinput[name=website_meta_title]':'_titleChanged',
        'inputinput[name=website_seo_name]':'_seoNameChanged',
        'inputtextarea[name=website_meta_description]':'_descriptionOnInput',
        'changetextarea[name=website_meta_description]':'_descriptionOnChange',
    },
    maxRecommendedDescriptionSize:300,
    minRecommendedDescriptionSize:50,
    showDescriptionTooSmall:false,

    /**
     *@override
     */
    init:function(parent,options){
        this.htmlPage=options.htmlPage;
        this.canEditTitle=!!options.canEditTitle;
        this.canEditDescription=!!options.canEditDescription;
        this.canEditUrl=!!options.canEditUrl;
        this.isIndexed=!!options.isIndexed;
        this.seoName=options.seoName;
        this.seoNameDefault=options.seoNameDefault;
        this.seoNameHelp=options.seoNameHelp;
        this.previewDescription=options.previewDescription;
        this._super(parent,options);
    },
    /**
     *@override
     */
    start:function(){
        this.$title=this.$('input[name=website_meta_title]');
        this.$seoName=this.$('input[name=website_seo_name]');
        this.$seoNamePre=this.$('span.seo_name_pre');
        this.$seoNamePost=this.$('span.seo_name_post');
        this.$description=this.$('textarea[name=website_meta_description]');
        this.$warning=this.$('div#website_meta_description_warning');
        this.$preview=this.$('.js_seo_preview');

        if(!this.canEditTitle){
            this.$title.attr('disabled',true);
        }
        if(!this.canEditDescription){
            this.$description.attr('disabled',true);
        }
        if(this.htmlPage.title().trim()!==this.htmlPage.defaultTitle.trim()){
            this.$title.val(this.htmlPage.title());
        }
        if(this.htmlPage.description().trim()!==this.previewDescription){
            this.$description.val(this.htmlPage.description());
        }

        if(this.canEditUrl){
            this.previousSeoName=this.seoName;
            this.$seoName.val(this.seoName);
            this.$seoName.attr('placeholder',this.seoNameDefault);
            //makeslugeditablewithinputgroupforstatictext
            constsplitsUrl=window.location.pathname.split(this.previousSeoName||this.seoNameDefault);
            this.$seoNamePre.text(splitsUrl[0]);
            this.$seoNamePost.text(splitsUrl.slice(-1)[0]); //atleastthe-idtheorically
        }
        this._descriptionOnChange();
    },
    /**
     *Getthecurrenttitle
     */
    getTitle:function(){
        returnthis.$title.val().trim()||this.htmlPage.defaultTitle;
    },
    /**
     *GetthepotentialnewurlwithcustomseoNameasslug.
       IcandifferaftersaveifslugJS!=slugPython,butitprovideanideaforthepreview
     */
    getUrl:function(){
        constpath=window.location.pathname.replace(
            this.previousSeoName||this.seoNameDefault,
            (this.$seoName.length&&this.$seoName.val()?this.$seoName.val().trim():this.$seoName.attr('placeholder'))
        );
        returnwindow.location.origin+path
    },
    /**
     *Getthecurrentdescription
     */
    getDescription:function(){
        returnthis.getRealDescription()||this.previewDescription;
    },
    /**
     *Getthecurrentdescriptionchosenbytheuser
     */
    getRealDescription:function(){
        returnthis.$description.val()||'';
    },
    /**
     *@private
     */
    _titleChanged:function(){
        varself=this;
        self._renderPreview();
        self.trigger('title-changed');
    },
    /**
     *@private
     */
    _seoNameChanged:function(){
        varself=this;
        //don'tuse_,becauseweneedtokeeptrailingwhitespaceduringedition
        constslugified=this.$seoName.val().toString().trim().normalize('NFKD').toLowerCase()
            .replace(/\s+/g,'-')          //Replacespaceswith-
            .replace(/[^\w\-]+/g,'')      //Removeallnon-wordchars
            .replace(/\-\-+/g,'-');       //Replacemultiple-withsingle-
        this.$seoName.val(slugified);
        self._renderPreview();
    },
    /**
     *@private
     */
    _descriptionOnChange:function(){
        this.showDescriptionTooSmall=true;
        this._descriptionOnInput();
    },
    /**
     *@private
     */
    _descriptionOnInput:function(){
        varlength=this.getDescription().length;

        if(length>=this.minRecommendedDescriptionSize){
            this.showDescriptionTooSmall=true;
        }elseif(length===0){
            this.showDescriptionTooSmall=false;
        }

        if(length>this.maxRecommendedDescriptionSize){
            this.$warning.text(_t('Yourdescriptionlookstoolong.')).show();
        }elseif(this.showDescriptionTooSmall&&length<this.minRecommendedDescriptionSize){
            this.$warning.text(_t('Yourdescriptionlookstooshort.')).show();
        }else{
            this.$warning.hide();
        }

        this._renderPreview();
        this.trigger('description-changed');
    },
    /**
     *@private
     */
    _renderPreview:function(){
        varindexed=this.isIndexed;
        varpreview="";
        if(indexed){
            preview=newPreview(this,{
                title:this.getTitle(),
                description:this.getDescription(),
                url:this.getUrl(),
            });
        }else{
            preview=newPreview(this,{
                description:_t("Youhavehiddenthispagefromsearchresults.Itwon'tbeindexedbysearchengines."),
            });
        }
        this.$preview.empty();
        preview.appendTo(this.$preview);
    },
});

varMetaKeywords=Widget.extend({
    //FormandtableforSEOmetakeywords
    template:'website.seo_meta_keywords',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],
    events:{
        'keyupinput[name=website_meta_keywords]':'_confirmKeyword',
        'clickbutton[data-action=add]':'_addKeyword',
    },

    init:function(parent,options){
        this.htmlPage=options.htmlPage;
        this._super(parent,options);
    },
    start:function(){
        varself=this;
        this.$input=this.$('input[name=website_meta_keywords]');
        this.keywordList=newKeywordList(this,{htmlPage:this.htmlPage});
        this.keywordList.on('list-full',this,function(){
            self.$input.attr({
                readonly:'readonly',
                placeholder:"Removeakeywordfirst"
            });
            self.$('button[data-action=add]').prop('disabled',true).addClass('disabled');
        });
        this.keywordList.on('list-not-full',this,function(){
            self.$input.removeAttr('readonly').attr('placeholder',"");
            self.$('button[data-action=add]').prop('disabled',false).removeClass('disabled');
        });
        this.keywordList.on('selected',this,function(word,language){
            self.keywordList.add(word,language);
        });
        this.keywordList.on('content-updated',this,function(removed){
            self._updateTable(removed);
        });
        returnthis.keywordList.insertAfter(this.$('.tablethead')).then(function(){
            self._getLanguages();
            self._updateTable();
        });
    },
    _addKeyword:function(){
        var$language=this.$('select[name=seo_page_language]');
        varkeyword=this.$input.val();
        varlanguage=$language.val().toLowerCase();
        this.keywordList.add(keyword,language);
        this.$input.val('').focus();
    },
    _confirmKeyword:function(e){
        if(e.keyCode===13){
            this._addKeyword();
        }
    },
    _getLanguages:function(){
        varself=this;
        varcontext;
        this.trigger_up('context_get',{
            callback:function(ctx){
                context=ctx;
            },
        });
        this._rpc({
            route:'/website/get_languages',
        }).then(function(data){
            self.$('#language-box').html(core.qweb.render('Configurator.language_promote',{
                'language':data,
                'def_lang':context.lang
            }));
        });
    },
    /*
     *Showthetableifthereisatleastonekeyword.Hideitotherwise.
     *
     *@private
     *@param{boolean}removed:akeywordisabouttoberemoved,
     *  weneedtoexcludeitfromthecount
     */
    _updateTable:function(removed){
        varmin=removed?1:0;
        if(this.keywordList.keywords().length>min){
            this.$('table').show();
        }else{
            this.$('table').hide();
        }
    },
});

varMetaImageSelector=Widget.extend({
    template:'website.seo_meta_image_selector',
    xmlDependencies:['/website/static/src/xml/website.seo.xml'],
    events:{
        'click.o_meta_img_upload':'_onClickUploadImg',
        'click.o_meta_img':'_onClickSelectImg',
    },
    /**
     *@override
     *@param{widget}parent
     *@param{Object}data
     */
    init:function(parent,data){
        this.metaTitle=data.title||'';
        this.activeMetaImg=data.metaImg;
        this.serverUrl=data.htmlpage.url();
        constimgField=data.hasSocialDefaultImage?'social_default_image':'logo';
        data.pageImages.unshift(_.str.sprintf('/web/image/website/%s/%s',flectra.session_info.website_id,imgField));
        this.images=_.uniq(data.pageImages);
        this.customImgUrl=_.contains(
            data.pageImages.map((img)=> newURL(img,window.location.origin).pathname),
            newURL(data.metaImg,window.location.origin).pathname)
            ?false:data.metaImg;
        this.previewDescription=data.previewDescription;
        this._setDescription(this.previewDescription);
        this._super(parent);
    },
    setTitle:function(title){
        this.metaTitle=title;
        this._updateTemplateBody();
    },
    setDescription:function(description){
        this._setDescription(description);
        this._updateTemplateBody();
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *Setthedescription,applyingellipsisiftoolong.
     *
     *@private
    */
    _setDescription:function(description){
        this.metaDescription=description||this.previewDescription;
        if(this.metaDescription.length>160){
            this.metaDescription=this.metaDescription.substring(0,159)+'…';
        }
    },

    /**
     *Updatetemplate.
     *
     *@private
    */
    _updateTemplateBody:function(){
        this.$el.empty();
        this.images=_.uniq(this.images);
        this.$el.append(core.qweb.render('website.og_image_body',{widget:this}));
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Calledwhenaselectimagefromlist->changethepreviewaccordingly.
     *
     *@private
     *@param{MouseEvent}ev
     */
    _onClickSelectImg:function(ev){
        var$img=$(ev.currentTarget);
        this.activeMetaImg=$img.find('img').attr('src');
        this._updateTemplateBody();
    },
    /**
     *OpenamediaDialogtoselect/uploadimage.
     *
     *@private
     *@param{MouseEvent}ev
     */
    _onClickUploadImg:function(ev){
        varself=this;
        var$image=$('<img/>');
        varmediaDialog=newweWidgets.MediaDialog(this,{
            onlyImages:true,
            res_model:'ir.ui.view',
        },$image[0]);
        mediaDialog.open();
        mediaDialog.on('save',this,function(image){
            self.activeMetaImg=image.src;
            self.customImgUrl=image.src;
            self._updateTemplateBody();
        });
    },
});

varSeoConfigurator=Dialog.extend({
    template:'website.seo_configuration',
    xmlDependencies:Dialog.prototype.xmlDependencies.concat(
        ['/website/static/src/xml/website.seo.xml']
    ),
    canEditTitle:false,
    canEditDescription:false,
    canEditKeywords:false,
    canEditLanguage:false,
    canEditUrl:false,

    init:function(parent,options){
        options=options||{};
        _.defaults(options,{
            title:_t('OptimizeSEO'),
            buttons:[
                {text:_t('Save'),classes:'btn-primary',click:this.update},
                {text:_t('Discard'),close:true},
            ],
        });

        this._super(parent,options);
    },
    start:function(){
        varself=this;

        this.$modal.addClass('oe_seo_configuration');

        this.htmlPage=newHtmlPage();

        this.disableUnsavableFields().then(function(){
            //Imageselector
            self.metaImageSelector=newMetaImageSelector(self,{
                htmlpage:self.htmlPage,
                hasSocialDefaultImage:self.hasSocialDefaultImage,
                title:self.htmlPage.getOgMeta().metaTitle,
                metaImg:self.metaImg||self.htmlPage.getOgMeta().ogImageUrl,
                pageImages:_.pluck(self.htmlPage.images().get(),'src'),
                previewDescription:_t('Thedescriptionwillbegeneratedbysocialmediabasedonpagecontentunlessyouspecifyone.'),
            });
            self.metaImageSelector.appendTo(self.$('.js_seo_image'));

            //titleanddescription
            self.metaTitleDescription=newMetaTitleDescription(self,{
                htmlPage:self.htmlPage,
                canEditTitle:self.canEditTitle,
                canEditDescription:self.canEditDescription,
                canEditUrl:self.canEditUrl,
                isIndexed:self.isIndexed,
                previewDescription:_t('Thedescriptionwillbegeneratedbysearchenginesbasedonpagecontentunlessyouspecifyone.'),
                seoNameHelp:_t('Thisvaluewillbeescapedtobecompliantwithallmajorbrowsersandusedinurl.Keepitemptytousethedefaultnameoftherecord.'),
                seoName:self.seoName,//'my-custom-display-name'or''
                seoNameDefault:self.seoNameDefault,//'display-name'
            });
            self.metaTitleDescription.on('title-changed',self,self.titleChanged);
            self.metaTitleDescription.on('description-changed',self,self.descriptionChanged);
            self.metaTitleDescription.appendTo(self.$('.js_seo_meta_title_description'));

            //keywords
            self.metaKeywords=newMetaKeywords(self,{htmlPage:self.htmlPage});
            self.metaKeywords.appendTo(self.$('.js_seo_meta_keywords'));
        });
    },
    /*
     *Resetmetatagstotheirinitialvalueifnotsaved.
     *
     *@private
     */
    destroy:function(){
        if(!this.savedData){
            this.htmlPage.changeTitle(this.htmlPage.initTitle);
            this.htmlPage.changeDescription(this.htmlPage.initDescription);
        }
        this._super.apply(this,arguments);
    },
    disableUnsavableFields:function(){
        varself=this;
        returnthis.loadMetaData().then(function(data){
            //WeonlyneedareloadforCOWwhenthecopyishappening,therefore:
            //-noreloadifwearenoteditingaview(condition:website_id===undefined)
            //-reloadifgenericpage(condition:website_id===false)
            self.reloadOnSave=data.website_id===undefined?false:!data.website_id;
            //Ifwebsite.page,hidethegooglepreview&telluserhispageiscurrentlyunindexed
            self.isIndexed=(data&&('website_indexed'indata))?data.website_indexed:true;
            self.canEditTitle=data&&('website_meta_title'indata);
            self.canEditDescription=data&&('website_meta_description'indata);
            self.canEditKeywords=data&&('website_meta_keywords'indata);
            self.metaImg=data.website_meta_og_img;
            self.hasSocialDefaultImage=data.has_social_default_image;
            self.canEditUrl=data&&('seo_name'indata);
            self.seoName=self.canEditUrl&&data.seo_name;
            self.seoNameDefault=self.canEditUrl&&data.seo_name_default;
            if(!self.canEditTitle&&!self.canEditDescription&&!self.canEditKeywords){
                //disablethebuttontopreventanerrorifthecurrentpagedoesn'tusethemixin
                //wemakethecheckhereinsteadofontheviewbecausewedon'tneedtocheck
                //ateverypageload,justwhentherarecasesomeoneclicksonthislink
                //TODOdon'tshowthemodalbutjustanalertinthiscase
                self.$footer.find('button[data-action=update]').attr('disabled',true);
            }
        });
    },
    update:function(){
        varself=this;
        vardata={};
        if(this.canEditTitle){
            data.website_meta_title=this.metaTitleDescription.$title.val();
        }
        if(this.canEditDescription){
            data.website_meta_description=this.metaTitleDescription.$description.val();
        }
        if(this.canEditKeywords){
            data.website_meta_keywords=this.metaKeywords.keywordList.keywords().join(',');
        }
        if(this.canEditUrl){
            if(this.metaTitleDescription.$seoName.val()!=this.metaTitleDescription.previousSeoName){
                data.seo_name=this.metaTitleDescription.$seoName.val();
                self.reloadOnSave=true; //willforcearefreshonoldurlandredirecttonewslug
            }
        }
        data.website_meta_og_img=this.metaImageSelector.activeMetaImg;
        this.saveMetaData(data).then(function(){
            //Wewanttoreloadifweareeditingagenericpage
            //becauseitwillbecomeaspecificpageafterthischange(COW)
            //andwewanttheusertobeonthepagehejustcreated.
            if(self.reloadOnSave){
                window.location.href=self.htmlPage.url();
            }else{
                self.htmlPage.changeKeywords(self.metaKeywords.keywordList.keywords());
                self.savedData=true;
                self.close();
            }
        });
    },
    getMainObject:function(){
        varmainObject;
        this.trigger_up('main_object_request',{
            callback:function(value){
                mainObject=value;
            },
        });
        returnmainObject;
    },
    getSeoObject:function(){
        varseoObject;
        this.trigger_up('seo_object_request',{
            callback:function(value){
                seoObject=value;
            },
        });
        returnseoObject;
    },
    loadMetaData:function(){
        varobj=this.getSeoObject()||this.getMainObject();
        returnnewPromise(function(resolve,reject){
            if(!obj){
                //returnPromise.reject(newError("Nomain_objectwasfound."));
                resolve(null);
            }else{
                rpc.query({
                    route:"/website/get_seo_data",
                    params:{
                        'res_id':obj.id,
                        'res_model':obj.model,
                    },
                }).then(function(data){
                    varmeta=data;
                    meta.model=obj.model;
                    resolve(meta);
                }).guardedCatch(reject);
            }
        });
    },
    saveMetaData:function(data){
        varobj=this.getSeoObject()||this.getMainObject();
        if(!obj){
            returnPromise.reject();
        }else{
            returnthis._rpc({
                model:obj.model,
                method:'write',
                args:[[obj.id],data],
            });
        }
    },
    titleChanged:function(){
        varself=this;
        _.defer(function(){
            vartitle=self.metaTitleDescription.getTitle();
            self.htmlPage.changeTitle(title);
            self.metaImageSelector.setTitle(title);
        });
    },
    descriptionChanged:function(){
        varself=this;
        _.defer(function(){
            vardescription=self.metaTitleDescription.getRealDescription();
            self.htmlPage.changeDescription(description);
            self.metaImageSelector.setDescription(description);
        });
    },
});

varSeoMenu=websiteNavbarData.WebsiteNavbarActionWidget.extend({
    actions:_.extend({},websiteNavbarData.WebsiteNavbarActionWidget.prototype.actions||{},{
        'promote-current-page':'_promoteCurrentPage',
    }),

    init:function(parent,options){
        this._super(parent,options);

        if($.deparam.querystring().enable_seo!==undefined){
            this._promoteCurrentPage();
        }
    },

    //--------------------------------------------------------------------------
    //Actions
    //--------------------------------------------------------------------------

    /**
     *OpenstheSEOconfiguratordialog.
     *
     *@private
     */
    _promoteCurrentPage:function(){
        newSeoConfigurator(this).open();
    },
});

websiteNavbarData.websiteNavbarRegistry.add(SeoMenu,'#promote-menu');

return{
    SeoConfigurator:SeoConfigurator,
    SeoMenu:SeoMenu,
};
});
