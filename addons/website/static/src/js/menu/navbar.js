flectra.define('website.navbar',function(require){
'usestrict';

varcore=require('web.core');
vardom=require('web.dom');
varpublicWidget=require('web.public.widget');
varconcurrency=require('web.concurrency');
varWidget=require('web.Widget');
varwebsiteRootData=require('website.root');

varwebsiteNavbarRegistry=newpublicWidget.RootWidgetRegistry();

varWebsiteNavbar=publicWidget.RootWidget.extend({
    xmlDependencies:['/website/static/src/xml/website.xml'],
    events:_.extend({},publicWidget.RootWidget.prototype.events||{},{
        'click[data-action]':'_onActionMenuClick',
        'mouseover>ul>li.dropdown:not(.show)':'_onMenuHovered',
        'click.o_mobile_menu_toggle':'_onMobileMenuToggleClick',
        'mouseenter#oe_applications:not(:has(.dropdown-item))':'_onOeApplicationsHovered',
        'show.bs.dropdown#oe_applications:not(:has(.dropdown-item))':'_onOeApplicationsShow',
    }),
    custom_events:_.extend({},publicWidget.RootWidget.prototype.custom_events||{},{
        'action_demand':'_onActionDemand',
        'edit_mode':'_onEditMode',
        'readonly_mode':'_onReadonlyMode',
        'ready_to_save':'_onSave',
    }),

    /**
     *@constructor
     */
    init:function(){
        this._super.apply(this,arguments);
        varself=this;
        varinitPromise=newPromise(function(resolve){
            self.resolveInit=resolve;
        });
        this._widgetDefs=[initPromise];
    },
    /**
     *@override
     */
    start:function(){
        varself=this;
        dom.initAutoMoreMenu(this.$('ul.o_menu_sections'),{
            maxWidth:function(){
                //Thenavbarcontainsdifferentelementsincommunityand
                //enterprise,sowecheckforbothofthemhereonly
                returnself.$el.width()
                    -(self.$('.o_menu_systray').outerWidth(true)||0)
                    -(self.$('ul#oe_applications').outerWidth(true)||0)
                    -(self.$('.o_menu_toggle').outerWidth(true)||0)
                    -(self.$('.o_menu_brand').outerWidth(true)||0);
            },
        });
        returnthis._super.apply(this,arguments).then(function(){
            self.resolveInit();
        });
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _attachComponent:function(){
        vardef=this._super.apply(this,arguments);
        this._widgetDefs.push(def);
        returndef;
    },
    /**
     *AstheWebsiteNavbarinstanceisdesignedtobeunique,theassociated
     *registryhasbeeninstantiatedoutsideoftheclassandissimply
     *returnedhere.
     *
     *@override
     */
    _getRegistry:function(){
        returnwebsiteNavbarRegistry;
    },
    /**
     *Searchesfortheautomaticwidget{@seeRootWidget}whichcanhandlethat
     *action.
     *
     *@private
     *@param{string}actionName
     *@param{Array}params
     *@returns{Promise}
     */
    _handleAction:function(actionName,params,_i){
        varself=this;
        returnthis._whenReadyForActions().then(function(){
            vardefs=[];
            _.each(self._widgets,function(w){
                if(!w.handleAction){
                    return;
                }

                vardef=w.handleAction(actionName,params);
                if(def!==null){
                    defs.push(def);
                }
            });
            if(!defs.length){
                //Handlethecasewhereallaction-capablecomponentsarenot
                //instantiatedyet(rare)->retrysometimestoeventuallyabort
                if(_i>50){
                    console.warn(_.str.sprintf("Action'%s'wasnotabletobehandled.",actionName));
                    returnPromise.reject();
                }
                returnconcurrency.delay(100).then(function(){
                    returnself._handleAction(actionName,params,(_i||0)+1);
                });
            }
            returnPromise.all(defs).then(function(values){
                if(values.length===1){
                    returnvalues[0];
                }
                returnvalues;
            });
        });
    },
    /**
     *@private
     *@returns{Promise}
     */
    async_loadAppMenus(){
        if(!this._loadAppMenusProm){
            this._loadAppMenusProm=this._rpc({
                model:'ir.ui.menu',
                method:'load_menus_root',
                args:[],
            });
            constresult=awaitthis._loadAppMenusProm;
            constmenus=core.qweb.render('website.oe_applications_menu',{
                'menu_data':result,
            });
            this.$('#oe_applications.dropdown-menu').html(menus);
        }
        returnthis._loadAppMenusProm;
    },
    /**
     *@private
     */
    _whenReadyForActions:function(){
        returnPromise.all(this._widgetDefs);
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Calledwhenthebackendapplicationsmenuishovered->fetchthe
     *availablemenusandinsertitinDOM.
     *
     *@private
     */
    _onOeApplicationsHovered:function(){
        this._loadAppMenus();
    },
    /**
     *Calledwhenthebackendapplicationsmenuisopening->fetchthe
     *availablemenusandinsertitinDOM.Neededontopofhoveringasthe
     *dropdowncouldbeopenedviakeyboard(ortheusercouldjustalready
     *beoverthedropdownwhentheJSisfullyloaded).
     *
     *@private
     */
    _onOeApplicationsShow:function(){
        this._loadAppMenus();
    },
    /**
     *Calledwhenanactionmenuisclicked->searchesfortheautomatic
     *widget{@seeRootWidget}whichcanhandlethataction.
     *
     *@private
     *@param{Event}ev
     */
    _onActionMenuClick:function(ev){
        constrestore=dom.addButtonLoadingEffect(ev.currentTarget);
        this._handleAction($(ev.currentTarget).data('action')).then(restore).guardedCatch(restore);
    },
    /**
     *Calledwhenanactionisaskedtobeexecutedfromachildwidget->
     *searchesfortheautomaticwidget{@seeRootWidget}whichcanhandle
     *thataction.
     */
    _onActionDemand:function(ev){
        vardef=this._handleAction(ev.data.actionName,ev.data.params);
        if(ev.data.onSuccess){
            def.then(ev.data.onSuccess);
        }
        if(ev.data.onFailure){
            def.guardedCatch(ev.data.onFailure);
        }
    },
    /**
     *Calledinresponsetoeditmodeactivation->hidesthenavbar.
     *
     *@private
     */
    _onEditMode:function(){
        this.$el.addClass('editing_mode');
        this.do_hide();
    },
    /**
     *Calledwhenasubmenuishovered->automaticallyopensitifanother
     *menuwasalreadyopened.
     *
     *@private
     *@param{Event}ev
     */
    _onMenuHovered:function(ev){
        var$opened=this.$('>ul>li.dropdown.show');
        if($opened.length){
            $opened.find('.dropdown-toggle').dropdown('toggle');
            $(ev.currentTarget).find('.dropdown-toggle').dropdown('toggle');
        }
    },
    /**
     *Calledwhenthemobilemenutogglebuttonisclick->modifiestheDOM
     *toopenthemobilemenu.
     *
     *@private
     */
    _onMobileMenuToggleClick:function(){
        this.$el.parent().toggleClass('o_mobile_menu_opened');
    },
    /**
     *Calledinresponsetoeditmodeactivation->hidesthenavbar.
     *
     *@private
     */
    _onReadonlyMode:function(){
        this.$el.removeClass('editing_mode');
        this.do_show();
    },
    /**
     *Calledinresponsetoeditmodesaving->checksifaction-capable
     *childrenhavesomethingtosave.
     *
     *@private
     *@param{FlectraEvent}ev
     */
    _onSave:function(ev){
        ev.data.defs.push(this._handleAction('on_save'));
    },
});

varWebsiteNavbarActionWidget=Widget.extend({
    /**
     *'Actionname'->'Handlername'object
     *
     *Any[data-action="x"]elementinsidethewebsitenavbarwill
     *automaticallytriggeranaction"x".Thisactioncanthenbehandledby
     *any`WebsiteNavbarActionWidget`instanceiftheactionname"x"is
     *registeredinthis`actions`object.
     */
    actions:{},

    //--------------------------------------------------------------------------
    //Public
    //--------------------------------------------------------------------------

    /**
     *Checksifthewidgetcanexecuteanactionwhosenameisgiven,withthe
     *givenparameters.Ifitisthecase,executethataction.
     *
     *@param{string}actionName
     *@param{Array}params
     *@returns{Promise|null}action'spromiseornullifnoactionwasfound
     */
    handleAction:function(actionName,params){
        varaction=this[this.actions[actionName]];
        if(action){
            returnPromise.resolve(action.apply(this,params||[]));
        }
        returnnull;
    },
});

websiteRootData.websiteRootRegistry.add(WebsiteNavbar,'#oe_main_menu_navbar');

return{
    WebsiteNavbar:WebsiteNavbar,
    websiteNavbarRegistry:websiteNavbarRegistry,
    WebsiteNavbarActionWidget:WebsiteNavbarActionWidget,
};
});
