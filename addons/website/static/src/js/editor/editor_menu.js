flectra.define('website.editor.menu',function(require){
'usestrict';

varDialog=require('web.Dialog');
vardom=require('web.dom');
varWidget=require('web.Widget');
varcore=require('web.core');
varWysiwyg=require('web_editor.wysiwyg.root');

var_t=core._t;

varWysiwygMultizone=Wysiwyg.extend({
    assetLibs:Wysiwyg.prototype.assetLibs.concat(['website.compiled_assets_wysiwyg']),
    _getWysiwygContructor:function(){
        returnflectra.__DEBUG__.services['web_editor.wysiwyg.multizone'];
    }
});

varEditorMenu=Widget.extend({
    template:'website.editorbar',
    xmlDependencies:['/website/static/src/xml/website.editor.xml'],
    events:{
        'clickbutton[data-action=undo]':'_onUndoClick',
        'clickbutton[data-action=redo]':'_onRedoClick',
        'clickbutton[data-action=save]':'_onSaveClick',
        'clickbutton[data-action=cancel]':'_onCancelClick',
    },
    custom_events:{
        request_save:'_onSnippetRequestSave',
        get_clean_html:'_onGetCleanHTML',
    },

    /**
     *@override
     */
    willStart:function(){
        varself=this;
        this.$el=null;//temporarynulltoavoidhiddenerror(@seestart)
        returnthis._super()
            .then(function(){
                var$wrapwrap=$('#wrapwrap');
                $wrapwrap.removeClass('o_editable');//cleanthedombeforeedition
                self.editable($wrapwrap).addClass('o_editable');
                self.wysiwyg=self._wysiwygInstance();
            });
    },
    /**
     *@override
     */
    start:function(){
        varself=this;
        this.$el.css({width:'100%'});
        returnthis.wysiwyg.attachTo($('#wrapwrap')).then(function(){
            self.trigger_up('edit_mode');
            self.$el.css({width:''});
        });
    },
    /**
     *@override
     */
    destroy:function(){
        this.trigger_up('readonly_mode');
        this._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Public
    //--------------------------------------------------------------------------

    /**
     *Askstheuseriftheyreallywantstodiscardtheirchanges(ifany),
     *thensimplyreloadsthepageiftheywantto.
     *
     *@param{boolean}[reload=true]
     *       trueifthepagehastobereloadedwhentheuseranswersyes
     *       (donothingotherwisebutaddthistoallowclassextension)
     *@returns{Deferred}
     */
    cancel:function(reload){
        varself=this;
        vardef=newPromise(function(resolve,reject){
            if(!self.wysiwyg.isDirty()){
                resolve();
            }else{
                varconfirm=Dialog.confirm(self,_t("Ifyoudiscardthecurrentedits,allunsavedchangeswillbelost.Youcancanceltoreturntoeditmode."),{
                    confirm_callback:resolve,
                });
                confirm.on('closed',self,reject);
            }
        });

        returndef.then(function(){
            self.trigger_up('edition_will_stopped');
            var$wrapwrap=$('#wrapwrap');
            self.editable($wrapwrap).removeClass('o_editable');
            if(reload!==false){
                window.onbeforeunload=null;
                self.wysiwyg.destroy();
                returnself._reload();
            }else{
                self.wysiwyg.destroy();
                self.trigger_up('readonly_mode');
                self.trigger_up('edition_was_stopped');
                self.destroy();
            }
        });
    },
    /**
     *Asksthesnippetstocleanthemself,thensavesthepage,thenreloadsit
     *ifaskedto.
     *
     *@param{boolean}[reload=true]
     *       trueifthepagehastobereloadedafterthesave
     *@returns{Promise}
     */
    save:asyncfunction(reload){
        if(this._saving){
            returnfalse;
        }
        varself=this;
        this._saving=true;
        this.trigger_up('edition_will_stopped',{
            //TODOadaptinmaster,thiswasaddedasastablefix.This
            //triggerto'edition_will_stopped'wasleftbymistake
            //duringaneditorrefactoring+revertfail.Itstopsthepublic
            //widgetsatthewrongtime,potentiallydead-lockingtheeditor.
            //'ready_to_clean_for_save'istheoneinchargeofstoppingthe
            //widgetsatthepropertime.
            noWidgetsStop:true,
        });
        returnthis.wysiwyg.save(false).then(function(result){
            var$wrapwrap=$('#wrapwrap');
            self.editable($wrapwrap).removeClass('o_editable');
            if(!result.isDirty){
                self.cancel(reload);
            }elseif(result.isDirty&&reload!==false){
                //removetoppaddingbecausetheconnectedbarisnotvisible
                $('body').removeClass('o_connected_user');
                returnself._reload();
            }else{
                self.wysiwyg.destroy();
                self.trigger_up('edition_was_stopped');
                self.destroy();
            }
            returntrue;
        }).guardedCatch(()=>{
            this._saving=false;
        });
    },
    /**
     *Returnstheeditableareasonthepage.
     *
     *@param{DOM}$wrapwrap
     *@returns{jQuery}
     */
    editable:function($wrapwrap){
        return$wrapwrap.find('[data-oe-model]')
            .not('.o_not_editable')
            .filter(function(){
                var$parent=$(this).closest('.o_editable,.o_not_editable');
                return!$parent.length||$parent.hasClass('o_editable');
            })
            .not('link,script')
            .not('[data-oe-readonly]')
            .not('img[data-oe-field="arch"],br[data-oe-field="arch"],input[data-oe-field="arch"]')
            .not('.oe_snippet_editor')
            .not('hr,br,input,textarea')
            .add('.o_editable');
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _wysiwygInstance:function(){
        varcontext;
        this.trigger_up('context_get',{
            callback:function(ctx){
                context=ctx;
            },
        });
        returnnewWysiwygMultizone(this,{
            snippets:'website.snippets',
            recordInfo:{
                context:context,
                data_res_model:'website',
                data_res_id:context.website_id,
            }
        });
    },
    /**
     *Reloadsthepageinnon-editablemode,withtherightscrolling.
     *
     *@private
     *@returns{Deferred}(neverresolved,thepageisreloadinganyway)
     */
    _reload:function(){
        $('body').addClass('o_wait_reload');
        this.wysiwyg.destroy();
        this.$el.hide();
        window.location.hash='scrollTop='+window.document.body.scrollTop;
        window.location.reload(true);
        returnnewPromise(function(){});
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Calledwhenthe"Discard"buttonisclicked->discardsthechanges.
     *
     *@private
     */
    _onCancelClick:function(){
        this.cancel(true);
    },
    /**
     *Getthecleanedvalueoftheeditableelement.
     *
     *@private
     *@param{FlectraEvent}ev
     */
    _onGetCleanHTML:function(ev){
        ev.data.callback(this.wysiwyg.getValue({$layout:ev.data.$layout}));
    },
    /**
     *Snippet(menu_data)canrequesttosavethedocumenttoleavethepage
     *
     *@private
     *@param{FlectraEvent}ev
     *@param{object}ev.data
     *@param{function}ev.data.onSuccess
     *@param{function}ev.data.onFailure
     */
    _onSnippetRequestSave:function(ev){
        this.save(false).then(ev.data.onSuccess,ev.data.onFailure);
    },
    /**
     *Calledwhenthe"Save"buttonisclicked->savesthechanges.
     *
     *@private
     */
    _onSaveClick:function(ev){
        constrestore=dom.addButtonLoadingEffect(ev.currentTarget);
        this.save().then(restore).guardedCatch(restore);
    },
    /**
     *@private
     */
    _onUndoClick(){
        $('.note-history[data-event=undo]').first().click();
    },
    /**
     *@private
     */
    _onRedoClick(){
        $('.note-history[data-event=redo]').first().click();
    },
});

returnEditorMenu;
});
