flectra.define('website_sale_coupon.test',function(require){
'usestrict';

require("website_sale.tour");
vartour=require("web_tour.tour");
varajax=require('web.ajax');

tour.register('shop_sale_coupon',{
    test:true,
    url:'/shop?search=Small%20Cabinet',
},
    [
        {
            content:"opencustomizemenu",
            extra_trigger:'.oe_website_sale.o_wsale_products_searchbar_form',
            trigger:'#customize-menu>a',
        },
        {
            content:"enable'Show#found'ifneeded",
            trigger:"#customize-menua:contains(Show#found)",
            run:function(){
                if(!$('#customize-menua:contains(Show#found)input').prop('checked')){
                    $('#customize-menua:contains(Show#found)').click();
                }
            }
        },
        /*1.Buy1SmallCabinet,enablecouponcode&insert10%code*/
        {
            content:"selectSmallCabinet",
            extra_trigger:'.oe_search_found',
            trigger:'.oe_product_carta:contains("SmallCabinet")',
        },
        {
            content:"add2SmallCabinetintocart",
            trigger:'#product_detailsinput[name="add_qty"]',
            run:"text2",
        },
        {
            content:"clickon'AddtoCart'button",
            trigger:"a:contains(AddtoCart)",
        },
        {
            content:"opencustomizemenu",
            extra_trigger:'.oe_website_sale.oe_cart',
            trigger:'#customize-menu>a',
        },
        {
            content:"enable'PromoCode'ifneeded",
            trigger:"#customize-menua:contains(PromoCode)",
            run:function(){
                if(!$('#customize-menua:contains(PromoCode)input').prop('checked')){
                    $('#customize-menua:contains(PromoCode)').click();
                }
            }
        },
        {
            content:"clickon'Ihaveapromocode'",
            extra_trigger:'.show_coupon',
            trigger:'.show_coupon',
        },
        {
            content:"insertpromocode'testcode'",
            extra_trigger:'form[name="coupon_code"]',
            trigger:'form[name="coupon_code"]input[name="promo"]',
            run:"texttestcode",
        },
        {
            content:"validatethecoupon",
            trigger:'form[name="coupon_code"].a-submit',
        },
        {
            content:"checkrewardproduct",
            trigger:'.reward_product:contains("10.0%discountontotalamount")',
            run:function(){},//it'sacheck
        },
        /*2.Addsomecabinettogetafreeone,playwithquantity*/
        {
            content:"gotoshop",
            trigger:'.reward_product:contains("10.0%discountontotalamount")',
            run:function(){
                ajax.jsonRpc('/web/dataset/call','call',{
                    model:'account.tax',
                    method:'create',
                    args:[{
                      'name':'15%taxincl'+_.now(),
                      'amount':15,
                    }],
                }).then(function(tax_id){
                    ajax.jsonRpc('/web/dataset/call','call',{
                        model:'product.template',
                        method:'create',
                        args:[{
                          'name':'TaxedProduct',
                          'taxes_id':[([6,false,[tax_id]])],
                          'list_price':100,
                          'website_published':true,
                        }],
                    }).then(function(data){
                        location.href='/shop';
                    });
                });
            },
        },
        {
            content:"typeTaxedProductinsearch",
            trigger:'forminput[name="search"]',
            run:"textTaxedProduct",
        },
        {
            content:"startsearch",
            trigger:'form:has(input[name="search"]).oe_search_button',
        },
        {
            content:"selectTaxedProduct",
            extra_trigger:'.oe_search_found',//Waittobeonsearchresultsoritsometimesthrowsconcurenterror(sentsearchform+clickonproducton/shop)
            trigger:'.oe_product_carta:containsExact("TaxedProduct")',
        },
        {
            content:"clickon'AddtoCart'button",
            trigger:"a:contains(AddtoCart)",
        },
        {
            content:"checkreductionamountgotrecomputedandmergedbothdiscountlinesintooneonly",
            extra_trigger:'.oe_currency_value:contains("-﻿75.50"):not(#cart_total.oe_currency_value:contains("-﻿75.50"))',
            trigger:'.oe_website_sale.oe_cart',
            run:function(){},//it'sacheck
        },
        /*3.Addsomecabinettogetafreeone,playwithquantity*/
        {
            content:"addoneSmallCabinet",
            trigger:'#cart_productsinput.js_quantity',
            run:"text3",
        },
        {
            content:"checkreductionamountgotrecomputedwhenchangingqty",
            trigger:'.oe_currency_value:contains("-﻿107.50")',
            run:function(){},//it'sacheck
        },
        {
            content:"addmoreSmallCabinetintocart",
            trigger:'#cart_productsinput.js_quantity',
            run:"text4",
        },
        {
            content:"checkfreeproductisadded",
            trigger:'#wrap:has(.reward_product:contains("FreeProduct-SmallCabinet"))',
            run:function(){},//it'sacheck
        },
        {
            content:"removeonecabinetfromcart",
            trigger:'#cart_productsinput.js_quantity[value="4"]',
            run:"text3",
        },
        {
            content:"checkfreeproductisremoved",
            trigger:'#wrap:not(:has(.reward_product:contains("FreeProduct-SmallCabinet")))',
            run:function(){},//it'sacheck
        },
        /*4.Check/shop/paymentdoesnotbreakthe`mergeddiscountlinessplitpertax`(eg:with_compute_tax_id)*/
        {
            content:"gotocheckout",
            trigger:'a[href="/shop/checkout?express=1"]',
        },
        {
            content:"checktotalisunchangedoncewelandonpaymentpage",
            extra_trigger:'#payment_methodh3:contains("Paywith")',
            trigger:'tr#order_total.oe_currency_value:contains("967.50")',
            run:function(){},//it'sacheck
        },
    ]
);
});
