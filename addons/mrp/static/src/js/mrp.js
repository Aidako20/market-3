flectra.define('mrp.mrp_state',function(require){
"usestrict";

varAbstractField=require('web.AbstractField');
varcore=require('web.core');
varfields=require('web.basic_fields');
varfieldUtils=require('web.field_utils');
varfield_registry=require('web.field_registry');
vartime=require('web.time');

var_t=core._t;

/**
 *Thiswidgetisusedtodisplaytheavailabilityonaworkorder.
 */
varSetBulletStatus=AbstractField.extend({
    //asthiswidgetisbasedonhardcodedvalues,useitinanothercontext
    //probablywon'twork
    //supportedFieldTypes:['selection'],
    /**
     *@override
     */
    init:function(){
        this._super.apply(this,arguments);
        this.classes=this.nodeOptions&&this.nodeOptions.classes||{};
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     *@override
     */
    _renderReadonly:function(){
        this._super.apply(this,arguments);
        varbullet_class=this.classes[this.value]||'default';
        if(this.value){
            vartitle=this.value==='waiting'?_t('WaitingMaterials'):'';
            this.$el.attr({'title':title,'style':'display:inline'});
            this.$el.removeClass('text-successtext-dangertext-default');
            this.$el.html($('<span>'+title+'</span>').addClass('badgebadge-'+bullet_class));
        }
    }
});

varTimeCounter=fields.FieldFloatTime.extend({

    init:function(){
        this._super.apply(this,arguments);
        this.duration=this.record.data.duration;
    },

    willStart:function(){
        varself=this;
        vardef=this._rpc({
            model:'mrp.workcenter.productivity',
            method:'search_read',
            domain:[
                ['workorder_id','=',this.record.data.id],
                ['date_end','=',false],
            ],
        }).then(function(result){
            varcurrentDate=newDate();
            varduration=0;
            if(result.length>0){
                duration+=self._getDateDifference(time.auto_str_to_date(result[0].date_start),currentDate);
            }
            varminutes=duration/60>>0;
            varseconds=duration%60;
            self.duration+=minutes+seconds/60;
            if(self.mode==='edit'){
                self.value=self.duration;
            }
        });
        returnPromise.all([this._super.apply(this,arguments),def]);
    },

    destroy:function(){
        this._super.apply(this,arguments);
        clearTimeout(this.timer);
    },

    //--------------------------------------------------------------------------
    //Public
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    isSet:function(){
        returntrue;
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *Computethedifferencebetweentwodates.
     *
     *@private
     *@param{string}dateStart
     *@param{string}dateEnd
     *@returns{integer}thedifferenceinmillisecond
     */
    _getDateDifference:function(dateStart,dateEnd){
        returnmoment(dateEnd).diff(moment(dateStart),'seconds');
    },
    /**
     *@override
     */
    _renderReadonly:function(){
        if(this.record.data.is_user_working){
            this._startTimeCounter();
        }else{
            this._super.apply(this,arguments);
        }
    },
    /**
     *@private
     */
    _startTimeCounter:function(){
        varself=this;
        clearTimeout(this.timer);
        if(this.record.data.is_user_working){
            this.timer=setTimeout(function(){
                self.duration+=1/60;
                self._startTimeCounter();
            },1000);
        }else{
            clearTimeout(this.timer);
        }
        this.$el.text(fieldUtils.format.float_time(this.duration));
    },
});

varFieldEmbedURLViewer=fields.FieldChar.extend({

    //--------------------------------------------------------------------------
    //Public
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    init:function(){
        this._super.apply(this,arguments);
        this.page=1;
        this.srcDirty=false;
    },

    /**
     *forcetoset'src'forembediframeviewerwhenitsvaluehaschanged
     *
     *@override
     *
     */
    reset:function(){
        this._super.apply(this,arguments);
        this._updateIframePreview();
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *Initializesandreturnsaniframefortheviewer
     *
     *@private
     *@returns{jQueryElement}
     */
    _prepareIframe:function(){
        return$('<iframe>',{
            class:'o_embed_iframed-none',
            allowfullscreen:true,
        });
    },

    /**
     *@override
     *@private
     */
    _renderEdit:function(){
        if(!this.$('iframe.o_embed_iframe').length){
            this.$input=this.$el;
            this.setElement(this.$el.wrap('<divclass="o_embed_url_viewero_field_widget"/>').parent());
            this.$el.append(this._prepareIframe());
        }
        this._prepareInput(this.$input);

        //Donotsetiframesrcifwidgetisinvisible
        if(!this.record.evalModifiers(this.attrs.modifiers).invisible){
            this._updateIframePreview();
        }else{
            this.srcDirty=true;
        }
    },
    /**
     *@override
     *@private
     */
    _renderReadonly:function(){
        if(!this.$('iframe.o_embed_iframe').length){
            this.$el.addClass('o_embed_url_viewer');
            this.$el.append(this._prepareIframe());
        }
        this._updateIframePreview();
    },
    /**
     *Settheassociatedsrcforembediframeviewer
     *
     *@private
     *@returns{string}sourceofthegoogleslide
     */
    _getEmbedSrc:function(){
        varsrc=false;
        if(this.value){
            //checkgivengoogleslideurlisvalidornot
            vargoogleRegExp=/(^https:\/\/docs.google.com).*(\/d\/e\/|\/d\/)([A-Za-z0-9-_]+)/;
            vargoogle=this.value.match(googleRegExp);
            if(google&&google[3]){
                src='https://docs.google.com/presentation'+google[2]+google[3]+'/preview?slide='+this.page;
            }
        }
        returnsrc||this.value;
    },
    /**
     *updateiframeattrs
     *
     *@private
     */
    _updateIframePreview:function(){
        var$iframe=this.$('iframe.o_embed_iframe');
        varsrc=this._getEmbedSrc();
        $iframe.toggleClass('d-none',!src);
        if(src){
            $iframe.attr('src',src);
        }else{
            $iframe.removeAttr('src');
        }
    },
    /**
     *Listentomodifiersupdatestoandonlyrenderiframewhenitisnecessary
     *
     *@override
     */
    updateModifiersValue:function(){
        this._super.apply(this,arguments);
        if(!this.attrs.modifiersValue.invisible&&this.srcDirty){
            this._updateIframePreview();
            this.srcDirty=false;
        }
    },
});


field_registry
    .add('bullet_state',SetBulletStatus)
    .add('mrp_time_counter',TimeCounter)
    .add('embed_viewer',FieldEmbedURLViewer);

fieldUtils.format.mrp_time_counter=fieldUtils.format.float_time;

returnFieldEmbedURLViewer;
});
