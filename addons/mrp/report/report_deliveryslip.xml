<?xmlversion="1.0"encoding="utf-8"?>
<flectra>
    <templateid="stock_report_delivery_document_inherit_mrp"inherit_id="stock.report_delivery_document">
        <!--needstobesetbeforesoelifdirectlyfollowsiflateron-->
        <xpathexpr="//t[@name='has_packages']"position="before">
            <!--getonlythetoplevelkits'(i.e.nosubkit)movelinesforeasiermappinglateron+weignoresubkitgroupings-->
            <!--notethatmove.nameusestoplevelkit'sproduct.template.display_namevalueinsteadofproduct.template.name-->
            <!--Producttemplatefornon-variantandproductidforvariantbom-->
            <tt-set="has_kits"t-value="o.move_line_ids.filtered(lambdal:l.move_id.bom_line_idandl.move_id.namein(l.move_id.bom_line_id.bom_id.product_tmpl_id.display_name,l.move_id.bom_line_id.bom_id.product_id.display_name))"/>
        </xpath>
        <xpathexpr="//t[@name='no_package_section']"position="before">
            <tt-set="has_kits"t-value="move_lines.filtered(lambdal:l.move_id.bom_line_idandl.move_id.namein(l.move_id.bom_line_id.bom_id.product_tmpl_id.display_name,l.move_id.bom_line_id.bom_id.product_id.display_name))"/>
            <tt-if="has_kits">
                <!--printtheproductsnotinapackageorkitfirst-->
                <tt-set="move_lines"t-value="move_lines.filtered(lambdam:notm.move_id.bom_line_id)"/>
            </t>
        </xpath>
        <xpathexpr="//t[@name='no_package_move_lines']"position="inside">
            <tt-call="mrp.stock_report_delivery_kit_sections"/>
        </xpath>
        <xpathexpr="//t[@name='has_packages']"position="after">
            <!--Additionalusecase:groupbykitswhennopackagesexistandthenapplyusecase1.(serial/lotnumbersused/printed)-->
            <tt-elif="has_kitsandnothas_packages">
                <tt-call="mrp.stock_report_delivery_kit_sections"/>
                <tt-call="mrp.stock_report_delivery_no_kit_section"/>
            </t>
        </xpath>
    </template>

    <templateid="stock_report_delivery_kit_sections">
        <!--getallkits-relatedSML,includingsubkitsandexcludingthepackagedSML-->
        <tt-set="all_kits_move_lines"t-value="o.move_line_ids.filtered(lambdal:l.move_id.bom_line_id.bom_id.type=='phantom'andnotl.result_package_id)"/>
        <!--doanothermaptogetuniquetoplevelkits-->
        <tt-set="boms"t-value="has_kits.mapped('move_id.bom_line_id.bom_id')"/>
        <tt-foreach="boms"t-as="bom">
            <!--Separateproduct.productfromtemplateforvariants-->
            <tt-if="bom.product_id">
                <tt-set="kit"t-value="bom.product_id"/>
            </t>
            <tt-else="">
                <tt-set="kit"t-value="bom.product_tmpl_id"/>
            </t>
            <trt-att-class="'bg-200font-weight-boldo_line_section'">
                <tdcolspan="99">
                    <spant-esc="kit.display_name"/>
                </td>
            </tr>
            <tt-set="kit_move_lines"t-value="all_kits_move_lines.filtered(lambdal:l.move_id.name==kit.display_name)"/>
            <tt-if="has_serial_number">
                <trt-foreach="kit_move_lines"t-as="move_line">
                    <tt-set="description"t-value="move_line.move_id.description_picking"/>
                    <tt-if="description==kit.display_name">
                        <tt-set="description"t-value=""/>
                    </t>
                    <tt-call="stock.stock_report_delivery_has_serial_move_line"/>
                </tr>
            </t>
            <tt-else="">
                <!--movelinedescriptionbydefaultistheproduct_template.name(kitname),insteadofdisplay_name-->
                <tt-set="aggregated_lines"t-value="kit_move_lines._get_aggregated_product_quantities(kit_name=kit.display_name)"/>
                <tt-if="aggregated_lines">
                    <tt-call="stock.stock_report_delivery_aggregated_move_lines"/>
                </t>
            </t>
        </t>
    </template>

    <!--Nokitsectionisexpectedtoonlybecalledinnopackagescase-->
    <templateid="stock_report_delivery_no_kit_section">
        <!--Doanothersectionforkit-lessproductsiftheyexist-->
        <tt-set="no_kit_move_lines"t-value="o.move_line_ids.filtered(lambdal:notl.move_id.bom_line_id)"/>
        <tt-if="no_kit_move_lines">
            <trt-att-class="'bg-200font-weight-boldo_line_section'">
                <tdcolspan="99">
                    <span>Productsnotassociatedwithakit</span>
                </td>
            </tr>
            <tt-if="has_serial_number">
                <trt-foreach="no_kit_move_lines"t-as="move_line">
                    <tt-call="stock.stock_report_delivery_has_serial_move_line"/>
                </tr>
            </t>
            <tt-else="">
                <tt-set="aggregated_lines"t-value="no_kit_move_lines._get_aggregated_product_quantities()"/>
                <tt-if="aggregated_lines">
                    <tt-call="stock.stock_report_delivery_aggregated_move_lines"/>
                </t>
            </t>
        </t>
    </template>
</flectra>
