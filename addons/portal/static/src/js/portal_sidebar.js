flectra.define('portal.PortalSidebar',function(require){
'usestrict';

varcore=require('web.core');
varpublicWidget=require('web.public.widget');
vartime=require('web.time');
varsession=require('web.session');

var_t=core._t;

varPortalSidebar=publicWidget.Widget.extend({
    /**
     *@override
     */
    start:function(){
        this._setDelayLabel();
        returnthis._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Private
    //---------------------------------------------------------------------------

    /**
     *Setthedue/delayinformationaccordingtothegivendate
     *like:<spanclass="o_portal_sidebar_timeago"t-att-datetime="invoice.date_due"/>
     *
     *@private
     */
    _setDelayLabel:function(){
        var$sidebarTimeago=this.$el.find('.o_portal_sidebar_timeago');
        _.each($sidebarTimeago,function(el){
            vardateTime=moment(time.auto_str_to_date($(el).attr('datetime'))),
                today=moment().startOf('day'),
                diff=dateTime.diff(today,'days',true),
                displayStr;

            session.is_bound.then(function(){
                if(diff===0){
                    displayStr=_t('Duetoday');
                }elseif(diff>0){
                    //Workaround:forceuniquenessofthesetwotranslations.Weuse%1dbecausethestring
                    //with%disalreadyusedinmailandmail'stranslationsarenotsenttothefrontend.
                    displayStr=_.str.sprintf(_t('Duein%1ddays'),Math.abs(diff));
                }else{
                    displayStr=_.str.sprintf(_t('%1ddaysoverdue'),Math.abs(diff));
                }
                $(el).text(displayStr);
            });
        });
    },
    /**
     *@private
     *@param{string}href
     */
    _printIframeContent:function(href){
        //duetothisissue:https://bugzilla.mozilla.org/show_bug.cgi?id=911444
        //openanewwindowwithpdfforprintinFirefox(inothersystem:http://printjs.crabbly.com)
        if($.browser.mozilla){
            window.open(href,'_blank');
            return;
        }
        if(!this.printContent){
            this.printContent=$('<iframeid="print_iframe_content"src="'+href+'"style="display:none"></iframe>');
            this.$el.append(this.printContent);
            this.printContent.on('load',function(){
                $(this).get(0).contentWindow.print();
            });
        }else{
            this.printContent.get(0).contentWindow.print();
        }
    },
});
returnPortalSidebar;
});
