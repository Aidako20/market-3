flectra.define('website_livechat.tour_common',function(require){
'usestrict';

varsession=require('web.session');
varLivechatButton=require('im_livechat.legacy.im_livechat.im_livechat').LivechatButton;

/**
 *Alterthismethodfortestpurposes.
 *
 *Fakethenotificationaftersendingmessage
 *Asbusisnotavailable,it'snecessarytoaddthemessageinthechatter+inlivechat.messages
 *
 *AddaclasstothechatterwindowaftersendFeedbackisdone
 *toforcethetesttowaituntilfeedbackisreallydone
 *(tocheckafterwardsifthelivechatsessionissettoinactive)
 *
 *Note:thisassetisloadedfortestsonly(rpccalldoneonlyduringtests)
 */
LivechatButton.include({
    _sendMessage:function(message){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(){
            if(message.isFeedback){
                $('div.o_thread_window_header').addClass('feedback_sent');
            }
            else{
                session.rpc('/bus/test_mode_activated',{}).then(function(in_test_mode){
                    if(in_test_mode){
                        varnotification=[
                            self._livechat.getUUID(),
                            {
                                'id':-1,
                                'author_id':[0,'WebsiteVisitorTest'],
                                'email_from':'WebsiteVisitorTest',
                                'body':'<p>'+message.content+'</p>',
                                'is_discussion':true,
                                'subtype_id':[1,"Discussions"],
                                'date':moment().format('YYYY-MM-DDHH:mm:ss'),
                            }
                        ]
                        self._handleNotification(notification);
                    }
                });
            }
        });
    },
});

/*******************************
*        CommonSteps
*******************************/

varstartStep=[{
    content:"clickonlivechatwidget",
    trigger:"div.o_livechat_button"
},{
    content:"Sayhello!",
    trigger:"input.o_composer_text_field",
    run:"textHelloSir!"
},{
    content:"Sendthemessage",
    trigger:"input.o_composer_text_field",
    run:function(){
        $('input.o_composer_text_field').trigger($.Event('keydown',{which:$.ui.keyCode.ENTER}));
    }
},{
    content:"Verifyyourmessagehasbeentyped",
    trigger:"div.o_thread_message_content>p:contains('HelloSir!')"
},{
    content:"Verifythereisnoduplicates",
    trigger:"body",
    run:function(){
        if($("div.o_thread_message_contentp:contains('HelloSir!')").length===1){
            $('body').addClass('no_duplicated_message');
        }
    }
},{
    content:"Isyourmessagecorrectlysent?",
    trigger:'body.no_duplicated_message'
}];

varendDiscussionStep=[{
    content:"Closethechatter",
    trigger:"a.o_thread_window_close",
    run:function(){
        $('a.o_thread_window_close').click();
    }
}];

varfeedbackStep=[{
    content:"Typeafeedback",
    trigger:"div.o_livechat_rating_reason>textarea",
    run:"text;-)Thiswasreallyhelpful.Thanks;-)!"
},{
    content:"Sendthefeedback",
    trigger:"button[type='button'].o_rating_submit_button",
},{
    content:"Checkiffeedbackhasbeensent",
    trigger:"div.o_thread_window_header.feedback_sent",
},{
    content:"Thanksforyourfeedback",
    trigger:"div.o_livechat_rating_box:has(div:contains('Thankyouforyourfeedback'))",
}];

vartranscriptStep=[{
    content:"Typeyouremail",
    trigger:"input[id='o_email']",
    run:"textdeboul@onner.com"
},{
    content:"Sendtheconversationtoyouremailaddress",
    trigger:"button.o_email_chat_button",
},{
    content:"Typeyouremail",
    trigger:"div.o_livechat_email:has(strong:contains('ConversationSent'))",
}];

varcloseStep=[{
    content:"Closetheconversationwiththexbutton",
    trigger:"a.o_thread_window_close",
}, {
    content:"Checkthatthechatwindowisclosed",
    trigger:'body',
    run:function(){
        if($('div.o_livechat_button').length===1&&!$('div.o_livechat_button').is(':visible')){
            $('body').addClass('tour_success');
        }
    }
},{
    content:"IstheTestsucceded?",
    trigger:'body.tour_success'
}];

vargoodRatingStep=[{
    content:"SendGoodRating",
    trigger:"div.o_livechat_rating_choices>img[data-value=5]",
},{
    content:"Checkiffeedbackhasbeensent",
    trigger:"div.o_thread_window_header.feedback_sent",
},{
    content:"Thanksforyourfeedback",
    trigger:"div.o_livechat_rating_box:has(div:contains('Thankyouforyourfeedback'))"
}];

varokRatingStep=[{
    content:"SendokRating",
    trigger:"div.o_livechat_rating_choices>img[data-value=3]",
}];

varsadRatingStep=[{
    content:"SendbadRating",
    trigger:"div.o_livechat_rating_choices>img[data-value=1]",
}];

return{
    'startStep':startStep,
    'endDiscussionStep':endDiscussionStep,
    'transcriptStep':transcriptStep,
    'feedbackStep':feedbackStep,
    'closeStep':closeStep,
    'goodRatingStep':goodRatingStep,
    'okRatingStep':okRatingStep,
    'sadRatingStep':sadRatingStep,
};

});
