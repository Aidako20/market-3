flectra.define('website_sale.recently_viewed',function(require){

varconcurrency=require('web.concurrency');
varconfig=require('web.config');
varcore=require('web.core');
varpublicWidget=require('web.public.widget');
varutils=require('web.utils');
varwSaleUtils=require('website_sale.utils');

varqweb=core.qweb;

publicWidget.registry.productsRecentlyViewedSnippet=publicWidget.Widget.extend({
    selector:'.s_wsale_products_recently_viewed',
    xmlDependencies:['/website_sale/static/src/xml/website_sale_recently_viewed.xml'],
    disabledInEditableMode:false,
    read_events:{
        'click.js_add_cart':'_onAddToCart',
        'click.js_remove':'_onRemove',
    },

    /**
     *@constructor
     */
    init:function(){
        this._super.apply(this,arguments);
        this._dp=newconcurrency.DropPrevious();
        this.uniqueId=_.uniqueId('o_carousel_recently_viewed_products_');
        this._onResizeChange=_.debounce(this._addCarousel,100);
    },
    /**
     *@override
     */
    start:function(){
        this._dp.add(this._fetch()).then(this._render.bind(this));
        $(window).resize(()=>{
            this._onResizeChange();
        });
        returnthis._super.apply(this,arguments);
    },
    /**
     *@override
     */
    destroy:function(){
        this._super(...arguments);
        this.$el.addClass('d-none');
        this.$el.find('.slider').html('');
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _fetch:function(){
        returnthis._rpc({
            route:'/shop/products/recently_viewed',
        }).then(res=>{
            varproducts=res['products'];

            //Ineditmode,ifthecurrentvisitorhasnorecentlyviewed
            //products,usedemodata.
            if(this.editableMode&&(!products||!products.length)){
                return{
                    'products':[{
                        id:0,
                        website_url:'#',
                        display_name:'Product1',
                        price:'$<spanclass="oe_currency_value">750.00</span>',
                    },{
                        id:0,
                        website_url:'#',
                        display_name:'Product2',
                        price:'$<spanclass="oe_currency_value">750.00</span>',
                    },{
                        id:0,
                        website_url:'#',
                        display_name:'Product3',
                        price:'$<spanclass="oe_currency_value">750.00</span>',
                    },{
                        id:0,
                        website_url:'#',
                        display_name:'Product4',
                        price:'$<spanclass="oe_currency_value">750.00</span>',
                    }],
                };
            }

            returnres;
        });
    },
    /**
     *@private
     */
    _render:function(res){
        varproducts=res['products'];
        varmobileProducts=[],webProducts=[],productsTemp=[];
        _.each(products,function(product){
            if(productsTemp.length===4){
                webProducts.push(productsTemp);
                productsTemp=[];
            }
            productsTemp.push(product);
            mobileProducts.push([product]);
        });
        if(productsTemp.length){
            webProducts.push(productsTemp);
        }

        this.mobileCarousel=$(qweb.render('website_sale.productsRecentlyViewed',{
            uniqueId:this.uniqueId,
            productFrame:1,
            productsGroups:mobileProducts,
        }));
        this.webCarousel=$(qweb.render('website_sale.productsRecentlyViewed',{
            uniqueId:this.uniqueId,
            productFrame:4,
            productsGroups:webProducts,
        }));
        this._addCarousel();
        this.$el.toggleClass('d-none',!(products&&products.length));
    },
    /**
     *Addtherightcarouseldependingonscreensize.
     *@private
     */
    _addCarousel:function(){
        varcarousel=config.device.size_class<=config.device.SIZES.SM?this.mobileCarousel:this.webCarousel;
        this.$('.slider').html(carousel).css('display','');//Removingdisplayiskeptforcompatibility(itwashiddenbefore)
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Addproducttocartandreloadthecarousel.
     *@private
     *@param{Event}ev
     */
    _onAddToCart:function(ev){
        varself=this;
        var$card=$(ev.currentTarget).closest('.card');
        this._rpc({
            route:"/shop/cart/update_json",
            params:{
                product_id:$card.find('input[data-product-id]').data('product-id'),
                add_qty:1
            },
        }).then(function(data){
            wSaleUtils.updateCartNavBar(data);
            var$navButton=$('header.o_wsale_my_cart').first();
            varfetch=self._fetch();
            varanimation=wSaleUtils.animateClone($navButton,$(ev.currentTarget).parents('.o_carousel_product_card'),25,40);
            Promise.all([fetch,animation]).then(function(values){
                self._render(values[0]);
            });
        });
    },

    /**
     *Removeproductfromrecentlyviewedproducts.
     *@private
     *@param{Event}ev
     */
    _onRemove:function(ev){
        varself=this;
        var$card=$(ev.currentTarget).closest('.card');
        this._rpc({
            route:"/shop/products/recently_viewed_delete",
            params:{
                product_id:$card.find('input[data-product-id]').data('product-id'),
            },
        }).then(function(data){
            self._render(data);
        });
    },
});

publicWidget.registry.productsRecentlyViewedUpdate=publicWidget.Widget.extend({
    selector:'#product_detail',
    events:{
        'changeinput.product_id[name="product_id"]':'_onProductChange',
    },
    debounceValue:8000,

    /**
     *@constructor
     */
    init:function(){
        this._super.apply(this,arguments);
        this._onProductChange=_.debounce(this._onProductChange,this.debounceValue);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *Debouncedmethodthatwaitsometimebeforemarkingtheproductasviewed.
     *@private
     *@param{HTMLInputElement}$input
     */
    _updateProductView:function($input){
        varproductId=parseInt($input.val());
        varcookieName='seen_product_id_'+productId;
        if(!parseInt(this.el.dataset.viewTrack,10)){
            return;//Isnottracked
        }
        if(utils.get_cookie(cookieName)){
            return;//Alreadytrackedinthelast30min
        }
        if($(this.el).find('.js_product.css_not_available').length){
            return;//Variantnotpossible
        }
        this._rpc({
            route:'/shop/products/recently_viewed_update',
            params:{
                product_id:productId,
            }
        }).then(function(res){
            if(res&&res.visitor_uuid){
                utils.set_cookie('visitor_uuid',res.visitor_uuid);
            }
            utils.set_cookie(cookieName,productId,30*60);
        });
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *Calldebouncedmethodwhenproductchangetoresettimer.
     *@private
     *@param{Event}ev
     */
    _onProductChange:function(ev){
        this._updateProductView($(ev.currentTarget));
    },
});
});
