<?xmlversion="1.0"encoding="utf-8"?>
<flectra>
    <data>
        <templateid="account_invoice_line_facturx_export_22">
            <tt-set="line"t-value="line_vals['line']"/>
            <t xmlns:ram="urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100"
                xmlns:rsm="urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100"
                xmlns:udt="urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100">

                <ram:IncludedSupplyChainTradeLineItem>
                    <!--Linenumber.-->
                    <ram:AssociatedDocumentLineDocument>
                        <ram:LineIDt-esc="line_vals.get('index')"/>
                    </ram:AssociatedDocumentLineDocument>

                    <!--Product.-->
                    <ram:SpecifiedTradeProduct>
                        <ram:GlobalID
                            schemeID="0160"
                            t-if="line.product_idandline.product_id.barcode"
                            t-esc="line.product_id.barcode"/>
                        <ram:SellerAssignedID
                            t-if="line.product_idandline.product_id.default_code"
                            t-esc="line.product_id.default_code"/>
                        <ram:Namet-esc="line.name"/>
                    </ram:SpecifiedTradeProduct>

                    <!--Amounts.-->
                    <ram:SpecifiedLineTradeAgreement>
                        <!--Lineinformation:unit_price
                        NB:thegross_price_unitshouldbethepricetaxexcluded!
                        ifprice_unit=100andtax10%price_include->thenthegross_price_unitis91
                        -->
                        <ram:GrossPriceProductTradePrice>
                            <ram:ChargeAmountt-esc="format_monetary(line_vals['gross_price_total_unit'],2)"/>
                            <!--Discount.-->
                            <ram:AppliedTradeAllowanceCharget-if="line.discount">
                                <ram:ChargeIndicator>
                                    <udt:Indicator>false</udt:Indicator>
                                </ram:ChargeIndicator>
                                <ram:ActualAmountt-esc="format_monetary(line_vals['price_discount_unit'],2)"/>
                            </ram:AppliedTradeAllowanceCharge>
                        </ram:GrossPriceProductTradePrice>
                        <!--Lineunitprice,withdiscountapplied-->
                        <ram:NetPriceProductTradePrice>
                            <ram:ChargeAmount
                                t-esc="format_monetary(line_vals['price_subtotal_unit'],2)"/>
                        </ram:NetPriceProductTradePrice>
                    </ram:SpecifiedLineTradeAgreement>

                    <!--Quantity.-->
                    <ram:SpecifiedLineTradeDelivery>
                        <ram:BilledQuantity
                                t-att-unitCode="line_vals.get('unece_uom_code')"
                                t-esc="line.quantity"/><!--/!\Thequantityistheline.quantitysincewekeeptheunece_uom_code!-->
                    </ram:SpecifiedLineTradeDelivery>

                    <ram:SpecifiedLineTradeSettlement>
                        <tt-foreach="tax_details['invoice_line_tax_details'][line]['tax_details'].values()"
                           t-as="tax_detail_vals">
                            <ram:ApplicableTradeTaxt-if="tax_detail_vals['amount_type']=='percent'">
                                <ram:TypeCode>VAT</ram:TypeCode>
                                <ram:CategoryCodet-esc="tax_detail_vals['tax_category_code']"/>
                                <ram:RateApplicablePercentt-esc="tax_detail_vals['amount']"/>
                            </ram:ApplicableTradeTax>
                        </t>

                        <!--Allowance/Chargeontheline-->
                        <tt-foreach="line_vals.get('allowance_charge_vals_list')"t-as="allowance_charge_vals">
                            <ram:SpecifiedTradeAllowanceCharge>
                                <ram:ChargeIndicator>
                                    <udt:Indicatort-esc="allowance_charge_vals['indicator']"/>
                                </ram:ChargeIndicator>
                                <ram:ActualAmountt-esc="format_monetary(allowance_charge_vals['amount'],2)"/>
                                <ram:ReasonCodet-esc="allowance_charge_vals['reason_code']"/>
                                <ram:Reasont-esc="allowance_charge_vals['reason']"/>
                            </ram:SpecifiedTradeAllowanceCharge>
                        </t>

                        <!--Subtotal.-->
                        <ram:SpecifiedTradeSettlementLineMonetarySummation>
                            <ram:LineTotalAmountt-esc="format_monetary(line_vals['line_total_amount'],2)"/>
                        </ram:SpecifiedTradeSettlementLineMonetarySummation>

                    </ram:SpecifiedLineTradeSettlement>
                </ram:IncludedSupplyChainTradeLineItem>
            </t>
        </template>

        <templateid="account_invoice_partner_facturx_export_22">
            <t xmlns:ram="urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100"
                xmlns:rsm="urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100"
                xmlns:udt="urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100">
                <!--Contact.-->
                <ram:Namet-esc="partner.name"/>
                <ram:SpecifiedLegalOrganizationt-if="specified_legal_organization_val">
                    <ram:IDt-att-schemeID="str('0002')"
                            t-esc="specified_legal_organization_val"/>
                </ram:SpecifiedLegalOrganization>

                <ram:DefinedTradeContactt-if="nothide_dtc">
                    <ram:PersonNamet-esc="partner.name"/>
                    <ram:TelephoneUniversalCommunicationt-if="partner.phoneorpartner.mobile">
                        <ram:CompleteNumbert-esc="partner.phoneorpartner.mobile"/>
                    </ram:TelephoneUniversalCommunication>
                    <ram:EmailURIUniversalCommunicationt-if="partner.email">
                        <ram:URIIDschemeID='SMTP't-esc="partner.email"/>
                    </ram:EmailURIUniversalCommunication>
                </ram:DefinedTradeContact>

                <!--Address.-->
                <tt-call="account_edi_ubl_cii.account_invoice_address_facturx_export_22"/>
            </t>
        </template>

        <templateid="account_invoice_address_facturx_export_22">
            <t xmlns:ram="urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100"
                xmlns:rsm="urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100"
                xmlns:udt="urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100">
                <!--Address.-->
                <ram:PostalTradeAddress>
                    <ram:PostcodeCodet-esc="partner.zip"/>
                    <ram:LineOnet-esc="partner.street"/>
                    <ram:LineTwot-esc="partner.street2"/>
                    <ram:CityNamet-esc="partner.city"/>
                    <ram:CountryIDt-esc="partner.country_id.code"/>
                </ram:PostalTradeAddress>
            </t>
        </template>

        <templateid="account_invoice_facturx_export_22">
            <tt-set="currency"t-value="record.currency_idorrecord.company_currency_id"/>
            <rsm:CrossIndustryInvoice
                xmlns:ram="urn:un:unece:uncefact:data:standard:ReusableAggregateBusinessInformationEntity:100"
                xmlns:rsm="urn:un:unece:uncefact:data:standard:CrossIndustryInvoice:100"
                xmlns:udt="urn:un:unece:uncefact:data:standard:UnqualifiedDataType:100">
                <!--Factur-xlevel:
                    *minimumorbasicwl:  urn:factur-x.eu:1p0...
                    *basic:               urn:cen.eu:en16931:2017:compliant:factur-x.eu:1p0:basic
                    *en16931:             urn:cen.eu:en16931:2017
                -->
                <rsm:ExchangedDocumentContext>
                    <ram:GuidelineSpecifiedDocumentContextParameter>
                        <ram:IDt-esc="document_context_id"/>
                    </ram:GuidelineSpecifiedDocumentContextParameter>
                </rsm:ExchangedDocumentContext>

                <!--DocumentHeaders.-->
                <rsm:ExchangedDocument>
                    <ram:IDt-esc="ExchangedDocument_vals.get('id')"/>
                    <ram:TypeCodet-esc="ExchangedDocument_vals.get('type_code')"/>
                    <ram:IssueDateTimet-if="ExchangedDocument_vals.get('issue_date_time')">
                        <udt:DateTimeStringformat="102"t-esc="format_date(ExchangedDocument_vals.get('issue_date_time'))"/>
                    </ram:IssueDateTime>
                    <ram:IncludedNote>
                        <ram:Contentt-esc="ExchangedDocument_vals.get('included_note')"/>
                    </ram:IncludedNote>
                </rsm:ExchangedDocument>

                <rsm:SupplyChainTradeTransaction>
                    <!--Invoicelines.-->
                    <tt-foreach="invoice_line_vals_list"t-as="line_vals">
                        <tt-call="account_edi_ubl_cii.account_invoice_line_facturx_export_22"/>
                    </t>

                    <!--Partners.-->
                    <ram:ApplicableHeaderTradeAgreement>
                        <!--"ServiceExÃ©cutant"(UsedbyChorusPro)-->
                        <ram:BuyerReferencet-esc="buyer_reference"/>
                        <!--Seller.-->
                        <ram:SellerTradeParty>
                            <!--Address.-->
                            <tt-call="account_edi_ubl_cii.account_invoice_partner_facturx_export_22">
                                <tt-set="partner"t-value="record.company_id.partner_id"/>
                                <tt-set="specified_legal_organization_val"t-value="seller_specified_legal_organization"/>
                            </t>

                            <!--VAT.-->
                            <ram:SpecifiedTaxRegistrationt-if="record.company_id.vat">
                                <ram:IDschemeID="VA"t-esc="record.company_id.vat"/>
                            </ram:SpecifiedTaxRegistration>
                        </ram:SellerTradeParty>

                        <!--Customer.-->
                        <ram:BuyerTradeParty>
                            <!--Address.-->
                            <tt-call="account_edi_ubl_cii.account_invoice_partner_facturx_export_22">
                                <tt-set="partner"t-value="record.commercial_partner_id"/>
                                <tt-set="specified_legal_organization_val"t-value="buyer_specified_legal_organization"/>
                            </t>

                            <!--VAT.-->
                            <ram:SpecifiedTaxRegistrationt-if="record.commercial_partner_id.vat">
                                <ram:IDschemeID="VA"t-esc="record.commercial_partner_id.vat"/>
                            </ram:SpecifiedTaxRegistration>
                        </ram:BuyerTradeParty>

                        <!--Reference.-->
                        <ram:BuyerOrderReferencedDocument>
                            <!--"EngagementJuridique"(usedbyChorusPro)-->
                            <ram:IssuerAssignedIDt-esc="purchase_order_reference"/>
                        </ram:BuyerOrderReferencedDocument>
                        <ram:ContractReferencedDocument>
                            <!--"NumÃ©rodeMarchÃ©"(UsedbyChorusPro)-->
                            <ram:IssuerAssignedIDt-esc="contract_reference"/>
                        </ram:ContractReferencedDocument>
                    </ram:ApplicableHeaderTradeAgreement>

                    <!--Delivery-->
                    <ram:ApplicableHeaderTradeDelivery>
                        <ram:ShipToTradeParty>
                            <tt-call="account_edi_ubl_cii.account_invoice_partner_facturx_export_22">
                                <tt-set="partner"
                                   t-value="ship_to_trade_party"/>
                                <tt-set="hide_dtc"t-value="document_context_id=='urn:cen.eu:en16931:2017#compliant#urn:xoev-de:kosit:standard:xrechnung_2.2'"/>
                            </t>
                        </ram:ShipToTradeParty>

                        <ram:ActualDeliverySupplyChainEventt-if="scheduled_delivery_time">
                            <ram:OccurrenceDateTime>
                                <udt:DateTimeStringt-att-format="102"
                                                    t-esc="format_date(scheduled_delivery_time)"/>
                            </ram:OccurrenceDateTime>
                        </ram:ActualDeliverySupplyChainEvent>
                    </ram:ApplicableHeaderTradeDelivery>

                    <!--Taxes.-->
                    <ram:ApplicableHeaderTradeSettlement>

                        <ram:PaymentReferencet-esc="record.payment_reference"/>
                        <ram:InvoiceCurrencyCodet-esc="currency.name"/>

                        <!--Bankaccount.-->
                        <ram:SpecifiedTradeSettlementPaymentMeanst-if="record.partner_bank_id.sanitized_acc_number">
                            <ram:TypeCode>42</ram:TypeCode>
                            <ram:PayeePartyCreditorFinancialAccount>
                                <ram:IBANID
                                    t-if="record.partner_bank_id.sanitized_acc_number=='iban'"
                                    t-esc="record.partner_bank_id.sanitized_acc_number"/>
                                <ram:ProprietaryID
                                    t-if="record.partner_bank_id.sanitized_acc_number!='iban'"
                                    t-esc="record.partner_bank_id.sanitized_acc_number"/>
                            </ram:PayeePartyCreditorFinancialAccount>
                        </ram:SpecifiedTradeSettlementPaymentMeans>

                        <!--TaxSummary.-->
                        <tt-foreach="tax_details.get('tax_details',{}).values()"t-as="tax_detail_vals">
                            <ram:ApplicableTradeTax>
                                <ram:CalculatedAmount
                                    t-esc="format_monetary(tax_detail_vals.get('calculated_amount'),2)"/>
                                <ram:TypeCode>VAT</ram:TypeCode>
                                <ram:ExemptionReasont-esc="tax_detail_vals.get('tax_exemption_reason')"/>
                                <ram:BasisAmount
                                    t-esc="format_monetary(balance_multiplicator*tax_detail_vals['base_amount_currency'],2)"/>
                                <ram:CategoryCodet-esc="tax_detail_vals['tax_category_code']"/>
                                <ram:ExemptionReasonCodet-esc="tax_detail_vals['tax_exemption_reason_code']"/>
                                <!--5=Taxisexigibleonthedateontheinvoice-->
                                <ram:DueDateTypeCode>5</ram:DueDateTypeCode>
                                <ram:RateApplicablePercent
                                    t-if="tax_detail_vals['amount_type']=='percent'"
                                    t-esc="tax_detail_vals['amount']"/>
                            </ram:ApplicableTradeTax>
                        </t>

                        <!--BillingPeriod-->
                        <ram:BillingSpecifiedPeriodt-if="billing_startandbilling_end">
                            <ram:StartDateTime>
                                <udt:DateTimeStringformat="102"t-esc="format_date(billing_start)"/>
                            </ram:StartDateTime>
                            <ram:EndDateTime>
                                <udt:DateTimeStringformat="102"t-esc="format_date(billing_end)"/>
                            </ram:EndDateTime>
                        </ram:BillingSpecifiedPeriod>

                        <!--PaymentTerm.-->
                        <ram:SpecifiedTradePaymentTerms>
                            <ram:Descriptiont-if="record.invoice_payment_term_id"t-esc="record.invoice_payment_term_id.name"/>
                            <ram:DueDateDateTimet-if="record.invoice_date_due">
                                <udt:DateTimeStringformat="102"t-esc="format_date(record.invoice_date_due)"/>
                            </ram:DueDateDateTime>
                        </ram:SpecifiedTradePaymentTerms>

                        <!--Summary.-->
                        <ram:SpecifiedTradeSettlementHeaderMonetarySummation>
                            <ram:LineTotalAmount
                                t-esc="format_monetary(tax_basis_total_amount,2)"/>
                            <ram:TaxBasisTotalAmount
                                t-esc="format_monetary(tax_basis_total_amount,2)"/>
                            <ram:TaxTotalAmount
                                t-att-currencyID="currency.name"
                                t-esc="format_monetary(tax_total_amount,2)"/>
                            <ram:GrandTotalAmount
                                t-esc="format_monetary(record.amount_total,2)"/>
                            <ram:TotalPrepaidAmount
                                t-esc="format_monetary(record.amount_total-record.amount_residual,2)"/>
                            <ram:DuePayableAmount
                                t-esc="format_monetary(record.amount_residual,2)"/>
                        </ram:SpecifiedTradeSettlementHeaderMonetarySummation>
                    </ram:ApplicableHeaderTradeSettlement>
                </rsm:SupplyChainTradeTransaction>
            </rsm:CrossIndustryInvoice>
        </template>

        <templateid="account_invoice_pdfa_3_facturx_metadata">
            <x:xmpmetaxmlns:x="adobe:ns:meta/">
                <rdf:RDFxmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
                    <rdf:Descriptionxmlns:pdfaid="http://www.aiim.org/pdfa/ns/id/"rdf:about="">
                        <pdfaid:part>3</pdfaid:part>
                        <pdfaid:conformance>B</pdfaid:conformance>
                    </rdf:Description>
                    <rdf:Descriptionxmlns:dc="http://purl.org/dc/elements/1.1/"rdf:about="">
                        <dc:title>
                            <rdf:Alt>
                                <rdf:lit-att="{'xml:lang':'x-default'}"t-esc="title"/>
                            </rdf:Alt>
                        </dc:title>
                        <dc:creator>
                            <rdf:Seq>
                                <rdf:li>Flectra</rdf:li>
                            </rdf:Seq>
                        </dc:creator>
                        <dc:description>
                            <rdf:Alt>
                                <rdf:lit-att="{'xml:lang':'x-default'}">InvoicegeneratedbyFlectra</rdf:li>
                            </rdf:Alt>
                        </dc:description>
                    </rdf:Description>
                    <rdf:Descriptionxmlns:pdf="http://ns.adobe.com/pdf/1.3/"rdf:about="">
                        <pdf:Producer>Flectra</pdf:Producer>
                    </rdf:Description>
                    <rdf:Descriptionxmlns:xmp="http://ns.adobe.com/xap/1.0/"rdf:about="">
                        <xmp:CreatorTool>Flectra</xmp:CreatorTool>
                        <xmp:CreateDatet-esc="date"/>
                        <xmp:ModifyDatet-esc="date"/>
                    </rdf:Description>
                    <rdf:Descriptionxmlns:pdfaExtension="http://www.aiim.org/pdfa/ns/extension/"
                                     xmlns:pdfaSchema="http://www.aiim.org/pdfa/ns/schema#"
                                     xmlns:pdfaProperty="http://www.aiim.org/pdfa/ns/property#"rdf:about="">
                        <pdfaExtension:schemas>
                            <rdf:Bag>
                                <rdf:lirdf:parseType="Resource">
                                    <pdfaSchema:schema>Factur-XPDFAExtensionSchema</pdfaSchema:schema>
                                    <pdfaSchema:namespaceURI>urn:factur-x:pdfa:CrossIndustryDocument:invoice:1p0#</pdfaSchema:namespaceURI>
                                    <pdfaSchema:prefix>fx</pdfaSchema:prefix>
                                    <pdfaSchema:property>
                                        <rdf:Seq>
                                            <rdf:lirdf:parseType="Resource">
                                                <pdfaProperty:name>DocumentFileName</pdfaProperty:name>
                                                <pdfaProperty:valueType>Text</pdfaProperty:valueType>
                                                <pdfaProperty:category>external</pdfaProperty:category>
                                                <pdfaProperty:description>nameoftheembeddedXMLinvoicefile</pdfaProperty:description>
                                            </rdf:li>
                                            <rdf:lirdf:parseType="Resource">
                                                <pdfaProperty:name>DocumentType</pdfaProperty:name>
                                                <pdfaProperty:valueType>Text</pdfaProperty:valueType>
                                                <pdfaProperty:category>external</pdfaProperty:category>
                                                <pdfaProperty:description>INVOICE</pdfaProperty:description>
                                            </rdf:li>
                                            <rdf:lirdf:parseType="Resource">
                                                <pdfaProperty:name>Version</pdfaProperty:name>
                                                <pdfaProperty:valueType>Text</pdfaProperty:valueType>
                                                <pdfaProperty:category>external</pdfaProperty:category>
                                                <pdfaProperty:description>TheactualversionoftheFactur-XXMLschema</pdfaProperty:description>
                                            </rdf:li>
                                            <rdf:lirdf:parseType="Resource">
                                                <pdfaProperty:name>ConformanceLevel</pdfaProperty:name>
                                                <pdfaProperty:valueType>Text</pdfaProperty:valueType>
                                                <pdfaProperty:category>external</pdfaProperty:category>
                                                <pdfaProperty:description>TheconformanceleveloftheembeddedFactur-Xdata</pdfaProperty:description>
                                            </rdf:li>
                                        </rdf:Seq>
                                    </pdfaSchema:property>
                                </rdf:li>
                            </rdf:Bag>
                        </pdfaExtension:schemas>
                    </rdf:Description>
                    <rdf:Descriptionxmlns:fx="urn:factur-x:pdfa:CrossIndustryDocument:invoice:1p0#"rdf:about="">
                        <fx:ConformanceLevel>EN16931</fx:ConformanceLevel>
                        <fx:DocumentFileName>factur-x.xml</fx:DocumentFileName>
                        <fx:DocumentType>INVOICE</fx:DocumentType>
                        <fx:Version>1.0</fx:Version>
                    </rdf:Description>
                </rdf:RDF>
            </x:xmpmeta>
        </template>

    </data>
</flectra>
