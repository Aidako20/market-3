flectra.define('bus.WebClient',function(require){
    "usestrict";

    constcore=require('web.core');
    constWebClient=require('web.WebClient');

    const_t=core._t;

    WebClient.include({

        //----------------------------------------------------------------------
        //Public
        //----------------------------------------------------------------------

        /**
         *DetectsthepresenceofassetsinDOM'sHEAD
         *
         *@override
         */
        asyncstart(){
            this._assetsChangedNotificationId=null;
            this._assets={};
            awaitthis._super(...arguments);
        },
        /**
         *Assignshandlertobusnotification
         *
         *@override
         */
        show_application(){
            constshown=this._super(...arguments);
            document.querySelectorAll('*[data-asset-xmlid]').forEach(el=>{
                this._assets[el.getAttribute('data-asset-xmlid')]=el.getAttribute('data-asset-version');
            });
            this.call('bus_service','onNotification',this,this._onNotification);
            this.call('bus_service','addChannel','bundle_changed');
            returnshown;
        },

        //----------------------------------------------------------------------
        //Private
        //----------------------------------------------------------------------

        /**
         *Displaysonenotificationonuser'sscreenwhenassetshavechanged
         *
         *@private
         */
        _displayBundleChangedNotification(){
            if(!this._assetsChangedNotificationId){
                //Wrapthenotificationinsideadelay.
                //Theservermaybeoverwhelmedwithrecomputingassets
                //Wewaituntilthingssettledown
                clearTimeout(this._bundleNotifTimerID);
                this._bundleNotifTimerID=setTimeout(()=>{
                    this._assetsChangedNotificationId=this.call('notification','notify',{
                        title:_t('Refresh'),
                        message:_t('Thepageappearstobeoutofdate.'),
                        sticky:true,
                        onClose:()=>{
                            this._assetsChangedNotificationId=null;
                        },
                        buttons:[{
                            text:_t('Refresh'),
                            primary:true,
                            click:()=>{
                                window.location.reload(true);
                            }
                        }],
                    });
                },this._getBundleNotificationDelay());
            }
        },
        /**
         *Computesarandomdelaytoavoidhammeringtheserver
         *whenbundleschangewithalltheusersreloading
         *atthesametime
         *
         *@private
         *@return{number}delayinmilliseconds
         */
        _getBundleNotificationDelay(){
            return10000+Math.floor(Math.random()*50)*1000;
        },

        //--------------------------------------------------------------------------
        //Handlers
        //--------------------------------------------------------------------------

        /**
         *Reactstobus'snotification
         *
         *@private
         *@param{Array}notifications:listofreceivednotifications
         */
        _onNotification(notifications){
            for(constnotifofnotifications){
                if(notif[0][1]==='bundle_changed'){
                    constbundleXmlId=notif[1][0];
                    constbundleVersion=notif[1][1];
                    if(bundleXmlIdinthis._assets&&bundleVersion!==this._assets[bundleXmlId]){
                        this._displayBundleChangedNotification();
                        break;
                    }
                }
            }
        }
    });
});
