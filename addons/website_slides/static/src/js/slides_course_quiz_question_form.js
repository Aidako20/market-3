flectra.define('website_slides.quiz.question.form',function(require){
'usestrict';

varpublicWidget=require('web.public.widget');
varcore=require('web.core');

varQWeb=core.qweb;
var_t=core._t;

/**
 *ThisWidgetisresponsibleofdisplayingthequestioninputswhenaddinganewquestionorwhenupdatingan
 *existingone.WhenvalidatingthequestionitmakesanRPCcalltotheserverandtriggeraneventfor
 *displayingthequestionbytheQuizwidget.
 */
varQuestionFormWidget=publicWidget.Widget.extend({
    template:'slide.quiz.question.input',
    xmlDependencies:['/website_slides/static/src/xml/slide_quiz_create.xml'],
    events:{
        'click.o_wslides_js_quiz_validate_question':'_validateQuestion',
        'click.o_wslides_js_quiz_cancel_question':'_cancelValidation',
        'click.o_wslides_js_quiz_comment_answer':'_toggleAnswerLineComment',
        'click.o_wslides_js_quiz_add_answer':'_addAnswerLine',
        'click.o_wslides_js_quiz_remove_answer':'_removeAnswerLine',
        'click.o_wslides_js_quiz_remove_answer_comment':'_removeAnswerLineComment',
        'change.o_wslides_js_quiz_answer_comment>input[type=text]':'_onCommentChanged'
    },

    /**
     *@override
     *@paramparent
     *@paramoptions
     */
    init:function(parent,options){
        this.$editedQuestion=options.editedQuestion;
        this.question=options.question||{};
        this.update=options.update;
        this.sequence=options.sequence;
        this.slideId=options.slideId;
        this._super.apply(this,arguments);
    },

    /**
     *@override
     *@returns{*}
     */
    start:function(){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(){
            self.$('.o_wslides_quiz_questioninput').focus();
        });
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *
     *@paramcommentInput
     *@private
     */
    _onCommentChanged:function(event){
        varinput=event.currentTarget;
        varcommentIcon=$(input).closest('.o_wslides_js_quiz_answer').find('.o_wslides_js_quiz_comment_answer');
        if(input.value.trim()!==''){
            commentIcon.addClass('text-primary');
            commentIcon.removeClass('text-muted');
        }else{
            commentIcon.addClass('text-muted');
            commentIcon.removeClass('text-primary');
        }
    },

    /**
     *Toggletheinputforcommentingtheanswerlinewhichwillbe
     *seenbythefrontenduserwhensubmittingthequiz.
     *@paramev
     *@private
     */
    _toggleAnswerLineComment:function(ev){
        varcommentLine=$(ev.currentTarget).closest('.o_wslides_js_quiz_answer').find('.o_wslides_js_quiz_answer_comment').toggleClass('d-none');
        commentLine.find('input[type=text]').focus();
    },

    /**
     *Addsanewanswerlineaftertheelementtheuserclickedon
     *e.g.Ifthereis3answerlinesandtheuserclickontheadd
     *     answerbuttononthesecondline,thenewanswerlinewill
     *     displaybetweenthesecondandthethirdline.
     *@paramev
     *@private
     */
    _addAnswerLine:function(ev){
        $(ev.currentTarget).closest('.o_wslides_js_quiz_answer').after(QWeb.render('slide.quiz.answer.line'));
    },

    /**
     *Removesananswerline.Can'tremovethelastanswerline.
     *@paramev
     *@private
     */
    _removeAnswerLine:function(ev){
        if(this.$('.o_wslides_js_quiz_answer').length>1){
            $(ev.currentTarget).closest('.o_wslides_js_quiz_answer').remove();
        }
    },

    /**
     *
     *@paramev
     *@private
     */
    _removeAnswerLineComment:function(ev){
        varcommentLine=$(ev.currentTarget).closest('.o_wslides_js_quiz_answer_comment').addClass('d-none');
        commentLine.find('input[type=text]').val('').change();
    },

    /**
     *Handlerwhenuserclickon'Save'or'Update'buttons.
     *@paramev
     *@private
     */
    _validateQuestion:function(ev){
        this._createOrUpdateQuestion({
            update:$(ev.currentTarget).hasClass('o_wslides_js_quiz_update'),
        });
    },

    /**
     *Handlerwhenuserclickonthe'Cancel'button.
     *Callsamethodfromslides_course_quiz.jswidget
     *whichwillhandletheresetofthequestiondisplay.
     *@private
     */
    _cancelValidation:function(){
        this.trigger_up('reset_display',{
            questionFormWidget:this,
        });
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *RPCcalltocreateorupdateaquestion.
     *Triggersmethodfromslides_course_quiz.jsto
     *correctlydisplaythequestion.
     *@paramoptions
     *@private
     */
    _createOrUpdateQuestion:function(options){
        varself=this;
        var$form=this.$('form');
        if(this._isValidForm($form)){
            varvalues=this._serializeForm($form);
            this._rpc({
                route:'/slides/slide/quiz/question_add_or_update',
                params:values
            }).then(function(renderedQuestion){
                if(options.update){
                    self.trigger_up('display_updated_question',{
                        newQuestionRenderedTemplate:renderedQuestion,
                        $editedQuestion:self.$editedQuestion,
                        questionFormWidget:self,
                    });
                }else{
                    self.trigger_up('display_created_question',{
                        newQuestionRenderedTemplate:renderedQuestion,
                        questionFormWidget:self
                    });
                }
            });
        }else{
            this.displayNotification({
                type:'warning',
                message:_t('Pleasefillinthequestion'),
                sticky:true
            });
            this.$('.o_wslides_quiz_questioninput').focus();
        }
    },

    /**
     *CheckiftheQuestionhasbeenfilledup
     *@param$form
     *@returns{boolean}
     *@private
     */
    _isValidForm:function($form){
        return$form.find('.o_wslides_quiz_questioninput[type=text]').val().trim()!=="";
    },

    /**
     *SerializetheformintoaJSONobjecttosendit
     *totheserverthroughaRPCcall.
     *@param$form
     *@returns{{id:*,sequence:*,question:*,slide_id:*,answer_ids:Array}}
     *@private
     */
    _serializeForm:function($form){
        varanswers=[];
        varsequence=1;
        $form.find('.o_wslides_js_quiz_answer').each(function(){
            varvalue=$(this).find('.o_wslides_js_quiz_answer_value').val();
            if(value.trim()!==""){
                varanswer={
                    'sequence':sequence++,
                    'text_value':value,
                    'is_correct':$(this).find('input[type=radio]').prop('checked')===true,
                    'comment':$(this).find('.o_wslides_js_quiz_answer_comment>input[type=text]').val().trim()
                };
                answers.push(answer);
            }
        });
        return{
            'existing_question_id':this.$el.data('id'),
            'sequence':this.sequence,
            'question':$form.find('.o_wslides_quiz_questioninput[type=text]').val(),
            'slide_id':this.slideId,
            'answer_ids':answers
        };
    },

});

returnQuestionFormWidget;
});
