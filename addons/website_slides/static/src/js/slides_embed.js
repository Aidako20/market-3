/**
 *ThisisaminimalversionofthePDFViewerwidget.
 *ItisNOTuseinthewebsite_slidesmodule,butitiscalledwhenembedding
 *aslide/video/document.Thiscodecandependonpdf.js,JQueryandBootstrap
 *(seewebsite_slides.slide_embed_assetsbundle,inwebsite_slides_embed.xml)
 */
$(function(){

    if($('#PDFViewer')&&$('#PDFViewerCanvas')){//checkifpresentationonly
        varMIN_ZOOM=1,MAX_ZOOM=10,ZOOM_INCREMENT=.5;

        //defineembeddedviewer(minimalobjectofthewebsite.slide.PDFViewerwidget)
        varEmbeddedViewer=function($viewer){
            varself=this;
            this.viewer=$viewer;
            this.slide_url=$viewer.find('#PDFSlideViewer').data('slideurl');
            this.slide_id=$viewer.find('#PDFSlideViewer').data('slideid');
            this.defaultpage=parseInt($viewer.find('#PDFSlideViewer').data('defaultpage'));
            this.canvas=$viewer.find('canvas')[0];

            this.pdf_viewer=newPDFSlidesViewer(this.slide_url,this.canvas,true);
            this.pdf_viewer.loadDocument().then(function(){
                self.on_loaded_file();
            });
        };
        EmbeddedViewer.prototype.__proto__={
            //jqueryinsidetheobject(likeWidget)
            $:function(selector){
                returnthis.viewer.find($(selector));
            },
            //postprocessaction(calledin'.then()')
            on_loaded_file:function(){
                this.$('canvas').show();
                this.$('#page_count').text(this.pdf_viewer.pdf_page_total);
                this.$('#PDFViewerLoader').hide();
                if(this.pdf_viewer.pdf_page_total>1){
                    this.$('.o_slide_navigation_buttons').removeClass('hide');
                }
                //initfirstpagetodisplay
                varinitpage=this.defaultpage;
                varpageNum=(initpage>0&&initpage<=this.pdf_viewer.pdf_page_total)?initpage:1;
                this.render_page(pageNum);
            },
            on_rendered_page:function(pageNumber){
                if(pageNumber){
                    this.$('#page_number').val(pageNumber);
                    this.navUpdate(pageNumber);
                }
            },
            on_resize:function(){
                this.render_page(this.pdf_viewer.pdf_page_current);
            },
            //pageswitching
            render_page:function(pageNumber){
                this.pdf_viewer.queueRenderPage(pageNumber).then(this.on_rendered_page.bind(this));
                this.navUpdate(pageNumber);
            },
            change_page:function(){
                varpageAsked=parseInt(this.$('#page_number').val(),10);
                if(1<=pageAsked&&pageAsked<=this.pdf_viewer.pdf_page_total){
                    this.pdf_viewer.changePage(pageAsked).then(this.on_rendered_page.bind(this));
                    this.navUpdate(pageAsked);
                }else{
                    //ifpagenumberoutofrange,resetthepage_countertotheactualpage
                    this.$('#page_number').val(this.pdf_viewer.pdf_page_current);
                }
            },
            next:function(){
                varself=this;
                this.pdf_viewer.nextPage().then(function(pageNum){
                    if(pageNum){
                        self.on_rendered_page(pageNum);
                    }else{
                        if(self.pdf_viewer.pdf){//avoiddisplaysuggestionwhenpdfisnotloadedyet
                            self.display_suggested_slides();
                        }
                    }
                });
            },
            previous:function(){
                constslideSuggestOverlay=this.$("#slide_suggest");
                if(!slideSuggestOverlay.hasClass('d-none')){
                    //Hidesuggestedslideoverlaybeforechangingpagenb.
                    slideSuggestOverlay.addClass('d-none');
                    this.$('#next,#last').removeClass('disabled');
                    return;
                }
                varself=this;
                this.pdf_viewer.previousPage().then(function(pageNum){
                    if(pageNum){
                        self.on_rendered_page(pageNum);
                    }
                    slideSuggestOverlay.addClass('d-none');
                });
            },
            first:function(){
                varself=this;
                this.pdf_viewer.firstPage().then(function(pageNum){
                    self.on_rendered_page(pageNum);
                    self.$("#slide_suggest").addClass('d-none');
                });
            },
            last:function(){
                varself=this;
                this.pdf_viewer.lastPage().then(function(pageNum){
                    self.on_rendered_page(pageNum);
                    self.$("#slide_suggest").addClass('d-none');
                });
            },
            zoomIn:function(){
                if(this.pdf_viewer.pdf_zoom<MAX_ZOOM){
                    this.pdf_viewer.pdf_zoom+=ZOOM_INCREMENT;
                    this.render_page(this.pdf_viewer.pdf_page_current);
                }
            },
            zoomOut:function(){
                if(this.pdf_viewer.pdf_zoom>MIN_ZOOM){
                    this.pdf_viewer.pdf_zoom-=ZOOM_INCREMENT;
                    this.render_page(this.pdf_viewer.pdf_page_current);
                }
            },
            navUpdate:function(pageNum){
                this.$('#first').toggleClass('disabled',pageNum<3);
                this.$('#previous').toggleClass('disabled',pageNum<2);
                this.$('#next,#last').removeClass('disabled');
                this.$('#zoomout').toggleClass('disabled',this.pdf_viewer.pdf_zoom<=MIN_ZOOM);
                this.$('#zoomin').toggleClass('disabled',this.pdf_viewer.pdf_zoom>=MAX_ZOOM);
            },
            //fullscreenmode
            fullscreen:function(){
                this.pdf_viewer.toggleFullScreen();
            },
            fullScreenFooter:function(ev){
                if(ev.target.id==="PDFViewerCanvas"){
                    this.pdf_viewer.toggleFullScreenFooter();
                }
            },
            //displaysuggestiondisplayedafterlastslide
            display_suggested_slides:function(){
                this.$("#slide_suggest").removeClass('d-none');
                this.$('#next,#last').addClass('disabled');
            },
        };

        //embeddedpdfviewer
        varembeddedViewer=newEmbeddedViewer($('#PDFViewer'));

        //bindtheactions
        $('#previous').on('click',function(){
            embeddedViewer.previous();
        });
        $('#next').on('click',function(){
            embeddedViewer.next();
        });
        $('#first').on('click',function(){
            embeddedViewer.first();
        });
        $('#last').on('click',function(){
            embeddedViewer.last();
        });
        $('#zoomin').on('click',function(){
            embeddedViewer.zoomIn();
        });
        $('#zoomout').on('click',function(){
            embeddedViewer.zoomOut();
        });
        $('#page_number').on('change',function(){
            embeddedViewer.change_page();
        });
        $('#fullscreen').on('click',function(){
            embeddedViewer.fullscreen();
        });
        $('#PDFViewer').on('click',function(ev){
            embeddedViewer.fullScreenFooter(ev);
        });
        $('#PDFViewer').on('wheel',function(ev){
            if(ev.metaKey||ev.ctrlKey){
                if(ev.originalEvent.deltaY>0){
                    embeddedViewer.zoomOut();
                }elseif(ev.originalEvent.deltaY<0){
                    embeddedViewer.zoomIn();
                }
                returnfalse;
            }
        });
        $(window).on('resize',_.debounce(function(){
            embeddedViewer.on_resize();
        },500));

        //switchingslidewithkeyboard
        $(document).keydown(function(ev){
            if(ev.keyCode===37||ev.keyCode===38){
                embeddedViewer.previous();
            }
            if(ev.keyCode===39||ev.keyCode===40){
                embeddedViewer.next();
            }
        });

        //displaytheoptionpanels
        $('.oe_slide_js_embed_option_link').on('click',function(ev){
            ev.preventDefault();
            vartoggleDiv=$(this).data('slide-option-id');
            $('.oe_slide_embed_option').not(toggleDiv).each(function(){
                $(this).hide();
            });
            $(toggleDiv).slideToggle();
        });

        //animationforthesuggestedslides
        $('.oe_slides_suggestion_media').hover(
            function(){
                $(this).find('.oe_slides_suggestion_caption').stop().slideDown(250);
            },
            function(){
                $(this).find('.oe_slides_suggestion_caption').stop().slideUp(250);
            }
        );

        //embedwidgetpageselector
        $('.oe_slide_js_embed_code_widgetinput').on('change',function(){
            varpage=parseInt($(this).val());
            if(!(page>0&&page<=embeddedViewer.pdf_viewer.pdf_page_total)){
                page=1;
            }
            varactualCode=embeddedViewer.$('.slide_embed_code').val();
            varnewCode=actualCode.replace(/(page=).*?([^\d]+)/,'$1'+page+'$2');
            embeddedViewer.$('.slide_embed_code').val(newCode);
        });

        //Toavoidcreateadependancytoopenerpframework.js,weuseJQueryAJAXtopostdatainsteadofajax.jsonRpc
        $('.oe_slide_js_share_emailbutton').on('click',function(){
            varwidget=$('.oe_slide_js_share_email');
            varinput=widget.find('input');
            varslideID=widget.find('button').data('slide-id');
            if(input.val()&&input[0].checkValidity()){
                widget.removeClass('o_has_error').find('.form-control,.custom-select').removeClass('is-invalid');
                $.ajax({
                    type:"POST",
                    dataType:'json',
                    url:'/slides/slide/send_share_email',
                    contentType:"application/json;charset=utf-8",
                    data:JSON.stringify({'jsonrpc':"2.0",'method':"call","params":{'slide_id':slideID,'email':input.val()}}),
                    success:function(){
                        widget.html($('<divclass="alertalert-info"role="alert"><strong>Thankyou!</strong>Mailhasbeensent.</div>'));
                    },
                    error:function(data){
                        console.error("ERROR",data);
                    },
                });
            }else{
                widget.addClass('o_has_error').find('.form-control,.custom-select').addClass('is-invalid');
                input.focus();
            }
        });
    }
});
