flectra.define('sale.SalePortalSidebar',function(require){
'usestrict';

varpublicWidget=require('web.public.widget');
varPortalSidebar=require('portal.PortalSidebar');

publicWidget.registry.SalePortalSidebar=PortalSidebar.extend({
    selector:'.o_portal_sale_sidebar',

    /**
     *@constructor
     */
    init:function(parent,options){
        this._super.apply(this,arguments);
        this.authorizedTextTag=['em','b','i','u'];
        this.spyWatched=$('body[data-target=".navspy"]');
    },
    /**
     *@override
     */
    start:function(){
        vardef=this._super.apply(this,arguments);
        var$spyWatcheElement=this.$el.find('[data-id="portal_sidebar"]');
        this._setElementId($spyWatcheElement);
        //NavMenuScrollSpy
        this._generateMenu();
        //Aftersingature,automaticallyopenthepopupforpayment
        if($.bbq.getState('allow_payment')==='yes'&&this.$('#o_sale_portal_paynow').length){
            this.$('#o_sale_portal_paynow').trigger('click');
            $.bbq.removeState('allow_payment');
        }
        returndef;
    },

    //--------------------------------------------------------------------------
    //Private
    //---------------------------------------------------------------------------

    /**
     *createanuniqueidandaddedasaattributeofspyWatchedelement
     *
     *@private
     *@param{string}prefix
     *@param{Object}$el
     *
     */
    _setElementId:function(prefix,$el){
        varid=_.uniqueId(prefix);
        this.spyWatched.find($el).attr('id',id);
        returnid;
    },
    /**
     *generatethenewspymenu
     *
     *@private
     *
     */
    _generateMenu:function(){
        varself=this,
            lastLI=false,
            lastUL=null,
            $bsSidenav=this.$el.find('.bs-sidenav');

        $("#quote_content[id^=quote_header_],#quote_content[id^=quote_]",this.spyWatched).attr("id","");
        _.each(this.spyWatched.find("#quote_contenth2,#quote_contenth3"),function(el){
            varid,text;
            switch(el.tagName.toLowerCase()){
                case"h2":
                    id=self._setElementId('quote_header_',el);
                    text=self._extractText($(el));
                    if(!text){
                        break;
                    }
                    lastLI=$("<liclass='nav-item'>").append($('<aclass="nav-link"style="max-width:200px;"href="#'+id+'"/>').text(text)).appendTo($bsSidenav);
                    lastUL=false;
                    break;
                case"h3":
                    id=self._setElementId('quote_',el);
                    text=self._extractText($(el));
                    if(!text){
                        break;
                    }
                    if(lastLI){
                        if(!lastUL){
                            lastUL=$("<ulclass='navflex-column'>").appendTo(lastLI);
                        }
                        $("<liclass='nav-item'>").append($('<aclass="nav-link"style="max-width:200px;"href="#'+id+'"/>').text(text)).appendTo(lastUL);
                    }
                    break;
            }
            el.setAttribute('data-anchor',true);
        });
        this.trigger_up('widgets_start_request',{$target:$bsSidenav});
    },
    /**
     *extracttextofmenutitleforsidebar
     *
     *@private
     *@param{Object}$node
     *
     */
    _extractText:function($node){
        varself=this;
        varrawText=[];
        _.each($node.contents(),function(el){
            varcurrent=$(el);
            if($.trim(current.text())){
                vartagName=current.prop("tagName");
                if(_.isUndefined(tagName)||(!_.isUndefined(tagName)&&_.contains(self.authorizedTextTag,tagName.toLowerCase()))){
                    rawText.push($.trim(current.text()));
                }
            }
        });
        returnrawText.join('');
    },
});
});
