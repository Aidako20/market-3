flectra.define('website_form.s_website_form',function(require){
    'usestrict';

    varcore=require('web.core');
    vartime=require('web.time');
    const{ReCaptcha}=require('google_recaptcha.ReCaptchaV3');
    varajax=require('web.ajax');
    varpublicWidget=require('web.public.widget');
    constdom=require('web.dom');
    constsession=require('web.session');

    var_t=core._t;
    varqweb=core.qweb;

    publicWidget.registry.s_website_form=publicWidget.Widget.extend({
        selector:'.s_website_formform,form.s_website_form',//!compatibility
        xmlDependencies:['/website_form/static/src/xml/website_form.xml'],
        events:{
            'click.s_website_form_send,.o_website_form_send':'send',//!compatibility
        },

        /**
         *@constructor
         */
        init:function(){
            this._super(...arguments);
            this._recaptcha=newReCaptcha();
            this.__started=newPromise(resolve=>this.__startResolve=resolve);
        },
        willStart:function(){
            constres=this._super(...arguments);
            if(!this.$target[0].classList.contains('s_website_form_no_recaptcha')){
                this._recaptchaLoaded=true;
                this._recaptcha.loadLibs();
            }
            returnres;
        },
        start:function(){
            varself=this;

            //Initializedatetimepickers
            vardatepickers_options={
                minDate:moment({y:1000}),
                maxDate:moment({y:9999,M:11,d:31}),
                calendarWeeks:true,
                icons:{
                    time:'fafa-clock-o',
                    date:'fafa-calendar',
                    next:'fafa-chevron-right',
                    previous:'fafa-chevron-left',
                    up:'fafa-chevron-up',
                    down:'fafa-chevron-down',
                    },
                locale:moment.locale(),
                format:time.getLangDatetimeFormat(),
            };
            this.$target.find('.s_website_form_datetime,.o_website_form_datetime').datetimepicker(datepickers_options);//!compatibility

            //Adaptoptionstodate-onlypickers
            datepickers_options.format=time.getLangDateFormat();
            this.$target.find('.s_website_form_date,.o_website_form_date').datetimepicker(datepickers_options);//!compatibility

            //Displayformvaluesfromtaghavingdata-forattribute
            //It'snecessarytohandlefieldvaluesgeneratedonserver-side
            //Because,usingt-att-insideformmakeitnon-editable
            var$values=$('[data-for='+this.$target.attr('id')+']');
            if($values.length){
                constvalues=JSON.parse($values.data('values')
                    //replaces`True`by`true`iftheyareafter`,`or`:`or`[`
                    .replace(/([,:\[]\s*)True/g,'$1true')
                    //replaces`False`and`None`by`""`iftheyareafter`,`or`:`or`[`
                    .replace(/([,:\[]\s*)(False|None)/g,'$1""')
                    //replacesthe`'`by`"`iftheyarebefore`,`or`:`or`]`or`}`
                    .replace(/'(\s*[,:\]}])/g,'"$1')
                    //replacesthe`'`by`"`iftheyareafter`{`or`[`or`,`or`:`
                    .replace(/([{\[:,]\s*)'/g,'$1"')
                );
                varfields=_.pluck(this.$target.serializeArray(),'name');
                _.each(fields,function(field){
                    if(_.has(values,field)){
                        var$field=self.$target.find('input[name="'+field+'"],textarea[name="'+field+'"]');
                        if(!$field.val()){
                            $field.val(values[field]);
                            $field.data('website_form_original_default_value',$field.val());
                        }
                    }
                });
            }

            returnthis._super(...arguments).then(()=>this.__startResolve());
        },

        destroy:function(){
            this._super.apply(this,arguments);
            this.$target.find('button').off('click');

            //Emptyimputs
            this.$target[0].reset();

            //Removesavingoftheerrorcolors
            this.$target.find('.o_has_error').removeClass('o_has_error').find('.form-control,.custom-select').removeClass('is-invalid');

            //Removethestatusmessage
            this.$target.find('#s_website_form_result,#o_website_form_result').empty();//!compatibility

            //Removethesuccessmessageanddisplaytheform
            this.$target.removeClass('d-none');
            this.$target.parent().find('.s_website_form_end_message').addClass('d-none');
        },

        send:asyncfunction(e){
            e.preventDefault();//Preventthedefaultsubmitbehavior
             //Preventusersfromcrazyclicking
            this.$target.find('.s_website_form_send,.o_website_form_send')
                .addClass('disabled')   //!compatibility
                .attr('disabled','disabled');

            varself=this;

            self.$target.find('#s_website_form_result,#o_website_form_result').empty();//!compatibility
            if(!self.check_error_fields({})){
                self.update_status('error',_t("Pleasefillintheformcorrectly."));
                returnfalse;
            }

            //Prepareforminputs
            this.form_fields=this.$target.serializeArray();
            $.each(this.$target.find('input[type=file]'),function(outer_index,input){
                $.each($(input).prop('files'),function(index,file){
                    //Indexfieldnameasajaxwon'tacceptarraysoffiles
                    //whenaggregatingmultiplefilesintoasinglefieldvalue
                    self.form_fields.push({
                        name:input.name+'['+outer_index+']['+index+']',
                        value:file
                    });
                });
            });

            //Serializeforminputsintoasingleobject
            //Aggregatemultiplevaluesintoarrays
            varform_values={};
            _.each(this.form_fields,function(input){
                if(input.nameinform_values){
                    //Ifavaluealreadyexistsforthisfield,
                    //wearefacingax2manyfield,sowestore
                    //thevaluesinanarray.
                    if(Array.isArray(form_values[input.name])){
                        form_values[input.name].push(input.value);
                    }else{
                        form_values[input.name]=[form_values[input.name],input.value];
                    }
                }else{
                    if(input.value!==''){
                        form_values[input.name]=input.value;
                    }
                }
            });

            //forceserverdateformatusageforexistingfields
            this.$target.find('.s_website_form_field:not(.s_website_form_custom)')
            .find('.s_website_form_date,.s_website_form_datetime').each(function(){
                const$input=$(this).find('input');

                //Datetimepicker('viewDate')willreturn`newDate()`ifthe
                //inputisemptybutwewanttokeeptheemptyvalue
                if(!$input.val()){
                    return;
                }

                vardate=$(this).datetimepicker('viewDate').clone().locale('en');
                varformat='YYYY-MM-DD';
                if($(this).hasClass('s_website_form_datetime')){
                    date=date.utc();
                    format='YYYY-MM-DDHH:mm:ss';
                }
                form_values[$input.attr('name')]=date.format(format);
            });

            if(this._recaptchaLoaded){
                consttokenObj=awaitthis._recaptcha.getToken('website_form');
                if(tokenObj.token){
                    form_values['recaptcha_token_response']=tokenObj.token;
                }elseif(tokenObj.error){
                    self.update_status('error',tokenObj.error);
                    returnfalse;
                }
            }

            //Postformandhandleresult
            ajax.post(this.$target.attr('action')+(this.$target.data('force_action')||this.$target.data('model_name')),form_values)
            .then(function(result_data){
                //Restoresendbuttonbehavior
                self.$target.find('.s_website_form_send,.o_website_form_send')
                    .removeAttr('disabled')
                    .removeClass('disabled');//!compatibility
                result_data=JSON.parse(result_data);
                if(!result_data.id){
                    //Failure,theserverdidn'treturnthecreatedrecordID
                    self.update_status('error',result_data.error?result_data.error:false);
                    if(result_data.error_fields){
                        //Iftheserverreturnalistofbadfields,showthesefieldsforusers
                        self.check_error_fields(result_data.error_fields);
                    }
                }else{
                    //Success,redirectorupdatestatus
                    letsuccessMode=self.$target[0].dataset.successMode;
                    letsuccessPage=self.$target[0].dataset.successPage;
                    if(!successMode){
                        successPage=self.$target.attr('data-success_page');//Compatibility
                        successMode=successPage?'redirect':'nothing';
                    }
                    switch(successMode){
                        case'redirect':{
                            lethashIndex=successPage.indexOf("#");
                            if(hashIndex>0){
                                //URLcontainingananchordetected:extract
                                //theanchorfromtheURLiftheURListhe
                                //sameasthecurrentpageURLsowecanscroll
                                //directlytotheelement(iffound)later
                                //insteadofredirecting.
                                //NotethatbothcurrentUrlPathandsuccessPage
                                //canexistwithorwithoutatrailingslash
                                //beforethehash(e.g."domain.com#footer"or
                                //"domain.com/#footer").Therefore,iftheyare
                                //notpresent,weaddthemtobeableto
                                //comparethetwovariablescorrectly.
                                letcurrentUrlPath=window.location.pathname;
                                if(!currentUrlPath.endsWith("/")){
                                    currentUrlPath=currentUrlPath+"/";
                                }
                                if(!successPage.includes("/#")){
                                    successPage=successPage.replace("#","/#");
                                    hashIndex++;
                                }
                                if([successPage,"/"+session.lang_url_code+successPage].some(link=>link.startsWith(currentUrlPath+'#'))){
                                    successPage=successPage.substring(hashIndex);
                                }
                            }
                            if(successPage.charAt(0)==="#"){
                                constsuccessAnchorEl=document.getElementById(successPage.substring(1));
                                if(successAnchorEl){
                                    dom.scrollTo(successAnchorEl,{
                                        duration:500,
                                        extraOffset:0,
                                    });
                                }
                            }else{
                                $(window.location).attr('href',successPage);
                            }
                            break;
                        }
                        case'message':
                            self.$target[0].classList.add('d-none');
                            self.$target[0].parentElement.querySelector('.s_website_form_end_message').classList.remove('d-none');
                            break;
                        default:
                            self.update_status('success');
                            break;
                    }

                    //Resettheform
                    self.$target[0].reset();
                }
            })
            .guardedCatch(function(){
                self.update_status('error');
            });
        },

        check_error_fields:function(error_fields){
            varself=this;
            varform_valid=true;
            //Looponallfields
            this.$target.find('.form-field,.s_website_form_field').each(function(k,field){//!compatibility
                var$field=$(field);
                varfield_name=$field.find('.col-form-label').attr('for');

                //Validateinputsforthisfield
                varinputs=$field.find('.s_website_form_input,.o_website_form_input').not('#editable_select');//!compatibility
                varinvalid_inputs=inputs.toArray().filter(function(input,k,inputs){
                    //Specialcheckformultiplerequiredcheckboxforsame
                    //fieldasitseemscheckValidityforceseveryrequired
                    //checkboxtobechecked,insteadoflookingatother
                    //checkboxeswiththesamenameandonlyrequiringone
                    //ofthemtobechecked.
                    if(input.required&&input.type==='checkbox'){
                        //Consideringwearecurrentlyprocessingasingle
                        //field,wecanassumethatallcheckboxesinthe
                        //inputsvariablehavethesamename
                        varcheckboxes=_.filter(inputs,function(input){
                            returninput.required&&input.type==='checkbox';
                        });
                        return!_.any(checkboxes,checkbox=>checkbox.checked);

                    //Specialcasesfordatesanddatetimes
                    }elseif($(input).hasClass('s_website_form_date')||$(input).hasClass('o_website_form_date')){//!compatibility
                        if(!self.is_datetime_valid(input.value,'date')){
                            returntrue;
                        }
                    }elseif($(input).hasClass('s_website_form_datetime')||$(input).hasClass('o_website_form_datetime')){//!compatibility
                        if(!self.is_datetime_valid(input.value,'datetime')){
                            returntrue;
                        }
                    }
                    return!input.checkValidity();
                });

                //Updatefieldcolorifinvalidorerroneous
                $field.removeClass('o_has_error').find('.form-control,.custom-select').removeClass('is-invalid');
                if(invalid_inputs.length||error_fields[field_name]){
                    $field.addClass('o_has_error').find('.form-control,.custom-select').addClass('is-invalid');
                    if(_.isString(error_fields[field_name])){
                        $field.popover({content:error_fields[field_name],trigger:'hover',container:'body',placement:'top'});
                        //updateerrormessageandshowit.
                        $field.data("bs.popover").config.content=error_fields[field_name];
                        $field.popover('show');
                    }
                    form_valid=false;
                }
            });
            returnform_valid;
        },

        is_datetime_valid:function(value,type_of_date){
            if(value===""){
                returntrue;
            }else{
                try{
                    this.parse_date(value,type_of_date);
                    returntrue;
                }catch(e){
                    returnfalse;
                }
            }
        },

        //Thisisastrippeddownversionofformat.jsparse_valuefunction
        parse_date:function(value,type_of_date,value_if_empty){
            vardate_pattern=time.getLangDateFormat(),
                time_pattern=time.getLangTimeFormat();
            vardate_pattern_wo_zero=date_pattern.replace('MM','M').replace('DD','D'),
                time_pattern_wo_zero=time_pattern.replace('HH','H').replace('mm','m').replace('ss','s');
            switch(type_of_date){
                case'datetime':
                    vardatetime=moment(value,[date_pattern+''+time_pattern,date_pattern_wo_zero+''+time_pattern_wo_zero],true);
                    if(datetime.isValid()){
                        returntime.datetime_to_str(datetime.toDate());
                    }
                    thrownewError(_.str.sprintf(_t("'%s'isnotacorrectdatetime"),value));
                case'date':
                    vardate=moment(value,[date_pattern,date_pattern_wo_zero],true);
                    if(date.isValid()){
                        returntime.date_to_str(date.toDate());
                    }
                    thrownewError(_.str.sprintf(_t("'%s'isnotacorrectdate"),value));
            }
            returnvalue;
        },

        update_status:function(status,message){
            if(status!=='success'){//Restoresendbuttonbehaviorifresultisanerror
                this.$target.find('.s_website_form_send,.o_website_form_send')
                    .removeAttr('disabled')
                    .removeClass('disabled');//!compatibility
            }
            var$result=this.$('#s_website_form_result,#o_website_form_result');//!compatibility

            if(status==='error'&&!message){
                message=_t("Anerrorhasoccured,theformhasnotbeensent.");
            }

            //Note:westillneedtowaitthatthewidgetisproperlystarted
            //beforeanyqwebrenderingwhichdependsonxmlDependencies
            //becausetheeventhandlersarebindedbeforethecallto
            //willStartforpublicwidgets...
            this.__started.then(()=>$result.replaceWith(qweb.render(`website_form.status_${status}`,{
                message:message,
            })));
        },
    });
});
