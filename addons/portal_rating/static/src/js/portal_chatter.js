flectra.define('rating.portal.chatter',function(require){
'usestrict';

varcore=require('web.core');
varportalChatter=require('portal.chatter');
varutils=require('web.utils');
vartime=require('web.time');

var_t=core._t;
varPortalChatter=portalChatter.PortalChatter;
varqweb=core.qweb;

/**
 *PortalChatter
 *
 *ExtendsFrontendChattertohandlerating
 */
PortalChatter.include({
    events:_.extend({},PortalChatter.prototype.events,{
        //starbasedcontrol
        'click.o_website_rating_select':'_onClickStarDomain',
        'click.o_website_rating_select_text':'_onClickStarDomainReset',
        //publishercomments
        'click.o_wrating_js_publisher_comment_btn':'_onClickPublisherComment',
        'click.o_wrating_js_publisher_comment_edit':'_onClickPublisherComment',
        'click.o_wrating_js_publisher_comment_delete':'_onClickPublisherCommentDelete',
        'click.o_wrating_js_publisher_comment_submit':'_onClickPublisherCommentSubmit',
        'click.o_wrating_js_publisher_comment_cancel':'_onClickPublisherCommentCancel',
    }),
    xmlDependencies:(PortalChatter.prototype.xmlDependencies||[])
        .concat([
            '/portal_rating/static/src/xml/portal_tools.xml',
            '/portal_rating/static/src/xml/portal_chatter.xml'
        ]),

    /**
     *@constructor
     */
    init:function(parent,options){
        this._super.apply(this,arguments);
        //options
        if(!_.contains(this.options,'display_rating')){
            this.options=_.defaults(this.options,{
                'display_rating':false,
                'rating_default_value':0.0,
            });
        }
        //ratingcard
        this.set('rating_card_values',{});
        this.set('rating_value',false);
        this.on("change:rating_value",this,this._onChangeRatingDomain);
    },

    //--------------------------------------------------------------------------
    //Public
    //--------------------------------------------------------------------------

    /**
     *Updatethemessagesformat
     *
     *@param{Array<Object>}messages
     *@returns{Array}
     */
    preprocessMessages:function(messages){
        varself=this;
        messages=this._super.apply(this,arguments);
        if(this.options['display_rating']){
            _.each(messages,function(m,i){
                m.rating_value=self.roundToHalf(m['rating_value']);
                m.rating=self._preprocessCommentData(m.rating,i);
            });
        }
        //savemessagesinthewidgettoprocesscorrectlythepublishercommenttemplates
        this.messages=messages;
        returnmessages;
    },
    /**
     *Roundthegivenvaluewithaprecisionof0.5.
     *
     *Examples:
     *-1.2-->1.0
     *-1.7-->1.5
     *-1.9-->2.0
     *
     *@param{Number}value
     *@returnsNumber
     **/
    roundToHalf:function(value){
        varconverted=parseFloat(value);//Makesurewehaveanumber
        vardecimal=(converted-parseInt(converted,10));
        decimal=Math.round(decimal*10);
        if(decimal===5){
            return(parseInt(converted,10)+0.5);
        }
        if((decimal<3)||(decimal>7)){
            returnMath.round(converted);
        }else{
            return(parseInt(converted,10)+0.5);
        }
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _chatterInit:function(){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(result){
            if(!result['rating_stats']){
                return;
            }
            varratingData={
                'avg':Math.round(result['rating_stats']['avg']*100)/100,
                'percent':[],
            };
            _.each(_.keys(result['rating_stats']['percent']).reverse(),function(rating){
                ratingData['percent'].push({
                    'num':rating,
                    'percent':utils.round_precision(result['rating_stats']['percent'][rating],0.01),
                });
            });
            self.set('rating_card_values',ratingData);
        });
    },
    /**
     *@override
     */
    _messageFetchPrepareParams:function(){
        varparams=this._super.apply(this,arguments);
        if(this.options['display_rating']){
            params['rating_include']=true;
        }
        returnparams;
    },

    /**
     *Defaultratingdataforpublishercommentqwebtemplate
     *@private
     *@param{Integer}messageIndex
     */
    _newPublisherCommentData:function(messageIndex){
        return{
            mes_index:messageIndex,
            publisher_id:this.options.partner_id,
            publisher_avatar:_.str.sprintf('/web/image/%s/%s/image_128/50x50','res.partner',this.options.partner_id),
            publisher_name:_t("Writeyourcomment"),
            publisher_datetime:'',
            publisher_comment:'',
        };
    },

     /**
     *preprocesstheratingdatacommingfrom/website/rating/commentorthechatter_init
     *Canbealsousetohavenewratingdataforanewpublishercomment
     *@param{JSON}rawRating
     *@returns{JSON}theprocessratingdata
     */
    _preprocessCommentData:function(rawRating,messageIndex){
        varratingData={
            id:rawRating.id,
            mes_index:messageIndex,
            publisher_datetime:rawRating.publisher_datetime?moment(time.str_to_datetime(rawRating.publisher_datetime)).format('MMMMDoYYYY,h:mm:ssa'):"",
            publisher_comment:rawRating.publisher_comment?rawRating.publisher_comment:'',
        };

        //splitarray(id,display_name)ofpublisher_idintopublisher_idandpublisher_name
        if(rawRating.publisher_id&&rawRating.publisher_id.length>=2){
            ratingData.publisher_id=rawRating.publisher_id[0];
            ratingData.publisher_name=rawRating.publisher_id[1];
            ratingData.publisher_avatar=_.str.sprintf('/web/image/%s/%s/image_128/50x50','res.partner',ratingData.publisher_id);
        }
        varcommentData=_.extend(this._newPublisherCommentData(messageIndex),ratingData);
        returncommentData;
    },

    /**---------------
     *Selectionofelementsforthepublishercommentfeature
     *Onlyavailablefromasourceinapublisher_commentorpublisher_comment_formtemplate
     */

    _getCommentContainer:function($source){
        return$source.parents(".o_wrating_publisher_container").first().find(".o_wrating_publisher_comment").first();
    },

    _getCommentButton:function($source){
        return$source.parents(".o_wrating_publisher_container").first().find(".o_wrating_js_publisher_comment_btn").first();
    },

    _getCommentTextarea:function($source){
        return$source.parents(".o_wrating_publisher_container").first().find(".o_portal_rating_comment_input").first();
    },

    _focusTextComment:function($source){
        this._getCommentTextarea($source).focus();
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@private
     *@param{MouseEvent}ev
     */
    _onClickStarDomain:function(ev){
        var$tr=this.$(ev.currentTarget);
        varnum=$tr.data('star');
        if($tr.css('opacity')==='1'){
            this.set('rating_value',num);
            this.$('.o_website_rating_select').css({
                'opacity':0.5,
            });
            this.$('.o_website_rating_select_text[data-star="'+num+'"]').css({
                'visibility':'visible',
                'opacity':1,
            });
            this.$('.o_website_rating_select[data-star="'+num+'"]').css({
                'opacity':1,
            });
        }
    },
    /**
     *@private
     *@param{MouseEvent}ev
     */
    _onClickStarDomainReset:function(ev){
        ev.stopPropagation();
        ev.preventDefault();
        this.set('rating_value',false);
        this.$('.o_website_rating_select_text').css('visibility','hidden');
        this.$('.o_website_rating_select').css({
            'opacity':1,
        });
    },

    /**
     *@private
     *@param{MouseEvent}ev
     */
    _onClickPublisherComment:function(ev){
        var$source=this.$(ev.currentTarget);
        //Iftheformisalreadypresent=>likecancelremovetheform
        if(this._getCommentTextarea($source).length===1){
            this._getCommentContainer($source).empty();
            return;
        }
        varmessageIndex=$source.data("mes_index");
        vardata={is_publisher:this.options['is_user_publisher']};
        data.rating=this._newPublisherCommentData(messageIndex);
        
        varoldRating=this.messages[messageIndex].rating;
        data.rating.publisher_comment=oldRating.publisher_comment?oldRating.publisher_comment:'';
        this._getCommentContainer($source).html($(qweb.render("portal_rating.chatter_rating_publisher_form",data)));
        this._focusTextComment($source);
    },

    /**
     *@private
     *@param{MouseEvent}ev
     */
    _onClickPublisherCommentDelete:function(ev){
        varself=this;
        var$source=this.$(ev.currentTarget);

        varmessageIndex=$source.data("mes_index");
        varratingId=this.messages[messageIndex].rating.id;

        this._rpc({
            route:'/website/rating/comment',
            params:{
                "rating_id":ratingId,
                "publisher_comment":''//Emptypublishercommentmeansnocomment
            }
        }).then(function(res){
            self.messages[messageIndex].rating=self._preprocessCommentData(res,messageIndex);
            self._getCommentButton($source).removeClass("d-none");
            self._getCommentContainer($source).empty();
        });
    }, 

     /**
     *@private
     *@param{MouseEvent}ev
     */
    _onClickPublisherCommentSubmit:function(ev){
        varself=this;
        var$source=this.$(ev.currentTarget);

        varmessageIndex=$source.data("mes_index");
        varcomment=this._getCommentTextarea($source).val();
        varratingId=this.messages[messageIndex].rating.id;

        this._rpc({
            route:'/website/rating/comment',
            params:{
                "rating_id":ratingId,
                "publisher_comment":comment
            }
        }).then(function(res){

            //Modifytherelatedmessage
            self.messages[messageIndex].rating=self._preprocessCommentData(res,messageIndex);
            if(self.messages[messageIndex].rating.publisher_comment!==''){
                //Removethebuttoncommentifexistandrenderthecomment
                self._getCommentButton($source).addClass('d-none');
                self._getCommentContainer($source).html($(qweb.render("portal_rating.chatter_rating_publisher_comment",{
                    rating:self.messages[messageIndex].rating,
                    is_publisher:self.options.is_user_publisher
                })));
            }else{
                //Emptystringorfalseconsidersasnocomment
                self._getCommentButton($source).removeClass("d-none");
                self._getCommentContainer($source).empty();      
            }
        });
    },

     /**
     *@private
     *@param{MouseEvent}ev
     */
    _onClickPublisherCommentCancel:function(ev){
        var$source=this.$(ev.currentTarget);
        varmessageIndex=$source.data("mes_index");

        varcomment=this.messages[messageIndex].rating.publisher_comment;
        if(comment){
            vardata={
                rating:this.messages[messageIndex].rating,
                is_publisher:this.options.is_user_publisher
            };
            this._getCommentContainer($source).html($(qweb.render("portal_rating.chatter_rating_publisher_comment",data)));
        }else{
            this._getCommentContainer($source).empty();
        }
    },

    /**
     *@private
     */
    _onChangeRatingDomain:function(){
        vardomain=[];
        if(this.get('rating_value')){
            domain=[['rating_value','=',this.get('rating_value')]];
        }
        this._changeCurrentPage(1,domain);
    },
});
});
