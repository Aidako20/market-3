flectra.define('rating.portal.composer',function(require){
'usestrict';

varcore=require('web.core');
varportalComposer=require('portal.composer');

var_t=core._t;

varPortalComposer=portalComposer.PortalComposer;

/**
 *PortalComposer
 *
 *ExtendsPortalComposertohandleratingsubmission
 */
PortalComposer.include({
    events:_.extend({},PortalComposer.prototype.events,{
        'click.starsi':'_onClickStar',
        'mouseleave.stars':'_onMouseleaveStarBlock',
        'mousemove.starsi':'_onMoveStar',
        'mouseleave.starsi':'_onMoveLeaveStar',
    }),

    /**
     *@constructor
     */
    init:function(parent,options){
        this._super.apply(this,arguments);

        //applyratiotodefaultratingvalue
        if(options.default_rating_value){
            options.default_rating_value=parseFloat(options.default_rating_value);
        }

        //defaultoptions
        this.options=_.defaults(this.options,{
            'default_message':false,
            'default_message_id':false,
            'default_rating_value':0.0,
            'force_submit_url':false,
        });
        //starinputwidget
        this.labels={
            '0':"",
            '1':_t("Ihateit"),
            '2':_t("Idon'tlikeit"),
            '3':_t("It'sokay"),
            '4':_t("Ilikeit"),
            '5':_t("Iloveit"),
        };
        this.user_click=false;//userhasclickornot
        this.set("star_value",this.options.default_rating_value);
        this.on("change:star_value",this,this._onChangeStarValue);
    },
    /**
     *@override
     */
    start:function(){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(){
            //ratingstars
            self.$input=self.$('input[name="rating_value"]');
            self.$star_list=self.$('.stars').find('i');

            //setthedefaultvaluetotriggerthedisplayofstarwidgetandupdatethehiddeninputvalue.
            self.set("star_value",self.options.default_rating_value);
            self.$input.val(self.options.default_rating_value);
        });
    },

    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _onChangeStarValue:function(){
        varval=this.get("star_value");
        varindex=Math.floor(val);
        vardecimal=val-index;
        //resetthestars
        this.$star_list.removeClass('fa-starfa-star-half-o').addClass('fa-star-o');

        this.$('.stars').find("i:lt("+index+")").removeClass('fa-star-ofa-star-half-o').addClass('fa-star');
        if(decimal){
            this.$('.stars').find("i:eq("+index+")").removeClass('fa-star-ofa-starfa-star-half-o').addClass('fa-star-half-o');
        }
        this.$('.rate_text.badge').text(this.labels[index]);
    },
    /**
     *@private
     */
    _onClickStar:function(ev){
        varindex=this.$('.starsi').index(ev.currentTarget);
        this.set("star_value",index+1);
        this.user_click=true;
        this.$input.val(this.get("star_value"));
    },
    /**
     *@private
     */
    _onMouseleaveStarBlock:function(){
        this.$('.rate_text').hide();
    },
    /**
     *@private
     *@param{MouseEvent}ev
     */
    _onMoveStar:function(ev){
        varindex=this.$('.starsi').index(ev.currentTarget);
        this.$('.rate_text').show();
        this.set("star_value",index+1);
    },
    /**
     *@private
     */
    _onMoveLeaveStar:function(){
        if(!this.user_click){
            this.set("star_value",parseInt(this.$input.val()));
        }
        this.user_click=false;
    },
});
});
