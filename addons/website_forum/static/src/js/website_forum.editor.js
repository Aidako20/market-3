flectra.define('website_forum.editor',function(require){
"usestrict";

varcore=require('web.core');
varWebsiteNewMenu=require('website.newMenu');
varDialog=require('web.Dialog');

var_t=core._t;

varForumCreateDialog=Dialog.extend({
    xmlDependencies:Dialog.prototype.xmlDependencies.concat(
        ['/website_forum/static/src/xml/website_forum_templates.xml']
    ),
    template:'website_forum.add_new_forum',
    events:_.extend({},Dialog.prototype.events,{
        'changeinput[name="privacy"]':'_onPrivacyChanged',
    }),

    /**
     *@override
     *@param{Object}parent
     *@param{Object}options
     */
    init:function(parent,options){
        options=_.defaults(options||{},{
            title:_t("NewForum"),
            size:'medium',
            buttons:[
                {
                    text:_t("Create"),
                    classes:'btn-primary',
                    click:this.onCreateClick.bind(this),
                },
                {
                    text:_t("Discard"),
                    close:true
                },
            ]
        });
        this._super(parent,options);
    },
    start:function(){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(){
            var$input=self.$('#group_id');
            $input.select2({
                width:'100%',
                allowClear:true,
                formatNoMatches:false,
                multiple:false,
                selection_data:false,
                fill_data:function(query,data){
                    varthat=this;
                    vartags={results:[]};
                    _.each(data,function(obj){
                        if(that.matcher(query.term,obj.display_name)){
                            tags.results.push({id:obj.id,text:obj.display_name});
                        }
                    });
                    query.callback(tags);
                },
                query:function(query){
                    varthat=this;
                    //fetchdataonlyonceandstoreit
                    if(!this.selection_data){
                        self._rpc({
                            model:'res.groups',
                            method:'search_read',
                            args:[[],['display_name']],
                        }).then(function(data){
                            that.fill_data(query,data);
                            that.selection_data=data;
                        });
                    }else{
                        this.fill_data(query,this.selection_data);
                    }
                }
            });
        });
    },
    onCreateClick:function(){
        var$dialog=this.$el;
        var$forumName=$dialog.find('input[name=forum_name]');
        if(!$forumName.val()){
            $forumName.addClass('border-danger');
            return;
        }
        var$forumPrivacyGroup=$dialog.find('input[name=group_id]');
        varforumPrivacy=$dialog.find('input:radio[name=privacy]:checked').val();
        if(forumPrivacy==='private'&&!$forumPrivacyGroup.val()){
            this.$("#group-required").removeClass('d-none');
            return;
        }
        varaddMenu=($dialog.find('input[type="checkbox"]').is(':checked'));
        varforumMode=$dialog.find('input:radio[name=mode]:checked').val();
        returnthis._rpc({
            route:'/forum/new',
            params:{
                forum_name:$forumName.val(),
                forum_mode:forumMode,
                forum_privacy:forumPrivacy,
                forum_privacy_group:$forumPrivacyGroup.val(),
                add_menu:addMenu||"",
            },
        }).then(function(url){
            window.location.href=url;
            returnnewPromise(function(){});
        });
    },
    /**
     *@private
     */
    _onPrivacyChanged:function(ev){
        this.$('.show_visibility_group').toggleClass('d-none',ev.target.value!=='private');
    },
});

WebsiteNewMenu.include({
    actions:_.extend({},WebsiteNewMenu.prototype.actions||{},{
        new_forum:'_createNewForum',
    }),

    //--------------------------------------------------------------------------
    //Actions
    //--------------------------------------------------------------------------

    /**
     *Askstheuserinformationaboutanewforumtocreate,thencreatesit
     *andredirectstheusertothisnewforum.
     *
     *@private
     *@returns{Promise}Unresolvedifthereisaredirection
     */
    _createNewForum:function(){
        varself=this;
        vardef=newPromise(function(resolve){
            vardialog=newForumCreateDialog(self,{});
            dialog.open();
            dialog.on('closed',self,resolve);
        });
        returndef;
    },
});
});
