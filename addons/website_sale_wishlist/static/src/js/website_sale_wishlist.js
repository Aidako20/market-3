flectra.define('website_sale_wishlist.wishlist',function(require){
"usestrict";

varpublicWidget=require('web.public.widget');
varwSaleUtils=require('website_sale.utils');
varVariantMixin=require('sale.VariantMixin');

//VariantMixineventsareoverriddenonpurposehere
//toavoidregisteringthemmorethanoncesincetheyarealreadyregistered
//inwebsite_sale.js
publicWidget.registry.ProductWishlist=publicWidget.Widget.extend(VariantMixin,{
    selector:'.oe_website_sale',
    events:{
        'click.o_wsale_my_wish':'_onClickMyWish',
        'click.o_add_wishlist,.o_add_wishlist_dyn':'_onClickAddWish',
        'changeinput.product_id':'_onChangeVariant',
        'changeinput.js_product_change':'_onChangeProduct',
        'click.wishlist-section.o_wish_rm':'_onClickWishRemove',
        'click.wishlist-section.o_wish_add':'_onClickWishAdd',
    },

    /**
     *@constructor
     */
    init:function(parent){
        this._super.apply(this,arguments);
        this.wishlistProductIDs=[];
    },
    /**
     *Getsthecurrentwishlistitems.
     *Ineditablemode,donothinginstead.
     *
     *@override
     */
    willStart:function(){
        varself=this;
        vardef=this._super.apply(this,arguments);

        varwishDef=$.get('/shop/wishlist',{
            count:1,
        }).then(function(res){
            self.wishlistProductIDs=JSON.parse(res);
        });

        returnPromise.all([def,wishDef]);
    },
    /**
     *Updatesthewishlistview(navbar)&thewishlistbutton(productpage).
     *Ineditablemode,donothinginstead.
     *
     *@override
     */
    start:function(){
        vardef=this._super.apply(this,arguments);

        this._updateWishlistView();
        //triggerchangeononlyoneinput
        if(this.$('input.js_product_change').length){//manage"ListViewofvariants"
            this.$('input.js_product_change:checked').first().trigger('change');
        }else{
            this.$('input.product_id').first().trigger('change');
        }

        returndef;
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _addNewProducts:function($el){
        varself=this;
        varproductID=$el.data('product-product-id');
        if($el.hasClass('o_add_wishlist_dyn')){
            productID=parseInt($el.closest('.js_product').find('.product_id:checked').val());;
        }
        var$form=$el.closest('form');
        vartemplateId=$form.find('.product_template_id').val();
        //whenaddingfrom/shopinsteadoftheproductpage,needanotherselector
        if(!templateId){
            templateId=$el.data('product-template-id');
        }
        $el.prop("disabled",true).addClass('disabled');
        varproductReady=this.selectOrCreateProduct(
            $el.closest('form'),
            productID,
            templateId,
            false
        );

        productReady.then(function(productId){
            productId=parseInt(productId,10);

            if(productId&&!_.contains(self.wishlistProductIDs,productId)){
                returnself._rpc({
                    route:'/shop/wishlist/add',
                    params:{
                        product_id:productId,
                    },
                }).then(function(){
                    var$navButton=$('header.o_wsale_my_wish').first();
                    self.wishlistProductIDs.push(productId);
                    self._updateWishlistView();
                    wSaleUtils.animateClone($navButton,$el.closest('form'),25,40);
                    //Itmighthappenthat`onChangeVariant`iscalledatthesametimeasthisfunction.
                    //Inthiscaseweneedtosetthebuttontodisabledagain.
                    //DothisonlyiftheproductIDisstillthesame.
                    letcurrentProductId=$el.data('product-product-id');
                    if($el.hasClass('o_add_wishlist_dyn')){
                        currentProductId=parseInt($el.closest('.js_product').find('.product_id:checked').val());
                    }
                    if(productId===currentProductId){
                        $el.prop("disabled",true).addClass('disabled');
                    }
                }).guardedCatch(function(){
                    $el.prop("disabled",false).removeClass('disabled');
                });
            }
        }).guardedCatch(function(){
            $el.prop("disabled",false).removeClass('disabled');
        });
    },
    /**
     *@private
     */
    _updateWishlistView:function(){
        const$wishButton=$('.o_wsale_my_wish');
        if($wishButton.hasClass('o_wsale_my_wish_hide_empty')){
            $wishButton.toggleClass('d-none',!this.wishlistProductIDs.length);
        }
        $wishButton.find('.my_wish_quantity').text(this.wishlistProductIDs.length);
    },
    /**
     *@private
     */
    _removeWish:function(e,deferred_redirect){
        vartr=$(e.currentTarget).parents('tr');
        varwish=tr.data('wish-id');
        varproduct=tr.data('product-id');
        varself=this;

        this._rpc({
            route:'/shop/wishlist/remove/'+wish,
        }).then(function(){
            $(tr).hide();
        });

        this.wishlistProductIDs=_.without(this.wishlistProductIDs,product);
        if(this.wishlistProductIDs.length===0){
            if(deferred_redirect){
                deferred_redirect.then(function(){
                    self._redirectNoWish();
                });
            }
        }
        this._updateWishlistView();
    },
    /**
     *@private
     */
    _addOrMoveWish:function(e){
        var$navButton=$('header.o_wsale_my_cart').first();
        vartr=$(e.currentTarget).parents('tr');
        varproduct=tr.data('product-id');
        $('.o_wsale_my_cart').removeClass('d-none');
        wSaleUtils.animateClone($navButton,tr,25,40);

        if($('#b2b_wish').is(':checked')){
            returnthis._addToCart(product,tr.find('add_qty').val()||1);
        }else{
            varadding_deffered=this._addToCart(product,tr.find('add_qty').val()||1);
            this._removeWish(e,adding_deffered);
            returnadding_deffered;
        }
    },
    /**
     *@private
     */
    _addToCart:function(productID,qty_id){
        returnthis._rpc({
            route:"/shop/cart/update_json",
            params:{
                product_id:parseInt(productID,10),
                add_qty:parseInt(qty_id,10),
                display:false,
            },
        }).then(function(data){
            wSaleUtils.updateCartNavBar(data);
            wSaleUtils.showWarning(data.warning);
        });
    },
    /**
     *@private
     */
    _redirectNoWish:function(){
        window.location.href='/shop/cart';
    },


    //--------------------------------------------------------------------------
    //Handlers
    //--------------------------------------------------------------------------

    /**
     *@private
     */
    _onClickMyWish:function(){
        if(this.wishlistProductIDs.length===0){
            this._updateWishlistView();
            this._redirectNoWish();
            return;
        }
        window.location='/shop/wishlist';
    },
    /**
     *@private
     *@param{Event}ev
     */
    _onClickAddWish:function(ev){
        this._addNewProducts($(ev.currentTarget));
    },
    /**
     *@private
     *@param{Event}ev
     */
    _onChangeVariant:function(ev){
        var$input=$(ev.target);
        var$parent=$input.closest('.js_product');
        var$el=$parent.find("[data-action='o_wishlist']");
        if(!_.contains(this.wishlistProductIDs,parseInt($input.val(),10))){
            $el.prop("disabled",false).removeClass('disabled').removeAttr('disabled');
        }else{
            $el.prop("disabled",true).addClass('disabled').attr('disabled','disabled');
        }
        $el.data('product-product-id',parseInt($input.val(),10));
    },
    /**
     *@private
     *@param{Event}ev
     */
    _onChangeProduct:function(ev){
        varproductID=ev.currentTarget.value;
        var$el=$(ev.target).closest('.js_add_cart_variants').find("[data-action='o_wishlist']");

        if(!_.contains(this.wishlistProductIDs,parseInt(productID,10))){
            $el.prop("disabled",false).removeClass('disabled').removeAttr('disabled');
        }else{
            $el.prop("disabled",true).addClass('disabled').attr('disabled','disabled');
        }
        $el.data('product-product-id',productID);
    },
    /**
     *@private
     *@param{Event}ev
     */
    _onClickWishRemove:function(ev){
        this._removeWish(ev,false);
    },
    /**
     *@private
     *@param{Event}ev
     */
    _onClickWishAdd:function(ev){
        varself=this;
        this.$('.wishlist-section.o_wish_add').addClass('disabled');
        this._addOrMoveWish(ev).then(function(){
            self.$('.wishlist-section.o_wish_add').removeClass('disabled');
        });
    },
});
});
