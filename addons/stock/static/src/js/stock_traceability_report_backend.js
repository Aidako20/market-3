flectra.define('stock.stock_report_generic',function(require){
'usestrict';

varAbstractAction=require('web.AbstractAction');
varcore=require('web.core');
varsession=require('web.session');
varReportWidget=require('stock.ReportWidget');
varframework=require('web.framework');

varQWeb=core.qweb;

varstock_report_generic=AbstractAction.extend({
    hasControlPanel:true,

    //Storesalltheparametersoftheaction.
    init:function(parent,action){
        this._super.apply(this,arguments);
        this.actionManager=parent;
        this.given_context=Object.assign({},session.user_context);
        this.controller_url=action.context.url;
        if(action.context.context){
            this.given_context=action.context.context;
        }
        this.given_context.active_id=action.context.active_id||action.params.active_id;
        this.given_context.model=action.context.active_model||false;
        this.given_context.ttype=action.context.ttype||false;
        this.given_context.auto_unfold=action.context.auto_unfold||false;
        this.given_context.lot_name=action.context.lot_name||false;
    },
    willStart:function(){
        returnPromise.all([this._super.apply(this,arguments),this.get_html()]);
    },
    set_html:function(){
        varself=this;
        vardef=Promise.resolve();
        if(!this.report_widget){
            this.report_widget=newReportWidget(this,this.given_context);
            def=this.report_widget.appendTo(this.$('.o_content'));
        }
        returndef.then(function(){
            self.report_widget.$el.html(self.html);
            self.report_widget.$el.find('.o_report_heading').html('<h1>TraceabilityReport</h1>');
            if(self.given_context.auto_unfold){
                _.each(self.$el.find('.fa-caret-right'),function(line){
                    self.report_widget.autounfold(line,self.given_context.lot_name);
                });
            }
        });
    },
    start:asyncfunction(){
        this.controlPanelProps.cp_content={$buttons:this.$buttons};
        awaitthis._super(...arguments);
        this.set_html();
    },
    //Fetchesthehtmlandispreviousreport.contextifany,elsecreateit
    get_html:asyncfunction(){
        const{html}=awaitthis._rpc({
            args:[this.given_context],
            method:'get_html',
            model:'stock.traceability.report',
        });
        this.html=html;
        this.renderButtons();
    },
    //Updatesthecontrolpanelandrendertheelementsthathaveyettoberendered
    update_cp:function(){
        if(!this.$buttons){
            this.renderButtons();
        }
        this.controlPanelProps.cp_content={$buttons:this.$buttons};
        returnthis.updateControlPanel();
    },
    renderButtons:function(){
        varself=this;
        this.$buttons=$(QWeb.render("stockReports.buttons",{}));
        //pdfoutput
        this.$buttons.bind('click',function(){
            var$element=$(self.$el[0]).find('.o_stock_reports_tabletbodytr');
            vardict=[];

            $element.each(function(index){
                var$el=$($element[index]);
                dict.push({
                        'id':$el.data('id'),
                        'model_id':$el.data('model_id'),
                        'model_name':$el.data('model'),
                        'unfoldable':$el.data('unfold'),
                        'level':$el.find('td:first').data('level')||1
                });
            });
            framework.blockUI();
            varurl_data=self.controller_url.replace('active_id',self.given_context.active_id);
            session.get_file({
                url:url_data.replace('output_format','pdf'),
                data:{data:JSON.stringify(dict)},
                complete:framework.unblockUI,
                error:(error)=>self.call('crash_manager','rpc_error',error),
            });
        });
        returnthis.$buttons;
    },
});

core.action_registry.add("stock_report_generic",stock_report_generic);
returnstock_report_generic;
});
