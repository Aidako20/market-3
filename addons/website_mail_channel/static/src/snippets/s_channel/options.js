flectra.define('website_mail_channel.s_channel_options',function(require){
'usestrict';

varcore=require('web.core');
varoptions=require('web_editor.snippets.options');
varwUtils=require('website.utils');

var_t=core._t;

options.registry.Channel=options.Class.extend({
    /**
     *@override
     */
    asyncstart(){
        awaitthis._super(...arguments);
        this.publicChannels=awaitthis._getPublicChannels();
    },
    /**
     *Ifwehavealreadycreatedchannels=>selectthefirstone
     *else=>modalprompt(createanewchannel)
     *
     *@override
     */
    onBuilt(){
        if(this.publicChannels.length){
            this.$target[0].dataset.id=this.publicChannels[0][0];
        }else{
            constwidget=this._requestUserValueWidgets('create_mail_channel_opt')[0];
            widget.$el.click();
        }
    },

    //--------------------------------------------------------------------------
    //Options
    //--------------------------------------------------------------------------

    /**
     *Createsanewmail.channelthroughamodalprompt.
     *
     *@seethis.selectClassforparameters
     */
    createChannel:function(previewMode,widgetValue,params){
        varself=this;
        returnwUtils.prompt({
            id:"editor_new_mail_channel_subscribe",
            window_title:_t("NewMailChannel"),
            input:_t("Name"),
        }).then(function(result){
            varname=result.val;
            if(!name){
                return;
            }
            returnself._rpc({
                model:'mail.channel',
                method:'create',
                args:[{
                    name:name,
                    public:'public',
                }],
            }).then(function(id){
                self.$target.attr("data-id",id);
                returnself._rerenderXML();
            });
        });
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _renderCustomXML(uiFragment){
        //TODOremovethispartinmaster
        constcreateChannelEl=uiFragment.querySelector('we-button[data-create-channel]');
        createChannelEl.dataset.name='create_mail_channel_opt';

        returnthis._getPublicChannels().then(channels=>{
            constmenuEl=uiFragment.querySelector('.select_discussion_list');
            for(constchannelofchannels){
                constel=document.createElement('we-button');
                el.dataset.selectDataAttribute=channel[0];
                el.textContent=channel[1];
                menuEl.appendChild(el);
            }
        });
    },
    /**
     *@private
     *@return{Promise}
     */
    _getPublicChannels(){
        returnthis._rpc({
            model:'mail.channel',
            method:'name_search',
            args:['',[['public','=','public']]],
        });
    },
});
});
