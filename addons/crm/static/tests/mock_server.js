flectra.define('crm.MockServer',function(require){
    'usestrict';

    varMockServer=require('web.MockServer');

    MockServer.include({
        //--------------------------------------------------------------------------
        //Private
        //--------------------------------------------------------------------------

        /**
         *@override
         *@private
         */
        async_performRpc(route,args){
            if(args.model==='crm.lead'&&args.method==='get_rainbowman_message'){
                letmessage=false;
                constrecords=this.data['crm.lead'].records;
                constrecord=records.find(r=>r.id===args.args[0][0]);
                constwon_stage=this.data['crm.stage'].records.find(s=>s.is_won);
                if(record.stage_id===won_stage.id&&record.user_id&&record.team_id&&record.planned_revenue>0){
                    constnow=moment();
                    letquery_result={};
                    //Totalwon
                    query_result['total_won']=records.filter(r=>r.stage_id===won_stage.id&&r.user_id===record.user_id).length;
                    //Maxteam30days
                    constrecordsTeam30=records.filter(r=>r.stage_id===won_stage.id&&r.team_id===record.team_id&&(!r.date_closed||moment.duration(now.diff(moment(r.date_closed))).days()<=30));
                    query_result['max_team_30']=Math.max(...recordsTeam30.map(r=>r.planned_revenue));
                    //Maxteam7days
                    constrecordsTeam7=records.filter(r=>r.stage_id===won_stage.id&&r.team_id===record.team_id&&(!r.date_closed||moment.duration(now.diff(moment(r.date_closed))).days()<=7));
                    query_result['max_team_7']=Math.max(...recordsTeam7.map(r=>r.planned_revenue));
                    //MaxUser30days
                    constrecordsUser30=records.filter(r=>r.stage_id===won_stage.id&&r.user_id===record.user_id&&(!r.date_closed||moment.duration(now.diff(moment(r.date_closed))).days()<=30));
                    query_result['max_user_30']=Math.max(...recordsUser30.map(r=>r.planned_revenue));
                    //MaxUser7days
                    constrecordsUser7=records.filter(r=>r.stage_id===won_stage.id&&r.user_id===record.user_id&&(!r.date_closed||moment.duration(now.diff(moment(r.date_closed))).days()<=7));
                    query_result['max_user_7']=Math.max(...recordsUser7.map(r=>r.planned_revenue));

                    if(query_result.total_won===1){
                        message="Go,go,go!Congratsforyourfirstdeal.";
                    }elseif(query_result.max_team_30===record.planned_revenue){
                        message="Boom!Teamrecordforthepast30days.";
                    }elseif(query_result.max_team_7===record.planned_revenue){
                        message="Yeah!Dealofthelast7daysfortheteam.";
                    }elseif(query_result.max_user_30===record.planned_revenue){
                        message="Youjustbeatyourpersonalrecordforthepast30days.";
                    }elseif(query_result.max_user_7===record.planned_revenue){
                        message="Youjustbeatyourpersonalrecordforthepast7days.";
                    }
                }
                returnmessage;
            }
            returnthis._super(...arguments);
        },
    });
});
