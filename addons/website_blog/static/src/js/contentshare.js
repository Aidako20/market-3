flectra.define('website_blog.contentshare',function(require){
'usestrict';

constdom=require('web.dom');

$.fn.share=function(options){
    varoption=$.extend($.fn.share.defaults,options);
    varselected_text="";
    $.extend($.fn.share,{
        init:function(shareable){
            varself=this;
            $.fn.share.defaults.shareable=shareable;
            $.fn.share.defaults.shareable.on('mouseup',function(){
                if($(this).parents('body.editor_enable').length===0){
                    self.popOver();
                }
            });
            $.fn.share.defaults.shareable.on('mousedown',function(){
                self.destroy();
            });
        },
        getContent:function(){
            var$popover_content=$('<divclass="h4m-0"/>');
            if($('.o_wblog_title,.o_wblog_post_content_field').hasClass('js_comment')){
                selected_text=this.getSelection('string');
                var$btn_c=$('<aclass="o_share_commentbtnbtn-linkpx-2"href="#"/>').append($('<iclass="fafa-lgfa-comment"/>'));
                $popover_content.append($btn_c);
            }
            if($('.o_wblog_title,.o_wblog_post_content_field').hasClass('js_tweet')){
                vartweet='"%s"-%s';
                varbaseLength=tweet.replace(/%s/g,'').length;
                //Shortentheselectedtexttomatchthetweetmaxlength
                //Note:all(non-localhost)urlsinatweethave23charactershttps://support.twitter.com/articles/78124
                varselectedText=this.getSelection('string').substring(0,option.maxLength-baseLength-23);

                vartext=window.btoa(encodeURIComponent(_.str.sprintf(tweet,selectedText,window.location.href)));
                $popover_content.append(_.str.sprintf(
                    "<aonclick=\"window.open('%s'+atob('%s'),'_%s','location=yes,height=570,width=520,scrollbars=yes,status=yes')\"><iclass=\"ml4mr4fafa-twitterfa-lg\"/></a>",
                    option.shareLink,text,option.target));
            }
            return$popover_content;
        },
        commentEdition:function(){
            $(".o_portal_chatter_composer_formtextarea").val('"'+selected_text+'"').focus();
            constcommentsEl=$('#o_wblog_post_comments')[0];
            if(commentsEl){
                dom.scrollTo(commentsEl).then(()=>{
                    window.location.hash='blog_post_comment_quote';
                });
            }
        },
        getSelection:function(share){
            if(window.getSelection){
                varselection=window.getSelection();
                if(!selection||selection.rangeCount===0){
                    return"";
                }
                if(share==='string'){
                    returnString(selection.getRangeAt(0)).replace(/\s{2,}/g,'');
                }else{
                    returnselection.getRangeAt(0);
                }
            }elseif(document.selection){
                if(share==='string'){
                    returndocument.selection.createRange().text.replace(/\s{2,}/g,'');
                }else{
                    returndocument.selection.createRange();
                }
            }
        },
        popOver:function(){
            this.destroy();
            if(this.getSelection('string').length<option.minLength){
                return;
            }
            vardata=this.getContent();
            varrange=this.getSelection();

            varnewNode=document.createElement("span");
            range.insertNode(newNode);
            newNode.className=option.className;
            var$pop=$(newNode);
            $pop.popover({
                trigger:'manual',
                placement:option.placement,
                html:true,
                content:function(){
                    returndata;
                }
            }).popover('show');
            $('.o_share_comment').on('click',this.commentEdition);
        },
        destroy:function(){
            var$span=$('span.'+option.className);
            $span.popover('hide');
            $span.remove();
        }
    });
    $.fn.share.init(this);
};

$.fn.share.defaults={
    shareLink:"http://twitter.com/intent/tweet?text=",
    minLength:5,
    maxLength:140,
    target:"blank",
    className:"share",
    placement:"top",
};
});
