<?xmlversion="1.0"encoding="utf-8"?>
<flectra>
    <data>

<templateid="account_invoice_line_it_FatturaPA">
                <DettaglioLinee>
                    <NumeroLineat-esc="line_dict['line_number']"/>
                    <CodiceArticolot-if="line.product_id.barcode">
                        <CodiceTipo>EAN</CodiceTipo>
                        <CodiceValoret-esc="format_alphanumeric(line.product_id.barcode)[:35]"/>
                    </CodiceArticolo>
                    <CodiceArticolot-elif="line.product_id.default_code">
                        <CodiceTipo>INTERNAL</CodiceTipo>
                        <CodiceValoret-esc="format_alphanumeric(line.product_id.default_code)[:35]"/>
                    </CodiceArticolo>
                    <Descrizionet-esc="format_alphanumeric(line_dict['description'])[:1000]"/>
                    <Quantitat-esc="format_numbers(abs(line.quantity))"/>
                    <UnitaMisurat-if="line.product_uom_idandline.product_uom_id.category_id!=env.ref('uom.product_uom_categ_unit')"t-esc="format_alphanumeric(line.product_uom_id.name)[:10]"/>
                    <PrezzoUnitariot-esc="'%.06f'%(line_dict['unit_price'])"/>
                    <ScontoMaggiorazionet-if="line.discount!=0">
                        <Tipot-esc="discount_type(line.discount)"/>
                        <Percentualet-esc="format_numbers(abs(line.discount))"/>
                    </ScontoMaggiorazione>
                    <PrezzoTotalet-esc="format_monetary(line_dict['subtotal_price'],currency)"/>
                    <AliquotaIVAt-if="line.tax_ids.amount_type=='percent'"t-esc="format_numbers(line.tax_ids.amount)"/>
                    <AliquotaIVAt-elif="line.tax_ids.amount_type!='percent'"t-esc="'0.00'"/>
                    <Naturat-if="line.tax_ids.l10n_it_has_exoneration"t-esc="line.tax_ids.l10n_it_kind_exoneration"/>
                    <AltriDatiGestionalit-if="conversion_rate">
                        <TipoDato>Currency</TipoDato>
                        <RiferimentoTestot-esc="format_alphanumeric(record.currency_id.name)"/>
                        <RiferimentoNumerot-esc="'%.06f'%line.price_subtotal"/>
                    </AltriDatiGestionali>
                    <AltriDatiGestionalit-if="conversion_rate">
                        <TipoDato>Exch.Rate</TipoDato>
                        <RiferimentoNumerot-esc="conversion_rate"/>
                        <RiferimentoDatat-esc="format_date(record.invoice_date)"/>
                    </AltriDatiGestionali>
                </DettaglioLinee>
</template>

<templateid="account_invoice_it_FatturaPA_export">
<p:FatturaElettronicat-att-versione="formato_trasmissione"xmlns:ds="http://www.w3.org/2000/09/xmldsig#"xmlns:p="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2"xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"xsi:schemaLocation="http://ivaservizi.agenziaentrate.gov.it/docs/xsd/fatture/v1.2http://www.fatturapa.gov.it/export/fatturazione/sdi/fatturapa/v1.2/Schema_del_file_xml_FatturaPA_versione_1.2.xsd">
    <FatturaElettronicaHeader>
        <DatiTrasmissione>
            <IdTrasmittente>
                <IdPaeset-esc="get_vat_country(sender.vat)"/>
                <IdCodicet-esc="normalize_codice_fiscale(sender.l10n_it_codice_fiscale)orget_vat_number(sender.vat)"/>
            </IdTrasmittente>
            <ProgressivoInviot-esc="format_alphanumeric(record.name.replace('/','')[-10:])"/>
            <FormatoTrasmissionet-esc="formato_trasmissione"/>
            <CodiceDestinatariot-esc="codice_destinatario"/>
            <ContattiTrasmittente>
                <Telefonot-if="sender_partner.phone"t-esc="format_alphanumeric(format_phone(sender_partner.phone))"/>
                <Telefonot-elif="sender_partner.mobile"t-esc="format_alphanumeric(format_phone(sender_partner.mobile))"/>
                <Emailt-if="sender_partner.email"t-esc="sender_partner.email[:256]"/>
            </ContattiTrasmittente>
            <PECDestinatariot-if="notis_self_invoiceandpartner.l10n_it_pec_email"t-esc="partner.l10n_it_pec_email[:256]"/>
        </DatiTrasmissione>
        <CedentePrestatore>
            <DatiAnagrafici>
                <IdFiscaleIVAt-if="seller.vatandin_eu(seller)">
                    <IdPaeset-esc="get_vat_country(seller.vat)"/>
                    <IdCodicet-esc="get_vat_number(seller.vat)"/>
                </IdFiscaleIVA>
                <IdFiscaleIVAt-if="seller.vatandnotin_eu(seller)">
                    <IdPaeset-esc="seller.country_id.code"/>
                    <IdCodicet-esc="'OO99999999999'"/>
                </IdFiscaleIVA>
                <IdFiscaleIVAt-if="notseller.vatandseller.country_id.code!='IT'">
                    <IdPaeset-esc="seller.country_id.code"/>
                    <IdCodicet-esc="'0000000'"/>
                </IdFiscaleIVA>
                <CodiceFiscalet-if="seller.l10n_it_codice_fiscale"t-esc="normalize_codice_fiscale(seller.l10n_it_codice_fiscale)"/>
                <Anagrafica>
                    <Denominazionet-esc="format_alphanumeric(seller_partner.display_name[:80])"/>
                </Anagrafica>
                <RegimeFiscalet-esc="regime_fiscale"/>
            </DatiAnagrafici>
            <tt-call="l10n_it_edi.account_invoice_it_FatturaPA_sede">
                <tt-set="partner"t-value="seller_partner"/>
            </t>
            <IscrizioneREAt-if="notis_self_invoiceandcompany.l10n_it_has_eco_index">
                <Ufficiot-esc="company.l10n_it_eco_index_office.code"/>
                <NumeroREAt-esc="format_alphanumeric(company.l10n_it_eco_index_number)"/>
                <CapitaleSocialet-if="company.l10n_it_eco_index_share_capital!=0"t-esc="format_numbers_two(company.l10n_it_eco_index_share_capital)"/>
                <SocioUnicot-if="company.l10n_it_eco_index_sole_shareholder!='NO'"t-esc="company.l10n_it_eco_index_sole_shareholder"/>
                <StatoLiquidazionet-esc="company.l10n_it_eco_index_liquidation_state"/>
            </IscrizioneREA>
        </CedentePrestatore>
        <RappresentanteFiscalet-if="notis_self_invoiceandrepresentative">
            <DatiAnagrafici>
                <IdFiscaleIVA>
                    <IdPaeset-esc="get_vat_country(representative.vat)"/>
                    <IdCodicet-esc="get_vat_number(representative.vat)"/>
                </IdFiscaleIVA>
                <CodiceFiscalet-if="representative.l10n_it_codice_fiscale"t-esc="normalize_codice_fiscale(representative.l10n_it_codice_fiscale)"/>
                <Anagrafica>
                <tt-if="representative.is_company">
                    <Denominazionet-esc="format_alphanumeric(representative.display_name[:80])"/>
                </t>
                <tt-else="">
                    <Nomet-esc="format_alphanumeric(''.join(representative.name.split()[:1])[:60])"/>
                    <Cognomet-esc="format_alphanumeric(''.join(representative.name.split()[1:])[:60])"/>
                </t>
                </Anagrafica>
            </DatiAnagrafici>
        </RappresentanteFiscale>
        <CessionarioCommittente>
            <DatiAnagrafici>
                <IdFiscaleIVAt-if="buyer.vatandin_eu(buyer)">
                    <IdPaeset-esc="get_vat_country(buyer.vat)"/>
                    <IdCodicet-esc="get_vat_number(buyer.vat)"/>
                </IdFiscaleIVA>
                <IdFiscaleIVAt-if="buyer.vatandnotin_eu(buyer)">
                    <IdPaeset-esc="buyer.country_id.code"/>
                    <IdCodicet-esc="'OO99999999999'"/>
                </IdFiscaleIVA>
                <IdFiscaleIVAt-if="notbuyer.vatandbuyer.country_id.code!='IT'">
                    <IdPaeset-esc="buyer.country_id.code"/>
                    <IdCodicet-esc="'0000000'"/>
                </IdFiscaleIVA>
                <CodiceFiscalet-if="buyer.l10n_it_codice_fiscale"t-esc="normalize_codice_fiscale(buyer.l10n_it_codice_fiscale)"/>
                <Anagrafica>
                    <tt-if="buyer_is_company">
                        <Denominazionet-esc="format_alphanumeric(buyer.display_name[:80])"/>
                    </t>
                    <tt-else="">
                        <Nomet-esc="format_alphanumeric(''.join(buyer.name.split()[:1])[:60])"/>
                        <Cognomet-esc="format_alphanumeric(''.join(buyer.name.split()[1:])[:60])"/>
                    </t>
                </Anagrafica>
            </DatiAnagrafici>
            <tt-call="l10n_it_edi.account_invoice_it_FatturaPA_sede">
                <tt-set="partner"t-value="buyer_partner"/>
            </t>
        </CessionarioCommittente>
    </FatturaElettronicaHeader>
    <FatturaElettronicaBody>
        <DatiGenerali>
            <DatiGeneraliDocumento>
                <TipoDocumentot-esc="document_type"/>
                <Divisat-esc="currency.name"/>
                <Datat-esc="format_date(record.invoice_date)"/>
                <Numerot-esc="format_alphanumeric(record.name[-20:])"/>
                <DatiBollot-if="record.l10n_it_stamp_duty">
                    <BolloVirtuale>SI</BolloVirtuale>
                    <ImportoBollot-esc="format_numbers(record.l10n_it_stamp_duty)"/>
                </DatiBollo>
                <ImportoTotaleDocumentot-esc="format_monetary(document_total,currency)"/>
            </DatiGeneraliDocumento>
            <DatiOrdineAcquistot-if="record.ref">
                <IdDocumentot-esc="format_alphanumeric(record.ref[:20])"/>
            </DatiOrdineAcquisto>
            <DatiDDTt-if="record.l10n_it_ddt_id">
                <NumeroDDTt-esc="format_alphanumeric(record.l10n_it_ddt_id.name[-20:])"/>
                <DataDDTt-esc="format_date(record.l10n_it_ddt_id.date)"/>
            </DatiDDT>
        </DatiGenerali>
        <DatiBeniServizi>
            <tt-foreach="invoice_lines"t-as="line_dict">
                <tt-set="line"t-value="line_dict['line']"/>
                <tt-call="l10n_it_edi.account_invoice_line_it_FatturaPA"/>
            </t>
            <tt-foreach="tax_details['tax_details']"t-as="tax_name">
                <tt-set="tax_dict"t-value="tax_details['tax_details'][tax_name]"/>
                <tt-set="tax"t-value="tax_dict['tax']"/>
                <tt-set="has_exoneration"t-value="tax.l10n_it_has_exoneration"/>
                <tt-set="kind_exoneration"t-value="tax.l10n_it_kind_exoneration"/>
                <DatiRiepilogo>
                    <AliquotaIVAt-esc="format_numbers(tax.amount)"/>
                    <Naturat-if="has_exoneration"t-esc="kind_exoneration"/>
                    <Arrotondamentot-if="(tax_dict.get('rounding')andcurrency.name!='EUR')or(tax_dict.get('rounding_euros')andcurrency.name=='EUR')"t-esc="format_numbers(tax_dict['rounding']ifcurrency.name!='EUR'elsetax_dict['rounding_euros'])"/>
                    <ImponibileImportot-esc="format_monetary(tax_dict['base_amount']ifcurrency.name=='EUR'elsetax_dict['base_amount_currency'],currency)"/>
                    <Impostat-esc="format_monetary(tax_dict['tax_amount']ifcurrency.name=='EUR'elsetax_dict['base_amount_currency'],currency)"/>
                    <EsigibilitaIVAt-if="nothas_exonerationorkind_exoneration=='N6'"t-esc="tax.l10n_it_vat_due_date"/>
                    <RiferimentoNormativot-if="tax.l10n_it_law_reference"t-esc="format_alphanumeric(tax.l10n_it_law_reference[:100])"/>
                </DatiRiepilogo>
            </t>
        </DatiBeniServizi>
        <DatiPagamentot-if="partner_bankandrecord.move_type!='out_refund'">
            <tt-set="payments"t-value="record.line_ids.filtered(lambdaline:line.account_id.user_type_id.typein('receivable','payable'))"/>
            <CondizioniPagamento><tt-if="len(payments)==1">TP02</t><tt-else="">TP01</t></CondizioniPagamento>
            <tt-foreach="payments"t-as="payment">
                <DettaglioPagamento>
                    <ModalitaPagamento>MP05</ModalitaPagamento>
                    <DataScadenzaPagamentot-esc="format_date(payment.date_maturity)"/>
                    <ImportoPagamentot-esc="format_monetary(abs(payment.price_total),currency)"/>
                    <IstitutoFinanziariot-if="partner_bank.bank_id"t-esc="format_alphanumeric(partner_bank.bank_id.name[:80])"/>
                    <IBANt-if="partner_bank.acc_type=='iban'"t-esc="partner_bank.sanitized_acc_number"/>
                    <BICt-elif="partner_bank.acc_type=='bank'andpartner_bank.bank_id.bic"t-esc="partner_bank.bank_id.bic"/>
                    <CodicePagamentot-if="record.payment_reference"t-esc="format_alphanumeric(record.payment_reference[:60])"/>
                </DettaglioPagamento>
            </t>
        </DatiPagamento>
        <Allegatit-if="pdf">
            <NomeAttachmentt-esc="format_alphanumeric(pdf_name[:60])"/>
            <FormatoAttachment>PDF</FormatoAttachment>
            <Attachmentt-esc="pdf"/>
        </Allegati>
    </FatturaElettronicaBody>
</p:FatturaElettronica>
</template>

<templateid="account_invoice_it_FatturaPA_sede">
            <Sede>
                <Indirizzo><tt-if="partner.streetorpartner.street2"t-esc="format_alphanumeric((partner.streetor'')+''+(partner.street2or''))[:60]"/></Indirizzo>
                <CAP><tt-if="partner.country_id.code!='IT'"t-esc="'00000'"/><tt-elif="partner.zip"t-esc="partner.zip"/></CAP>
                <Comunet-esc="format_alphanumeric(partner.city[:60])"/>
                <Provinciat-if="partner.country_id.code=='IT'andpartner.state_id"t-esc="partner.state_id.code[:2]"/>
                <Nazionet-esc="partner.country_id.code"/>
            </Sede>
</template>

    </data>
</flectra>

