flectra.define('website_mass_mailing.editor',function(require){
'usestrict';

varcore=require('web.core');
varrpc=require('web.rpc');
varWysiwygMultizone=require('web_editor.wysiwyg.multizone');
varWysiwygTranslate=require('web_editor.wysiwyg.multizone.translate');
varoptions=require('web_editor.snippets.options');
varwUtils=require('website.utils');

constqweb=core.qweb;
var_t=core._t;


options.registry.mailing_list_subscribe=options.Class.extend({
    popup_template_id:"editor_new_mailing_list_subscribe_button",
    popup_title:_t("AddaNewsletterSubscribeButton"),

    //--------------------------------------------------------------------------
    //Options
    //--------------------------------------------------------------------------

    /**
     *Allowstoselectmailinglist.
     *
     *@seethis.selectClassforparameters
     */
    select_mailing_list:function(previewMode,value){
        varself=this;
        vardef=wUtils.prompt({
            'id':this.popup_template_id,
            'window_title':this.popup_title,
            'select':_t("Newsletter"),
            'init':function(field,dialog){
                returnrpc.query({
                    model:'mailing.list',
                    method:'name_search',
                    args:['',[['is_public','=',true]]],
                    context:self.options.recordInfo.context,
                }).then(function(data){
                    $(dialog).find('.btn-primary').prop('disabled',!data.length);
                    varlist_id=self.$target.attr("data-list-id");
                    $(dialog).on('show.bs.modal',function(){
                        if(list_id!=="0"){
                            $(dialog).find('select').val(list_id);
                        };
                    });
                    returndata;
                });
            },
        });
        def.then(function(result){
            self.$target.attr("data-list-id",result.val);
        });
        returndef;
    },
    /**
     *@seethis.selectClassforparameters
     */
    toggleThanksButton(previewMode,widgetValue,params){
        constsubscribeBtnEl=this.$target[0].querySelector('.js_subscribe_btn');
        constthanksBtnEl=this.$target[0].querySelector('.js_subscribed_btn');

        thanksBtnEl.classList.toggle('o_disable_preview',!widgetValue);
        thanksBtnEl.classList.toggle('o_enable_preview',widgetValue);
        subscribeBtnEl.classList.toggle('o_enable_preview',!widgetValue);
        subscribeBtnEl.classList.toggle('o_disable_preview',widgetValue);
    },
    /**
     *@override
     */
    onBuilt:function(){
        varself=this;
        this._super();
        this.select_mailing_list('click').guardedCatch(function(){
            self.getParent()._onRemoveClick($.Event("click"));
        });
    },
    /**
     *@override
     */
    cleanForSave(){
        constpreviewClasses=['o_disable_preview','o_enable_preview'];
        this.$target[0].querySelector('.js_subscribe_btn').classList.remove(...previewClasses);
        this.$target[0].querySelector('.js_subscribed_btn').classList.remove(...previewClasses);
    },

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _computeWidgetState(methodName,params){
        if(methodName!=='toggleThanksButton'){
            returnthis._super(...arguments);
        }
        constsubscribeBtnEl=this.$target[0].querySelector('.js_subscribe_btn');
        returnsubscribeBtnEl&&subscribeBtnEl.classList.contains('o_disable_preview')?
            'true':'';
    },
    /**
     *@override
     */
    _renderCustomXML(uiFragment){
        constcheckboxEl=document.createElement('we-checkbox');
        checkboxEl.setAttribute('string',_t("DisplayThanksButton"));
        checkboxEl.dataset.toggleThanksButton='true';
        checkboxEl.dataset.noPreview='true';
        //Preventthisoptionfromtriggeringarefreshofthepublicwidget.
        checkboxEl.dataset.noWidgetRefresh='true';
        uiFragment.appendChild(checkboxEl);
    },
});

options.registry.recaptchaSubscribe=options.Class.extend({
    xmlDependencies:['/google_recaptcha/static/src/xml/recaptcha.xml'],

    /**
     *Toggletherecaptchalegalterms
     */
    toggleRecaptchaLegal:function(previewMode,value,params){
        constrecaptchaLegalEl=this.$target[0].querySelector('.o_recaptcha_legal_terms');
        if(recaptchaLegalEl){
            recaptchaLegalEl.remove();
        }else{
            consttemplate=document.createElement('template');
            template.innerHTML=qweb.render("google_recaptcha.recaptcha_legal_terms");
            this.$target[0].appendChild(template.content.firstElementChild);
        }
    },

    //----------------------------------------------------------------------
    //Private
    //----------------------------------------------------------------------

    /**
     *@override
     */
    _computeWidgetState:function(methodName,params){
        switch(methodName){
            case'toggleRecaptchaLegal':
                return!this.$target[0].querySelector('.o_recaptcha_legal_terms')||'';
        }
        returnthis._super(...arguments);
    },
});

options.registry.newsletter_popup=options.registry.mailing_list_subscribe.extend({
    popup_template_id:"editor_new_mailing_list_subscribe_popup",
    popup_title:_t("AddaNewsletterSubscribePopup"),

    /**
     *@override
     */
    start:function(){
        this.$target.on('hidden.bs.modal.newsletter_popup_option',()=>{
            this.trigger_up('snippet_option_visibility_update',{show:false});
        });
        returnthis._super(...arguments);
    },
    /**
     *@override
     */
    onTargetShow:function(){
        //Openthemodal
        this.$target.data('quick-open',true);
        returnthis._refreshPublicWidgets();
    },
    /**
     *@override
     */
    onTargetHide:function(){
        //Closethemodal
        const$modal=this.$('.modal');
        if($modal.length&&$modal.is('.modal_shown')){
            $modal.modal('hide');
        }
    },
    /**
     *@override
     */
    cleanForSave:function(){
        varself=this;
        varcontent=this.$target.data('content');
        if(content){
            const$layout=$('<div/>',{html:content});
            constpreviewClasses=['o_disable_preview','o_enable_preview'];
            $layout[0].querySelector('.js_subscribe_btn').classList.remove(...previewClasses);
            $layout[0].querySelector('.js_subscribed_btn').classList.remove(...previewClasses);
            this.trigger_up('get_clean_html',{
                $layout:$layout,
                callback:function(html){
                    self.$target.data('content',html);
                },
            });
        }
    },
    /**
     *@override
     */
    destroy:function(){
        this.$target.off('.newsletter_popup_option');
        this._super.apply(this,arguments);
    },

    //--------------------------------------------------------------------------
    //Options
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    select_mailing_list:function(){
        varself=this;
        returnthis._super.apply(this,arguments).then(function(){
            self.$target.data('quick-open',true);
            self.$target.removeData('content');
            returnself._refreshPublicWidgets();
        });
    },
});

WysiwygMultizone.include({

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    _saveElement:function(outerHTML,recordInfo,editable){
        varself=this;
        vardefs=[this._super.apply(this,arguments)];
        var$popups=$(editable).find('.o_newsletter_popup');
        _.each($popups,function(popup){
            var$popup=$(popup);
            varcontent=$popup.data('content');
            if(content){
                defs.push(self._rpc({
                    route:'/website_mass_mailing/set_content',
                    params:{
                        'newsletter_id':parseInt($popup.attr('data-list-id')),
                        'content':content,
                    },
                }));
            }
        });
        returnPromise.all(defs);
    },
});

WysiwygTranslate.include({
    /**
     *@override
     */
    start:function(){
        this.$target.on('click.newsletter_popup_option','.o_edit_popup',function(ev){
            alert(_t('WebsitepopupscanonlybetranslatedthroughmailinglistconfigurationintheEmailMarketingapp.'));
        });
        this._super.apply(this,arguments);
    },
});

options.registry.Parallax.include({

    //--------------------------------------------------------------------------
    //Private
    //--------------------------------------------------------------------------

    /**
     *@override
     */
    async_computeVisibility(){
        //Hidesparallaxoptionsforsnippetsthatareinsidea"Newsletter"
        //popupbecausetheparallaxeffectisnotworkinginthiscase.This
        //isduetothescrollbarwhichisonthe"modal-body"elementandnot
        //onthe"modal"element.
        //TODOinmaster:Makesurethatthescrollbarisinthesameplaceas
        //forthe"s_popup"snippetforthe"Newsletter"popupandmakethe
        //parallaxeffectwork.
        if(this.$target[0].closest('.o_newsletter_popup')){
            returnfalse;
        }
        returnthis._super.apply(this,arguments);
    },
});

});
