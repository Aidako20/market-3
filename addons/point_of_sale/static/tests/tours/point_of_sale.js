flectra.define('point_of_sale.tour.pricelist',function(require){
    "usestrict";

    varTour=require('web_tour.tour');
    varrpc=require('web.rpc');
    varutils=require('web.utils');
    varround_di=utils.round_decimals;

    functionassert(condition,message){
        if(!condition){
            throwmessage||"Assertionfailed";
        }
    }

    function_build_pricelist_context(pricelist,quantity,date){
        return{
            pricelist:pricelist.id,
            quantity:quantity,
        };
    }

    functioncompare_backend_frontend(product,pricelist_name,quantity){
        returnfunction(){
            varpricelist=_.findWhere(posmodel.pricelists,{name:pricelist_name});
            varfrontend_price=product.get_price(pricelist,quantity);
            //ORMappliesdigits=onnon-storedcomputedfieldwhen
            //reading.Itdoesnothowevertruncatelikeitdoeswhen
            //storingthefield.
            frontend_price=round_di(frontend_price,posmodel.dp['ProductPrice']);

            varcontext=_build_pricelist_context(pricelist,quantity);
            returnrpc.query({model:'product.product',method:'read',args:[[product.id],['price']],context:context})
                .then(function(backend_result){
                    vardebug_info=_.extend(context,{
                        product:product.id,
                        product_display_name:product.display_name,
                        pricelist_name:pricelist.name,
                    });
                    varbackend_price=backend_result[0].price;
                    assert(frontend_price===backend_price,
                           JSON.stringify(debug_info)+'DOESN\'TMATCH->'+backend_price+'(backend)!='+frontend_price+'(frontend)');
                    returnPromise.resolve();
                });
        };
    }

    //Theglobalposmodelisonlypresentwhentheposmodelisinstanciated
    //So,waitforeverythiongtobeloaded
    varsteps=[{//Leavecategorydisplayedbydefault
        content:'waitingforloadingtofinish',
        extra_trigger:'body.pos:not(:has(.loader))',//Poshasfinishedloading
        trigger:'body:not(.oe_wait)',//WebClienthasfinishedLoading
        run:function(){
            varproduct_wall_shelf=posmodel.db.search_product_in_category(0,'WallShelfUnit')[0];
            varproduct_small_shelf=posmodel.db.search_product_in_category(0,'SmallShelf')[0];
            varproduct_magnetic_board=posmodel.db.search_product_in_category(0,'MagneticBoard')[0];
            varproduct_monitor_stand=posmodel.db.search_product_in_category(0,'MonitorStand')[0];
            varproduct_desk_pad=posmodel.db.search_product_in_category(0,'DeskPad')[0];
            varproduct_letter_tray=posmodel.db.search_product_in_category(0,'LetterTray')[0];
            varproduct_whiteboard=posmodel.db.search_product_in_category(0,'Whiteboard')[0];

            compare_backend_frontend(product_letter_tray,'PublicPricelist',0,undefined)()
                .then(compare_backend_frontend(product_letter_tray,'PublicPricelist',1,undefined))
                .then(compare_backend_frontend(product_letter_tray,'Fixed',1,undefined))
                .then(compare_backend_frontend(product_wall_shelf,'Fixed',1,undefined))
                .then(compare_backend_frontend(product_small_shelf,'Fixed',1,undefined))
                .then(compare_backend_frontend(product_wall_shelf,'Percentage',1,undefined))
                .then(compare_backend_frontend(product_small_shelf,'Percentage',1,undefined))
                .then(compare_backend_frontend(product_magnetic_board,'Percentage',1,undefined))
                .then(compare_backend_frontend(product_wall_shelf,'Formula',1,undefined))
                .then(compare_backend_frontend(product_small_shelf,'Formula',1,undefined))
                .then(compare_backend_frontend(product_magnetic_board,'Formula',1,undefined))
                .then(compare_backend_frontend(product_monitor_stand,'Formula',1,undefined))
                .then(compare_backend_frontend(product_desk_pad,'Formula',1,undefined))
                .then(compare_backend_frontend(product_wall_shelf,'min_quantityordering',1,undefined))
                .then(compare_backend_frontend(product_wall_shelf,'min_quantityordering',2,undefined))
                .then(compare_backend_frontend(product_letter_tray,'Categoryvsnocategory',1,undefined))
                .then(compare_backend_frontend(product_letter_tray,'Category',1,undefined))
                .then(compare_backend_frontend(product_wall_shelf,'Producttemplate',1,undefined))
                .then(compare_backend_frontend(product_wall_shelf,'Dates',1,undefined))
                .then(compare_backend_frontend(product_small_shelf,'Pricelistbaserounding',1,undefined))
                .then(compare_backend_frontend(product_whiteboard,'PublicPricelist',1,undefined))
                .then(function(){
                    $('.pos').addClass('done-testing');
                });
        },
    }];

    steps=steps.concat([{
        content:"waitforunitteststofinish",
        trigger:".pos.done-testing",
        run:function(){},//it'sacheck
    },{
        content:"clickcategoryswitch",
        trigger:".breadcrumb-home",
        run:'click',
    },{
        content:"clickpricelistbutton",
        trigger:".control-button.o_pricelist_button",
    },{
        content:"verifydefaultpricelistisset",
        trigger:".selection-item.selected:contains('PublicPricelist')",
        run:function(){},//it'sacheck
    },{
        content:"selectfixedpricelist",
        trigger:".selection-item:contains('Fixed')",
    },{
        content:"opencustomerlist",
        trigger:"button.set-customer",
    },{
        content:"selectDecoAddict",
        trigger:".client-line:contains('DecoAddict')",
    },{
        content:"confirmselection",
        trigger:".clientlist-screen.next",
    },{
        content:"clickpricelistbutton",
        trigger:".control-button.o_pricelist_button",
    },{
        content:"verifypricelistchanged",
        trigger:".selection-item.selected:contains('PublicPricelist')",
        run:function(){},//it'sacheck
    },{
        content:"cancelpricelistdialog",
        trigger:".button.cancel:visible",
    },{
        content:"opencustomerlist",
        trigger:"button.set-customer",
    },{
        content:"selectLumberInc",
        trigger:".client-line:contains('LumberInc')",
    }, {
        content:"confirmselection",
        trigger:".clientlist-screen.next",
    },{
        content:"clickpricelistbutton",
        trigger:".control-button.o_pricelist_button",
    },{
        content:"verifypricelistremainedpublicpricelist('Notloaded'isnotavailable)",
        trigger:".selection-item.selected:contains('PublicPricelist')",
        run:function(){},//it'sacheck
    },{
        content:"cancelpricelistdialog",
        trigger:".button.cancel:visible",
    }, {
        content:"clickpricelistbutton",
        trigger:".control-button.o_pricelist_button",
    },{
        content:"selectfixedpricelist",
        trigger:".selection-item:contains('min_quantityordering')",
    },{
        content:"order1kgshelf",
        trigger:".product:contains('WallShelf')",
    },{
        content:"changeqtyto2kg",
        trigger:".numpadbutton.input-button:visible:contains('2')",
    },{
        content:"qtyofWallShelflineshouldbe2",
        trigger:".order-container.orderlines.orderline.selected.product-name:contains('WallShelf')",
        extra_trigger:".order-container.orderlines.orderline.selected.product-name:contains('WallShelf')~.info-list.infoem:contains('2.0')",
        run:function(){},
    },{
        content:"verifythatunitpriceofshelfchangedto$1",
        trigger:".total>.value:contains('$2.00')",
        run:function(){},
    },{
        content:"orderdifferentshelf",
        trigger:".product:contains('SmallShelf')",
    },{
        content:"SmallShelflineshouldbeselectedwithquantity1",
        trigger:".order-container.orderlines.orderline.selected.product-name:contains('SmallShelf')",
        extra_trigger:".order-container.orderlines.orderline.selected.product-name:contains('SmallShelf')~.info-list.infoem:contains('1.0')",
        run:function(){}
    },{
        content:"changetopricemode",
        trigger:".numpadbutton:contains('Price')",
    },{
        content:"makesurepricemodeisactivated",
        trigger:".numpadbutton.selected-mode:contains('Price')",
        run:function(){},
    },{
        content:"manuallyoverridetheunitpriceoftheseshelfto$5",
        trigger:".numpadbutton.input-button:visible:contains('5')",
    },{
        content:"SmallShelflineshouldbeselectedwithunitpriceof5",
        trigger:".order-container.orderlines.orderline.selected.product-name:contains('SmallShelf')",
        extra_trigger:".order-container.orderlines.orderline.selected.product-name:contains('SmallShelf')~.price:contains('5.0')",
    },{
        content:"changebacktoqtymode",
        trigger:".numpadbutton:contains('Qty')",
    },{
        content:"makesureqtymodeisactivated",
        trigger:".numpadbutton.selected-mode:contains('Qty')",
        run:function(){},
    },{
        content:"clickpricelistbutton",
        trigger:".control-button.o_pricelist_button",
    },{
        content:"selectpublicpricelist",
        trigger:".selection-item:contains('PublicPricelist')",
    },{
        content:"verifythatthebonishelfhavebeenrecomputedandtheshelfhavenot(theirpricewasmanuallyoverridden)",
        trigger:".total>.value:contains('$8.96')",
    },{
        content:"clickpricelistbutton",
        trigger:".control-button.o_pricelist_button",
    },{
        content:"selectfixedpricelist",
        trigger:".selection-item:contains('min_quantityordering')",
    },{
        content:"closethePointofSalefrontend",
        trigger:".header-button",
    },{
        content:"confirmclosingthefrontend",
        trigger:".header-button",
        run:function(){},//it'sacheck,
    }]);

    Tour.register('pos_pricelist',{test:true,url:'/pos/ui'},steps);
});

flectra.define('point_of_sale.tour.acceptance',function(require){
    "usestrict";

    varTour=require("web_tour.tour");

    functionadd_product_to_order(product_name){
        return[{
            content:'buy'+product_name,
            trigger:'.product-list.product-name:contains("'+product_name+'")',
        },{
            content:'the'+product_name+'havebeenaddedtotheorder',
            trigger:'.order.product-name:contains("'+product_name+'")',
            run:function(){},
        }];
    }

    functionset_fiscal_position_on_order(fp_name){
        return[{
            content:'setfiscalposition',
            trigger:'.control-button.o_fiscal_position_button',
        },{
            content:'choosefiscalposition'+fp_name+'toaddtotheorder',
            trigger:'.popups.popup.selection.selection-item:contains("'+fp_name+'")',
        },{
            content:'thefiscalposition'+fp_name+'hasbeensettotheorder',
            trigger:'.control-button.o_fiscal_position_button:contains("'+fp_name+'")',
            run:function(){},
        }];
    }

    functiongenerate_keypad_steps(amount_str,keypad_selector){
        vari,steps=[],current_char;
        for(i=0;i<amount_str.length;++i){
            current_char=amount_str[i];
            steps.push({
                content:'press'+current_char+'onpaymentkeypad',
                trigger:keypad_selector+'.input-button:contains("'+current_char+'"):visible'
            });
        }
        returnsteps;
    }

    functionpress_payment_numpad(val){
        return[{
            content:`press${val}onpaymentscreennumpad`,
            trigger:`.payment-numpad.input-button:contains("${val}"):visible`,
        }]
    }

    functionpress_product_numpad(val){
        return[{
            content:`press${val}onproductscreennumpad`,
            trigger:`.numpad.input-button:contains("${val}"):visible`,
        }]
    }

    functionselected_payment_has(name,val){
        return[{
            content:`selectedpaymentis${name}andhas${val}`,
            trigger:`.paymentlines.paymentline.selected.payment-name:contains("${name}")`,
            extra_trigger:`.paymentlines.paymentline.selected.payment-name:contains("${name}")~.payment-amount:contains("${val}")`,
            run:function(){},
        }]
    }

    functionselected_orderline_has({product,price=null,quantity=null}){
        constresult=[];
        if(price!==null){
            result.push({
                content:`Selectedlinehasproduct'${product}'andprice'${price}'`,
                trigger:`.order-container.orderlines.orderline.selected.product-name:contains("${product}")~span.price:contains("${price}")`,
                run:function(){},
            });
        }
        if(quantity!==null){
            result.push({
                content:`Selectedlinehasproduct'${product}'andquantity'${quantity}'`,
                trigger:`.order-container.orderlines.orderline.selected.product-name:contains('${product}')~.info-list.infoem:contains('${quantity}')`,
                run:function(){},
            });
        }
        returnresult;
    }

    functionverify_order_total(total_str){
        return[{
            content:'ordertotalcontains'+total_str,
            trigger:'.order.total.value:contains("'+total_str+'")',
            run:function(){},//it'sacheck
        }];
    }

    functiongoto_payment_screen_and_select_payment_method(){
        return[{
            content:"gotopaymentscreen",
            trigger:'.button.pay',
        },{
            content:"paywithcash",
            trigger:'.paymentmethod:contains("Cash")',
        }];
    }

    functionfinish_order(){
        return[{
            content:"validatetheorder",
            trigger:'.payment-screen.button.next.highlight:visible',
        },{
            content:"verifythattheorderhasbeensuccessfullysenttothebackend",
            trigger:".js_connected:visible",
            run:function(){},
        },{
            content:"clickNextOrder",
            trigger:'.receipt-screen.button.next.highlight:visible',
        },{
            content:"checkifweleftthereceiptscreen",
            trigger:'.pos-content.screen:not(:has(.receipt-screen))',
            run:function(){},
        }];
    }

    varsteps=[{
            content:'waitingforloadingtofinish',
            trigger:'body:not(:has(.loader))',
            run:function(){},
        },{//Leavecategorydisplayedbydefault
            content:"clickcategoryswitch",
            trigger:".breadcrumb-home",
        }];

    steps=steps.concat(add_product_to_order('DeskOrganizer'));
    steps=steps.concat(verify_order_total('5.10'));

    steps=steps.concat(add_product_to_order('DeskOrganizer'));
    steps=steps.concat(verify_order_total('10.20'));
    steps=steps.concat(goto_payment_screen_and_select_payment_method());

    /* addpaymentlineofonly5.20
        status:
            order-total:=10.20
            total-payment:=11.70
        expect:
            remaining:=0.00
            change:=1.50
    */
    steps=steps.concat(press_payment_numpad('5'));
    steps=steps.concat(selected_payment_has('Cash','5.0'));
    steps=steps.concat([{
        content:"verifyremaining",
        trigger:'.payment-status-remaining.amount:contains("5.20")',
        run:function(){},
    },{
        content:"verifychange",
        trigger:'.payment-status-change.amount:contains("0.00")',
        run:function(){},
    }]);

    /* makeadditionalpaymentlineof6.50
        status:
            order-total:=10.20
            total-payment:=11.70
        expect:
            remaining:=0.00
            change:=1.50
    */
    steps=steps.concat([{
        content:"paywithcash",
        trigger:'.paymentmethod:contains("Cash")',
    }]);
    steps=steps.concat(selected_payment_has('Cash','5.2'));
    steps=steps.concat(press_payment_numpad('6'))
    steps=steps.concat(selected_payment_has('Cash','6.0'));
    steps=steps.concat([{
        content:"verifyremaining",
        trigger:'.payment-status-remaining.amount:contains("0.00")',
        run:function(){},
    },{
        content:"verifychange",
        trigger:'.payment-status-change.amount:contains("0.80")',
        run:function(){},
    }]);

    steps=steps.concat(finish_order());

    //testopw-672118orderlinesubtotalrounding
    steps=steps.concat(add_product_to_order('DeskOrganizer'));
    steps=steps.concat(selected_orderline_has({product:'DeskOrganizer',quantity:'1.0'}));
    steps=steps.concat(press_product_numpad('.'))
    steps=steps.concat(selected_orderline_has({product:'DeskOrganizer',quantity:'0.0',price:'0.0'}));
    steps=steps.concat(press_product_numpad('9'))
    steps=steps.concat(selected_orderline_has({product:'DeskOrganizer',quantity:'0.9',price:'4.59'}));
    steps=steps.concat(press_product_numpad('9'))
    steps=steps.concat(selected_orderline_has({product:'DeskOrganizer',quantity:'0.99',price:'5.05'}));
    steps=steps.concat(goto_payment_screen_and_select_payment_method());
    steps=steps.concat(selected_payment_has('Cash','5.05'));
    steps=steps.concat(finish_order());

    //Testfiscalpositionone2manymap(alignwithbackend)
    steps=steps.concat(add_product_to_order('LetterTray'));
    steps=steps.concat(selected_orderline_has({product:'LetterTray',quantity:'1.0'}));
    steps=steps.concat(verify_order_total('5.28'));
    steps=steps.concat(set_fiscal_position_on_order('FP-POS-2M'));
    steps=steps.concat(verify_order_total('5.52'));

    steps=steps.concat([{
        content:"closethePointofSalefrontend",
        trigger:".header-button",
    },{
        content:"confirmclosingthefrontend",
        trigger:".header-button.confirm",
        run:function(){},//it'sacheck,
    }]);

    Tour.register('pos_basic_order',{test:true,url:'/pos/ui'},steps);

});
