flectra.define('sale_product_matrix.product_configurator',function(require){
varProductConfiguratorWidget=require('sale_product_configurator.product_configurator');

/**
 *ExtensionoftheProductConfiguratorWidgettosupportproductconfiguration
 *asvariantbatchestoaddtotheSO..
 *Itopenswhenaconfigurableproduct_templateisset
 *(multiplevariants,orcustomattributes)
 *anditsconfigurationmodeismatrix.
 *
 */
ProductConfiguratorWidget.include({

    /**
     *@override
     */
     _openConfigurator:function(result,productTemplateId,dataPointId){
        varself=this;
        varmode=result.mode;
        this._super.apply(this,arguments).then(function(configuratorOpened){
            if(!configuratorOpened&&mode==='matrix'){
                self._openGridConfigurator(productTemplateId,dataPointId);
                returnPromise.resolve(true);
            }
            returnPromise.resolve(configuratorOpened);
        });
    },

    _openGridConfigurator:function(productTemplateId,dataPointId,edit){
        varattribs=edit?this._getPTAVS():[];
        this.trigger_up('open_matrix',{
            product_template_id:productTemplateId,
            model:'sale.order',
            dataPointId:dataPointId,
            edit:edit,
            editedCellAttributes:attribs,
        });
    },

    _onEditProductConfiguration:function(){
        if(!this.recordData.is_configurable_product){
            //iflineshouldbeeditedbyanotherconfigurator
            //orsimplyinline.
            this._super.apply(this,arguments);
            return;
        }
        varself=this;
        varproductTemplateId=this.recordData.product_template_id.data.id;
        this._rpc({
            model:'product.template',
            method:'read',
            args:[productTemplateId,['product_add_mode']],
        }).then(function(result){
            if(result&&result[0].product_add_mode==='matrix'){
                self._openGridConfigurator(productTemplateId,self.dataPointID,true);
            }else{
                self.restoreProductTemplateId=self.recordData.product_template_id;
                //Callsuperonlyifproduct_add_modedifferentthanmatrix
                //toavoidproductconfiguratoropening(whichisthedefaultcase).
                self._openProductConfigurator({
                        configuratorMode:'edit',
                        default_product_template_id:self.recordData.product_template_id.data.id,
                        default_pricelist_id:self._getPricelistId(),
                        default_product_template_attribute_value_ids:self._convertFromMany2Many(
                            self.recordData.product_template_attribute_value_ids
                        ),
                        default_product_no_variant_attribute_value_ids:self._convertFromMany2Many(
                            self.recordData.product_no_variant_attribute_value_ids
                        ),
                        default_product_custom_attribute_value_ids:self._convertFromOne2Many(
                            self.recordData.product_custom_attribute_value_ids
                        ),
                        default_quantity:self.recordData.product_uom_qty
                    },
                    self.dataPointID
                );
            }
        });
    },

    /**
     *Returnsthelistofattributeids(product.template.attribute.value)
     *fromthecurrentSOLine.
    */
    _getPTAVS:function(){
        varPTAVSIDS=[];
        _.each(this.recordData.product_no_variant_attribute_value_ids.res_ids,function(id){
            PTAVSIDS.push(id);
        });
        _.each(this.recordData.product_template_attribute_value_ids.res_ids,function(id){
            PTAVSIDS.push(id);
        });
        returnPTAVSIDS.sort(function(a,b){returna-b;});
    }

});

});
